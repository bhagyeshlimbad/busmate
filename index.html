<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BusMate – Clickable Prototype</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #99a3b3;
      --text: #e8eefc;
      --accent: #5b8cff;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    header { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; background: #0e1729; border-bottom: 1px solid #1f2a44; position: sticky; top: 0; z-index: 5; }
    header .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: .3px; }
    header img.logo { width: 34px; height: 34px; border-radius: 8px; background: #1d2a47; padding: 6px; }
    header .user { font-size: 14px; color: var(--muted); }

    main { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100dvh - 60px); }
    nav { background: #0f1830; border-right: 1px solid #1f2a44; padding: 16px; }
    nav .section-title { font-size: 12px; color: var(--muted); margin: 18px 10px 8px; text-transform: uppercase; letter-spacing: .1em; }
    .menu { display: grid; gap: 8px; }
    .menu button { text-align: left; width: 100%; border: 1px solid #1f2a44; background: var(--card); color: var(--text); padding: 10px 12px; border-radius: 12px; cursor: pointer; }
    .menu button.active { outline: 2px solid var(--accent); }
    .menu button:hover { background: #16223a; }

    .view { display: none; padding: 18px; background: radial-gradient(1200px 400px at 60% -10%, #152345 0, #0b1220 50%); }
    .view.active { display: block; }

    .card { background: var(--card); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 14px; }
    .grid { display: grid; gap: 14px; }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 960px){ main { grid-template-columns: 1fr; } nav { position: sticky; top: 60px; z-index: 4; } .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr; } }

    label { font-size: 12px; color: var(--muted); display:block; margin: 8px 2px 6px; }
    input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #243357; background: #0e1629; color: var(--text); outline: none; }
    textarea { min-height: 80px; resize: vertical; }

    .btn-row { display: flex; flex-wrap: wrap; gap: 10px; }
    .btn { border: none; border-radius: 12px; padding: 10px 14px; background: var(--accent); color: white; cursor: pointer; }
    .btn.secondary { background: #1f2a44; color: var(--text); }
    .btn.success { background: var(--accent-2); }
    .btn.danger { background: var(--danger); }
    .btn.warn { background: var(--warn); color: #1f2937; }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid #223052; }
    th { color: var(--muted); font-weight: 600; }

    .watermark { position: absolute; inset: 0; display: grid; place-items: center; opacity: .06; font-size: 120px; font-weight: 900; pointer-events: none; user-select: none; }

    .pill { font-size: 12px; padding: 4px 10px; background:#1c2949; border:1px solid #243357; border-radius: 999px; color: var(--muted); }

    .inline { display:flex; gap:10px; align-items:center; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img class="logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96' viewBox='0 0 24 24' fill='none' stroke='%235b8cff' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='7' width='18' height='10' rx='2'/%3E%3Cpath d='M7 7v-.5A2.5 2.5 0 0 1 9.5 4h5A2.5 2.5 0 0 1 17 6.5V7'/%3E%3Ccircle cx='7' cy='17' r='1.25'/%3E%3Ccircle cx='17' cy='17' r='1.25'/%3E%3C/svg%3E" alt="BusMate" />
      <span>BusMate</span>
    </div>
    <div class="user"><span id="headerCompany">—</span> • <span id="headerUser">Guest</span></div>
  </header>

  <main>
    <nav>
      <div class="section-title">Navigation</div>
      <div class="menu">
        <button id="nav-login" onclick="route('login')">Login</button>
        <button id="nav-home" onclick="route('home')">Home</button>
        <button id="nav-start" onclick="route('start')">Start Trip</button>
        <button id="nav-locations" onclick="route('locations')">Locations</button>
        <button id="nav-trips" onclick="route('trips')">Trip Setup</button>
        <button id="nav-company" onclick="route('company')">Company Information</button>
        <button id="nav-reports" onclick="route('reports')">Reports</button>
      </div>
      <div class="section-title">Admin</div>
      <div class="menu">
        <button id="nav-admin" onclick="route('admin')">Admin Panel</button>
      </div>
    </nav>

    <section style="position:relative;">
      <div class="watermark" id="homeWatermark">BUSMATE</div>

      <!-- LOGIN VIEW -->
      <div id="view-login" class="view active">
        <div class="grid cols-2">
          <div class="card">
            <h2>Login</h2>
            <label>Username / Email</label>
            <input id="login-username" placeholder="e.g. ops@aarya.com" />
            <label>Password</label>
            <input id="login-password" type="password" placeholder="••••••••" />
            <div class="inline"><input id="login-is-admin" type="checkbox" /> <label>Login as Admin</label></div>
            <div class="btn-row">
              <button class="btn" onclick="doLogin()">Login</button>
              <button class="btn secondary" onclick="quickDemo()">Quick Demo Login</button>
            </div>
          </div>
          <div class="card">
            <h2>About BusMate</h2>
            <p>Web-based announcement system for bus operators with multi-language TTS, location radius alerts, and trip management. 100% front-end prototype using LocalStorage.</p>
            <p class="pill">Zero-cost • Mobile-first • Chrome-ready</p>
          </div>
        </div>
      </div>

      <!-- HOME VIEW -->
      <div id="view-home" class="view">
        <div class="grid cols-3">
          <div class="card">
            <h3>Start Trip</h3>
            <p>Run a saved trip and make live announcements.</p>
            <button class="btn" onclick="route('start')">Open</button>
          </div>
          <div class="card">
            <h3>Locations</h3>
            <p>Manage geofenced stops with radii and messages.</p>
            <button class="btn" onclick="route('locations')">Open</button>
          </div>
          <div class="card">
            <h3>Trip Setup</h3>
            <p>Create routes by selecting multiple locations.</p>
            <button class="btn" onclick="route('trips')">Open</button>
          </div>
          <div class="card">
            <h3>Company Information</h3>
            <p>Edit company name, logo, and users.</p>
            <button class="btn" onclick="route('company')">Open</button>
          </div>
          <div class="card">
            <h3>Reports</h3>
            <p>Trip durations, stops reached, exports.</p>
            <button class="btn" onclick="route('reports')">Open</button>
          </div>
        </div>
      </div>

      <!-- COMPANY VIEW -->
      <div id="view-company" class="view">
        <div class="grid cols-2">
          <div class="card">
            <h3>Company Profile</h3>
            <label>Company Name</label>
            <input id="company-name" placeholder="e.g., Aarya Security Services" />
            <label>Company Logo (data URL)</label>
            <input id="company-logo" placeholder="Paste image data URL or keep empty" />
            <div class="btn-row"><button class="btn" onclick="saveCompany()">Save</button></div>
          </div>
          <div class="card">
            <h3>Registered Users</h3>
            <div class="btn-row">
              <input id="new-user" placeholder="username or email" />
              <button class="btn" onclick="addCompanyUser()">Add User</button>
            </div>
            <table>
              <thead><tr><th>User</th><th>Actions</th></tr></thead>
              <tbody id="company-users"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- LOCATIONS VIEW -->
      <div id="view-locations" class="view">
        <div class="grid cols-2">
          <div class="card">
            <h3>Add / Edit Location</h3>
            <input id="loc-id" type="hidden" />
            <label>Location Name</label>
            <input id="loc-name" placeholder="e.g., Rajkot" />
            <label>Longitude / Latitude</label>
            <div class="grid cols-2">
              <input id="loc-lon" type="number" step="any" placeholder="70.8022" />
              <input id="loc-lat" type="number" step="any" placeholder="22.3039" />
            </div>
            <div class="btn-row">
              <button class="btn secondary" onclick="useCurrentGPS()">Use Current GPS</button>
            </div>
            <label>Set Radius</label>
            <select id="loc-radius">
              <option value="100">100 m</option>
              <option value="200">200 m</option>
              <option value="500" selected>500 m</option>
              <option value="1000">1 km</option>
            </select>
            <label>Announcement Message (optional)</label>
            <textarea id="loc-msg" placeholder="Welcome to Rajkot."></textarea>
            <div class="btn-row">
              <button class="btn" onclick="saveLocation()">Save Location</button>
              <button class="btn danger" onclick="clearLocationForm()">Clear</button>
            </div>
          </div>
          <div class="card">
            <h3>Locations</h3>
            <table>
              <thead><tr><th>Name</th><th>Radius</th><th>Lon,Lat</th><th></th></tr></thead>
              <tbody id="loc-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TRIPS VIEW -->
      <div id="view-trips" class="view">
        <div class="grid cols-2">
          <div class="card">
            <h3>Create Trip</h3>
            <label>Trip Name</label>
            <input id="trip-name" placeholder="Porbandar – Junagadh Express" />
            <label>Locations (multi-select)</label>
            <select id="trip-locations" multiple size="8"></select>
            <div class="btn-row">
              <button class="btn" onclick="saveTrip()">Save Trip</button>
              <button class="btn secondary" onclick="document.getElementById('trip-name').value='';">Clear</button>
            </div>
          </div>
          <div class="card">
            <h3>Saved Trips</h3>
            <table>
              <thead><tr><th>Name</th><th>Stops</th><th></th></tr></thead>
              <tbody id="trip-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- START TRIP VIEW -->
      <div id="view-start" class="view">
        <div class="grid cols-2">
          <div class="card">
            <h3>Trips</h3>
            <table>
              <thead><tr><th>Name</th><th>Stops</th><th></th></tr></thead>
              <tbody id="start-trip-table"></tbody>
            </table>
          </div>
          <div class="card" id="run-panel" style="display:none;">
            <h3 id="run-trip-title">Running: —</h3>
            <div class="grid cols-2">
              <div class="card">
                <div class="inline"><strong>Live Location</strong><span id="gps-pill" class="pill">GPS idle</span></div>
                <div>Lat: <span id="live-lat">—</span> | Lon: <span id="live-lon">—</span></div>
                <div class="btn-row" style="margin-top:8px;">
                  <button class="btn secondary" onclick="startGPS()">Start GPS</button>
                  <button class="btn secondary" onclick="stopGPS()">Stop GPS</button>
                </div>
              </div>
              <div class="card">
                <strong>Audio</strong>
                <label>Volume</label>
                <input id="volume" type="range" min="0" max="1" step="0.05" value="1" oninput="ttsVolume=this.value" />
                <div class="btn-row"><button class="btn" onclick="speak('Test sound from BusMate')">Test Sound</button></div>
              </div>
            </div>
            <div class="grid cols-2" style="margin-top:12px;">
              <div class="card">
                <strong>Upcoming Station</strong>
                <div id="upcoming">—</div>
                <div class="btn-row" style="margin-top:8px;">
                  <button class="btn" onclick="announceNext()">Announce Next</button>
                  <button class="btn success" onclick="markReached()">Mark Reached</button>
                </div>
              </div>
              <div class="card">
                <strong>Controls</strong>
                <div class="inline"><input id="auto-toggle" type="checkbox" checked /> <label>Automatic (radius-based)</label></div>
                <div>Countdown: <span id="countdown">—</span></div>
                <div class="btn-row" style="margin-top:8px;">
                  <button class="btn warn" onclick="endTrip()">End Trip</button>
                </div>
              </div>
            </div>
            <div class="card" style="margin-top:12px;">
              <strong>Stops</strong>
              <table>
                <thead><tr><th>#</th><th>Name</th><th>Radius</th><th>Status</th><th>Arrived</th></tr></thead>
                <tbody id="run-stops"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- REPORTS VIEW -->
      <div id="view-reports" class="view">
        <div class="card">
          <h3>Trip Reports</h3>
          <table>
            <thead><tr><th>Trip</th><th>Start</th><th>End</th><th>Duration</th><th>Stops Reached</th></tr></thead>
            <tbody id="reports-table"></tbody>
          </table>
          <div class="btn-row" style="margin-top:10px;">
            <button class="btn secondary" onclick="exportJSON('reports')">Export JSON</button>
          </div>
        </div>
      </div>

      <!-- ADMIN VIEW -->
      <div id="view-admin" class="view">
        <div class="grid cols-2">
          <div class="card">
            <h3>Login Analytics</h3>
            <table>
              <thead><tr><th>User</th><th>Logins</th><th>Last Device</th></tr></thead>
              <tbody id="admin-logins"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>Company Management</h3>
            <label>New Company Name</label>
            <input id="admin-company-name" placeholder="Company Ltd." />
            <div class="btn-row"><button class="btn" onclick="adminCreateCompany()">Create Company</button></div>
            <hr style="border:none;border-top:1px solid #223052; margin:16px 0;" />
            <label>Add User to Company</label>
            <div class="grid cols-2">
              <input id="admin-user-name" placeholder="user@email" />
              <input id="admin-user-company" placeholder="Company name" />
            </div>
            <div class="btn-row"><button class="btn" onclick="adminAddUserToCompany()">Add User</button></div>
          </div>
        </div>
      </div>

    </section>
  </main>

  <script>
    // --------- Simple SPA Router ---------
    const views = ['login','home','company','locations','trips','start','reports','admin'];
    function route(name){
      views.forEach(v=>{
        document.getElementById('view-'+v).classList.remove('active');
        document.getElementById('nav-'+v)?.classList.remove('active');
      });
      document.getElementById('view-'+name).classList.add('active');
      document.getElementById('nav-'+name)?.classList.add('active');
      if(name==='home'){ renderHome(); }
      if(name==='company'){ renderCompany(); }
      if(name==='locations'){ renderLocations(); }
      if(name==='trips'){ renderTrips(); }
      if(name==='start'){ renderStart(); }
      if(name==='reports'){ renderReports(); }
      if(name==='admin'){ renderAdmin(); }
    }

    // --------- Storage Helpers ---------
    const LS = {
      get: (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d)),
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
      push: (k, v) => { const a = LS.get(k, []); a.push(v); LS.set(k, a); }
    };

    // --------- App State ---------
    let state = {
      user: null, // {name, admin, company}
      company: { name: 'Demo Company', logo: '', users: ['demo@busmate'] },
      locations: [],
      trips: [],
      running: null, // {tripId, startedAt, idx, reached:[{i, t}]}
    };

    // Load persisted company/locations/trips
    function loadState(){
      state.company = LS.get('bm_company', state.company);
      state.locations = LS.get('bm_locations', state.locations);
      state.trips = LS.get('bm_trips', state.trips);
    }
    loadState();

    // --------- Login ---------
    function deviceInfo(){ return navigator.userAgent; }

    function doLogin(){
      const name = document.getElementById('login-username').value?.trim() || 'demo@busmate';
      const admin = document.getElementById('login-is-admin').checked;
      state.user = { name, admin, company: state.company.name };
      LS.set('bm_user', state.user);
      // login logs
      const logs = LS.get('bm_logins', {});
      logs[name] = logs[name] || { count: 0, device: '' };
      logs[name].count += 1;
      logs[name].device = deviceInfo();
      LS.set('bm_logins', logs);
      updateHeader();
      route('home');
    }

    function quickDemo(){
      document.getElementById('login-username').value = 'admin@busmate';
      document.getElementById('login-is-admin').checked = true;
      doLogin();
    }

    function updateHeader(){
      document.getElementById('headerUser').textContent = state.user? state.user.name : 'Guest';
      document.getElementById('headerCompany').textContent = state.company?.name || '—';
    }
    updateHeader();

    // --------- HOME ---------
    function renderHome(){
      // header + watermark logo text
      document.getElementById('homeWatermark').textContent = (state.company.logo? '' : (state.company.name||'BUSMATE')).toUpperCase();
    }

    // --------- COMPANY ---------
    function renderCompany(){
      document.getElementById('company-name').value = state.company.name || '';
      document.getElementById('company-logo').value = state.company.logo || '';
      const tbody = document.getElementById('company-users');
      tbody.innerHTML = '';
      (state.company.users||[]).forEach((u, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u}</td><td><button class='btn danger' onclick='removeCompanyUser(${idx})'>Remove</button></td>`;
        tbody.appendChild(tr);
      });
    }
    function saveCompany(){
      state.company.name = document.getElementById('company-name').value.trim() || 'Company';
      state.company.logo = document.getElementById('company-logo').value.trim();
      LS.set('bm_company', state.company);
      updateHeader();
      alert('Company saved');
    }
    function addCompanyUser(){
      const u = document.getElementById('new-user').value.trim();
      if(!u) return;
      state.company.users = state.company.users || [];
      state.company.users.push(u);
      LS.set('bm_company', state.company);
      document.getElementById('new-user').value='';
      renderCompany();
    }
    function removeCompanyUser(idx){
      state.company.users.splice(idx,1);
      LS.set('bm_company', state.company);
      renderCompany();
    }

    // --------- LOCATIONS ---------
    function clearLocationForm(){
      document.getElementById('loc-id').value='';
      document.getElementById('loc-name').value='';
      document.getElementById('loc-lon').value='';
      document.getElementById('loc-lat').value='';
      document.getElementById('loc-radius').value='500';
      document.getElementById('loc-msg').value='';
    }
    function useCurrentGPS(){
      if(!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos=>{
        document.getElementById('loc-lat').value = pos.coords.latitude.toFixed(6);
        document.getElementById('loc-lon').value = pos.coords.longitude.toFixed(6);
      }, err=> alert('GPS error: '+err.message));
    }
    function saveLocation(){
      const id = document.getElementById('loc-id').value;
      const obj = {
        id: id || crypto.randomUUID(),
        name: document.getElementById('loc-name').value.trim(),
        lon: parseFloat(document.getElementById('loc-lon').value),
        lat: parseFloat(document.getElementById('loc-lat').value),
        radius: parseInt(document.getElementById('loc-radius').value),
        msg: document.getElementById('loc-msg').value.trim(),
      };
      if(!obj.name || isNaN(obj.lon) || isNaN(obj.lat)) return alert('Please fill name and coordinates');
      const idx = state.locations.findIndex(x=>x.id===obj.id);
      if(idx>=0) state.locations[idx]=obj; else state.locations.push(obj);
      LS.set('bm_locations', state.locations);
      clearLocationForm();
      renderLocations();
    }
    function editLocation(id){
      const loc = state.locations.find(l=>l.id===id);
      if(!loc) return;
      document.getElementById('loc-id').value = loc.id;
      document.getElementById('loc-name').value = loc.name;
      document.getElementById('loc-lon').value = loc.lon;
      document.getElementById('loc-lat').value = loc.lat;
      document.getElementById('loc-radius').value = String(loc.radius);
      document.getElementById('loc-msg').value = loc.msg || '';
      window.scrollTo({top:0, behavior:'smooth'});
    }
    function deleteLocation(id){
      if(!confirm('Delete this location?')) return;
      state.locations = state.locations.filter(l=>l.id!==id);
      LS.set('bm_locations', state.locations);
      renderLocations();
    }
    function renderLocations(){
      const tbody = document.getElementById('loc-table');
      tbody.innerHTML = '';
      state.locations.forEach(loc=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${loc.name}</td><td>${loc.radius} m</td><td>${loc.lon.toFixed(5)}, ${loc.lat.toFixed(5)}</td>
        <td><div class='btn-row'><button class='btn secondary' onclick='editLocation("${loc.id}")'>Edit</button><button class='btn danger' onclick='deleteLocation("${loc.id}")'>Delete</button></div></td>`;
        tbody.appendChild(tr);
      });
      // refresh trip multiselect
      const sel = document.getElementById('trip-locations');
      if(sel){ sel.innerHTML=''; state.locations.forEach(loc=>{ const opt=document.createElement('option'); opt.value=loc.id; opt.textContent=loc.name; sel.appendChild(opt); }); }
    }

    // --------- TRIPS ---------
    function saveTrip(){
      const name = document.getElementById('trip-name').value.trim();
      if(!name) return alert('Enter trip name');
      const sel = Array.from(document.getElementById('trip-locations').selectedOptions).map(o=>o.value);
      if(sel.length===0) return alert('Select at least one location');
      const trip = { id: crypto.randomUUID(), name, locIds: sel };
      state.trips.push(trip);
      LS.set('bm_trips', state.trips);
      document.getElementById('trip-name').value='';
      renderTrips();
    }
    function deleteTrip(id){
      if(!confirm('Delete this trip?')) return;
      state.trips = state.trips.filter(t=>t.id!==id);
      LS.set('bm_trips', state.trips);
      renderTrips();
    }
    function renderTrips(){
      renderLocations(); // ensure options up to date
      const tbody = document.getElementById('trip-table');
      tbody.innerHTML='';
      state.trips.forEach(trip=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${trip.name}</td><td>${trip.locIds.length}</td><td><div class='btn-row'><button class='btn danger' onclick='deleteTrip("${trip.id}")'>Delete</button></div></td>`;
        tbody.appendChild(tr);
      });
    }

    // --------- START TRIP / RUNNER ---------
    let gpsWatch = null; let ttsVolume = 1;
    function distanceMeters(a,b){
      const toRad = d=> d*Math.PI/180; const R=6371000;
      const dLat = toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }

    function renderStart(){
      // list trips
      const tbody = document.getElementById('start-trip-table');
      tbody.innerHTML='';
      state.trips.forEach(trip=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${trip.name}</td><td>${trip.locIds.length}</td><td><button class='btn' onclick='startTripRun("${trip.id}")'>Start</button></td>`;
        tbody.appendChild(tr);
      });
      updateRunnerUI();
    }

    function startTripRun(id){
      const trip = state.trips.find(t=>t.id===id);
      if(!trip) return;
      state.running = { tripId: id, startedAt: Date.now(), idx: 0, reached: [] };
      LS.set('bm_running', state.running);
      document.getElementById('run-panel').style.display='block';
      document.getElementById('run-trip-title').textContent = 'Running: '+trip.name;
      const tbody = document.getElementById('run-stops');
      tbody.innerHTML='';
      trip.locIds.map(id=> state.locations.find(l=>l.id===id)).forEach((loc, i)=>{
        const tr = document.createElement('tr');
        tr.id = 'run-row-'+i;
        tr.innerHTML = `<td>${i+1}</td><td>${loc?.name||'?'}</td><td>${loc?.radius||0} m</td><td id='status-${i}'>Pending</td><td id='arr-${i}'>—</td>`;
        tbody.appendChild(tr);
      });
      updateUpcoming();
    }

    function startGPS(){
      if(!navigator.geolocation) return alert('Geolocation not supported');
      if(gpsWatch) return;
      document.getElementById('gps-pill').textContent = 'GPS watching…';
      gpsWatch = navigator.geolocation.watchPosition(pos=>{
        document.getElementById('live-lat').textContent = pos.coords.latitude.toFixed(6);
        document.getElementById('live-lon').textContent = pos.coords.longitude.toFixed(6);
        autoCheckRadius({lat: pos.coords.latitude, lon: pos.coords.longitude});
      }, err=>{ document.getElementById('gps-pill').textContent = 'GPS error'; console.log(err); }, { enableHighAccuracy: true });
    }
    function stopGPS(){ if(gpsWatch){ navigator.geolocation.clearWatch(gpsWatch); gpsWatch=null; document.getElementById('gps-pill').textContent = 'GPS stopped'; } }

    function updateUpcoming(){
      const trip = state.trips.find(t=>t.id===state.running?.tripId);
      if(!trip) return;
      const idx = state.running.idx;
      const loc = state.locations.find(l=>l.id===trip.locIds[idx]);
      document.getElementById('upcoming').textContent = loc? `${loc.name} (radius ${loc.radius}m)` : '—';
    }

    function announceNext(){
      const trip = state.trips.find(t=>t.id===state.running?.tripId);
      if(!trip) return;
      const idx = state.running.idx;
      const loc = state.locations.find(l=>l.id===trip.locIds[idx]);
      if(!loc) return;
      speak(`Next stop: ${loc.name}. ${loc.msg||''}`);
    }
    function markReached(){
      const trip = state.trips.find(t=>t.id===state.running?.tripId);
      if(!trip) return;
      const idx = state.running.idx;
      const loc = state.locations.find(l=>l.id===trip.locIds[idx]);
      if(!loc) return;
      speak(`Arrived at ${loc.name}. ${loc.msg||''}`);
      document.getElementById('status-'+idx).textContent = 'Reached';
      document.getElementById('arr-'+idx).textContent = new Date().toLocaleTimeString();
      state.running.reached.push({ i: idx, t: Date.now() });
      state.running.idx++;
      LS.set('bm_running', state.running);
      updateUpcoming();
    }

    function autoCheckRadius(current){
      if(!document.getElementById('auto-toggle').checked) return;
      const trip = state.trips.find(t=>t.id===state.running?.tripId);
      if(!trip) return;
      const idx = state.running.idx; if(idx==null) return;
      const loc = state.locations.find(l=>l.id===trip.locIds[idx]);
      if(!loc) return;
      const d = distanceMeters(current, {lat: loc.lat, lon: loc.lon});
      document.getElementById('countdown').textContent = `${Math.max(0, Math.round(d))} m`;
      if(d <= Math.max(250, loc.radius)) {
        // Pre announcement
        if(!state.running.preAnnounced){ speak(`Next stop: ${loc.name}`); state.running.preAnnounced = true; }
      }
      if(d <= Math.min(loc.radius, 120)) { // arrival
        state.running.preAnnounced = false;
        markReached();
      }
    }

    function endTrip(){
      if(!state.running) return;
      const trip = state.trips.find(t=>t.id===state.running.tripId);
      const start = state.running.startedAt; const end = Date.now();
      const report = {
        trip: trip?.name||'Unknown',
        start, end,
        durationMs: end-start,
        stopsReached: (state.running.reached||[]).length
      };
      const reports = LS.get('bm_reports', []);
      reports.push(report); LS.set('bm_reports', reports);
      state.running = null; LS.set('bm_running', state.running);
      document.getElementById('run-panel').style.display='none';
      alert('Trip ended & recorded');
      route('reports');
    }

    // --------- REPORTS ---------
    function renderReports(){
      const tbody = document.getElementById('reports-table');
      tbody.innerHTML='';
      const reports = LS.get('bm_reports', []);
      reports.forEach(r=>{
        const tr = document.createElement('tr');
        const durMin = Math.round(r.durationMs/60000);
        tr.innerHTML = `<td>${r.trip}</td><td>${new Date(r.start).toLocaleString()}</td><td>${new Date(r.end).toLocaleString()}</td><td>${durMin} min</td><td>${r.stopsReached}</td>`;
        tbody.appendChild(tr);
      });
    }
    function exportJSON(key){
      const data = LS.get('bm_'+key, []);
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = key+".json"; a.click();
    }

    // --------- ADMIN ---------
    function renderAdmin(){
      if(!state.user?.admin){
        document.getElementById('admin-logins').innerHTML = `<tr><td colspan='3'>Admin only</td></tr>`;
        return;
      }
      const logs = LS.get('bm_logins', {});
      const tbody = document.getElementById('admin-logins');
      tbody.innerHTML='';
      Object.entries(logs).forEach(([u,info])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u}</td><td>${info.count}</td><td style='max-width:420px; overflow:hidden; text-overflow:ellipsis;'>${info.device}</td>`;
        tbody.appendChild(tr);
      });
    }
    function adminCreateCompany(){
      if(!state.user?.admin) return alert('Admin only');
      const name = document.getElementById('admin-company-name').value.trim();
      if(!name) return alert('Enter company name');
      state.company = { name, logo:'', users:[] };
      LS.set('bm_company', state.company);
      updateHeader();
      alert('Company created');
    }
    function adminAddUserToCompany(){
      if(!state.user?.admin) return alert('Admin only');
      const user = document.getElementById('admin-user-name').value.trim();
      const comp = document.getElementById('admin-user-company').value.trim();
      if(!user || !comp) return alert('Fill user and company');
      if(state.company.name !== comp) return alert('Active company mismatch');
      state.company.users = state.company.users || [];
      if(!state.company.users.includes(user)) state.company.users.push(user);
      LS.set('bm_company', state.company);
      renderCompany();
      alert('User added');
    }

    // --------- TTS ---------
    function speak(text){
      try{
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-IN'; // demo; can be extended to multi-lang UI
        utter.volume = Number(ttsVolume||1);
        speechSynthesis.speak(utter);
      }catch(e){ console.log('TTS unavailable', e); }
    }

    // Init
    const savedUser = LS.get('bm_user', null); if(savedUser){ state.user = savedUser; updateHeader(); route('home'); }
    renderLocations(); renderTrips();
  </script>
</body>
</html>
