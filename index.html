<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BusMate — Full Prototype (Fixed Ongoing Trip)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- SheetJS for export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .mapbox{ width:100%; height:56vh; min-height:280px; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(2,6,23,0.06); }
    @media (min-width:1024px){ .mapbox{ height:48vh; } }
    .list-row{ background:#fff; border-radius:10px; padding:.75rem; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .chip{ background:#eef2ff;color:#3730a3;padding:.2rem .5rem;border-radius:999px;font-size:.75rem; }
    .small-muted{ color:#64748b; font-size:.9rem; }
    .hidden{ display:none!important; }
    .page-back{ margin-bottom:.75rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

<!-- HEADER -->
<header class="bg-blue-600 text-white sticky top-0 z-40">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div id="logoBox" class="w-10 h-10 bg-white rounded-md flex items-center justify-center text-blue-600 font-bold">BM</div>
      <div>
        <div id="companyTitle" class="font-semibold">BusMate</div>
        <div id="companySub" class="text-xs opacity-90">Vehicle Tracking Prototype</div>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div id="roleLabel" class="text-sm"></div>
      <div class="text-sm">Welcome <span id="userLabel">Guest</span></div>
      <button id="logoutBtn" class="hidden bg-white text-blue-600 px-3 py-1 rounded" onclick="logout()">Logout</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 space-y-6">

  <!-- LOGIN -->
  <section id="pageLogin">
    <div class="max-w-md mx-auto bg-white rounded-xl shadow p-6">
      <div class="text-center">
        <div class="w-14 h-14 rounded-xl bg-blue-600 mx-auto mb-2"></div>
        <h2 class="text-2xl font-bold">BusMate</h2>
        <p class="text-sm text-slate-500 mt-1">Sign in — Master / Admin / Operator</p>
      </div>

      <div class="mt-6 space-y-3">
        <label class="block text-sm">Username</label>
        <input id="loginUser" class="w-full rounded-lg border px-3 py-2" placeholder="bhagyesh / admin / operator" />
        <label class="block text-sm">Password</label>
        <input id="loginPass" type="password" class="w-full rounded-lg border px-3 py-2" placeholder="password" />
        <div class="flex gap-2 mt-4">
          <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" onclick="handleLogin()">Login</button>
          <button class="bg-slate-100 px-4 py-2 rounded hover:bg-slate-200" onclick="showHelp()">Help</button>
        </div>
        <div class="text-xs text-slate-400 mt-3">Managed by: <a href="mailto:bhagyeshlimbad@gmail.com" class="underline">bhagyeshlimbad@gmail.com</a></div>
      </div>
    </div>
  </section>

  <!-- HOME / DASHBOARD -->
  <section id="pageHome" class="hidden">
    <div class="grid gap-4">
      <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between">
        <div>
          <div id="homeCompanyTitle" class="text-lg font-semibold"></div>
          <div id="homeCompanySub" class="text-sm text-slate-500">Dashboard</div>
        </div>
        <div class="text-right">
          <div id="homeUserLabel" class="font-medium"></div>
          <div id="homeRole" class="text-xs text-slate-200"></div>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <button id="tileCompanies" class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" onclick="go('pageMasterAdmin')">
          <div class="font-semibold">Company Management</div>
          <div class="text-sm text-slate-500">Create / Enable / Disable</div>
        </button>

        <button id="tileUsers" class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" onclick="go('pageUsers')">
          <div class="font-semibold">Manage Users</div>
          <div class="text-sm text-slate-500">Create / Edit / Assign</div>
        </button>

        <button id="tileLocations" class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" onclick="go('pageLocations')">
          <div class="font-semibold">Manage Locations</div>
          <div class="text-sm text-slate-500">Stops / Radius / Msg</div>
        </button>

        <button id="tileTrips" class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" onclick="go('pageTripSetup')">
          <div class="font-semibold">Manage Trips</div>
          <div class="text-sm text-slate-500">Create / Order / Save</div>
        </button>

        <button id="tileStart" class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" onclick="go('pageStartTrip')">
          <div class="font-semibold">Start Trip</div>
          <div class="text-sm text-slate-500">Start & Track</div>
        </button>

        <button id="tileReports" class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" onclick="go('pageReports')">
          <div class="font-semibold">Reports</div>
          <div class="text-sm text-slate-500">Trip history & logs</div>
        </button>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div><div class="text-sm text-slate-500">Locations</div><div id="statLocations" class="font-semibold">0</div></div>
          <div><div class="text-sm text-slate-500">Trips</div><div id="statTrips" class="font-semibold">0</div></div>
          <div><div class="text-sm text-slate-500">Companies</div><div id="statCompanies" class="font-semibold">0</div></div>
          <div><div class="text-sm text-slate-500">Runs</div><div id="statRuns" class="font-semibold">0</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- MASTER ADMIN -->
  <section id="pageMasterAdmin" class="hidden">
    <div class="bg-white rounded-xl shadow p-4">
      <div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">← Back</button></div>
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Master Admin — Companies</h2>
        <div>
          <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="openCompanyForm()">Create Company</button>
        </div>
      </div>
      <div class="mt-4"><ul id="companyList" class="space-y-3"></ul></div>
    </div>

    <div id="companyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div class="bg-white p-4 rounded-xl w-96">
        <h3 class="font-semibold">Create / Edit Company</h3>
        <label class="block mt-2 text-sm">Company Name</label>
        <input id="companyNameInp" class="w-full border rounded px-3 py-2" />
        <label class="block mt-2 text-sm">Logo URL (optional)</label>
        <input id="companyLogoInp" class="w-full border rounded px-3 py-2" />
        <div class="flex gap-2 mt-3">
          <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="saveCompany()">Save</button>
          <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="closeCompanyModal()">Cancel</button>
        </div>
      </div>
    </div>
  </section>

  <!-- USERS -->
  <section id="pageUsers" class="hidden">
    <div class="bg-white rounded-xl shadow p-4">
      <div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">← Back</button></div>
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Users</h2>
        <div><button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="openUserForm()">Add User</button></div>
      </div>
      <div class="mt-4"><ul id="usersList" class="space-y-3"></ul></div>
    </div>

    <div id="userModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div class="bg-white p-4 rounded-xl w-96">
        <h3 class="font-semibold">Add / Edit User</h3>
        <label class="block mt-2 text-sm">Username</label>
        <input id="userNameInp" class="w-full border rounded px-3 py-2" />
        <label class="block mt-2 text-sm">Password</label>
        <input id="userPassInp" class="w-full border rounded px-3 py-2" />
        <label class="block mt-2 text-sm">Display Name</label>
        <input id="userDisplayInp" class="w-full border rounded px-3 py-2" />
        <label class="block mt-2 text-sm">Role</label>
        <select id="userRoleInp" class="w-full border rounded px-3 py-2"><option>Admin</option><option>Operator</option></select>
        <label class="block mt-2 text-sm">Company</label>
        <select id="userCompanyInp" class="w-full border rounded px-3 py-2"></select>
        <div class="flex gap-2 mt-3">
          <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="saveUser()">Save</button>
          <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="closeUserModal()">Cancel</button>
        </div>
      </div>
    </div>
  </section>

  <!-- LOCATIONS -->
  <section id="pageLocations" class="hidden">
    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-xl shadow p-4">
        <div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">← Back</button></div>
        <h3 class="font-semibold">Add / Edit Location</h3>
        <label class="block mt-3 text-sm">Name</label>
        <input id="locName" class="w-full border rounded px-3 py-2" />
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div><label class="text-sm">Latitude</label><input id="locLat" class="w-full border rounded px-3 py-2" /></div>
          <div><label class="text-sm">Longitude</label><input id="locLng" class="w-full border rounded px-3 py-2" /></div>
        </div>
        <label class="block mt-2 text-sm">Radius (meters)</label>
        <input id="locRadius" type="number" value="500" class="w-full border rounded px-3 py-2" />
        <label class="block mt-2 text-sm">Announcement message</label>
        <input id="locMsg" class="w-full border rounded px-3 py-2" placeholder="Custom announcement text (played during trip)" />
        <div class="flex gap-2 mt-3">
          <button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" onclick="useCurrentGPS()">Use Current GPS</button>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="saveLocation()">Save</button>
          <button class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded" onclick="testAnnouncement()">Test Announcement</button>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="font-semibold">Map Picker</h3>
        <div id="locMap" class="mapbox mt-2"></div>
        <h4 class="mt-4">Saved Locations</h4>
        <div id="locationList" class="mt-2 space-y-2"></div>
      </div>
    </div>
  </section>

  <!-- TRIP SETUP -->
  <section id="pageTripSetup" class="hidden">
    <div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">← Back</button></div>

    <div class="bg-white rounded-xl shadow p-4">
      <h3 class="font-semibold">Manage Trips</h3>

      <div class="grid md:grid-cols-3 gap-4 mt-4">
        <div>
          <label class="text-sm">Trip Name</label>
          <input id="tripName" class="w-full border rounded px-3 py-2" />
          <label class="text-sm mt-2">Available Locations</label>
          <div id="availList" class="border rounded mt-2 p-2 h-64 overflow-auto bg-white"></div>
        </div>

        <div class="flex flex-col items-center justify-center gap-2">
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="addPlanned()">Add →</button>
          <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="removePlanned()">← Remove</button>
          <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="movePlanned(-1)">↑ Up</button>
          <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="movePlanned(1)">↓ Down</button>
          <button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded" onclick="clearPlanned()">Clear</button>
        </div>

        <div>
          <label class="text-sm">Planned Trip (ordered)</label>
          <div id="plannedList" class="border rounded mt-2 p-2 h-64 overflow-auto bg-white"></div>
          <div class="flex gap-2 mt-3">
            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="saveTrip()">Save Trip</button>
          </div>
        </div>
      </div>

      <h4 class="mt-4">Saved Trips</h4>
      <div id="tripList" class="mt-2 space-y-2"></div>
    </div>
  </section>

  <!-- START TRIP -->
  <section id="pageStartTrip" class="hidden">
    <div id="startPanel" class="bg-white rounded-xl shadow p-4">
      <div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">← Back</button></div>
      <h3 class="font-semibold">Start Trip</h3>
      <label class="block mt-3 text-sm">Choose trip</label>
      <select id="startTripSelect" class="w-full border rounded px-3 py-2"></select>
      <div class="flex gap-2 mt-3">
        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="startSelectedTrip()">Start Trip</button>
      </div>
    </div>

    <div id="ongoingPanel" class="hidden mt-4">
      <!-- BACK BUTTON (INSIDE ONGOING PANEL) -> ALWAYS GO HOME -->
      <div class="flex justify-between items-center mb-3">
        <div>
          <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">← Back to Home</button>
        </div>
        <div><button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" onclick="endTrip()">End Trip</button></div>
      </div>

      <div>
        <div id="runMap" class="mapbox"></div>
      </div>

      <div class="mt-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <label class="text-sm small-muted">Auto Refresh:</label>
          <select id="autoRefreshSelect" class="border rounded px-2 py-1 bg-white" onchange="setAutoRefreshInterval()">
            <option value="5">5s</option>
            <option value="10" selected>10s</option>
            <option value="15">15s</option>
            <option value="20">20s</option>
          </select>
          <div class="text-sm text-slate-500 ml-2">Device GPS mode</div>
        </div>

        <div class="flex items-center gap-2">
          <button class="bg-white border px-3 py-1 rounded hover:bg-gray-50" onclick="centerCurrentGPS()">Current Location</button>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4 mt-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="flex flex-wrap gap-2 items-center">
            <button class="bg-white border px-3 py-2 rounded shadow hover:bg-gray-50" onclick="centerMap()">Center Map</button>
            <button class="bg-white border px-3 py-2 rounded shadow hover:bg-gray-50" onclick="manualAnn()">Manual Announcement</button>
            <div class="flex items-center gap-2 pl-2">
              <div class="text-xs small-muted">Volume</div>
              <input id="volControl" type="range" min="0" max="1" step="0.1" value="1" onchange="setVolume(this.value)" />
            </div>
          </div>

          <div class="text-sm text-slate-600">
            <div><span class="font-semibold" id="ongoingTripName">—</span></div>
            <div class="text-xs text-slate-400">Started: <span id="ongoingStart">—</span></div>
          </div>
        </div>

        <hr class="my-3"/>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <div class="text-xs small-muted">Current Latitude / Longitude</div>
            <div class="font-mono" id="curLat">—</div>
            <div class="font-mono" id="curLng">—</div>
            <div class="text-xs small-muted mt-2">Current Speed</div>
            <div id="curSpeed">—</div>
          </div>

          <div>
            <div class="text-xs small-muted">Upcoming Stop</div>
            <div class="font-semibold" id="upcomingName">—</div>
            <div class="text-xs small-muted mt-2">Distance to Next</div>
            <div id="distNext">—</div>
            <div class="text-xs small-muted mt-2">ETA to Next</div>
            <div id="etaNext">—</div>
          </div>

          <div>
            <div class="text-xs small-muted">Progress</div>
            <div class="font-semibold" id="progressStops">—</div>
            <div class="w-full bg-slate-100 h-3 rounded mt-2 overflow-hidden">
              <div id="progressBar" class="bg-blue-600 h-3 rounded" style="width:0%"></div>
            </div>
            <div class="text-xs text-slate-500 mt-2">Stops reached / total</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="pageReports" class="hidden">
    <div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">← Back</button></div>
    <div class="bg-white rounded-xl shadow p-4">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Reports</h3>
        <div>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded" onclick="exportTripsExcel()">Export Trips</button>
          <button class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded" onclick="exportLoginsExcel()">Export Logins</button>
        </div>
      </div>

      <h4 class="mt-4">Trip History</h4>
      <div id="reportTrips" class="mt-2 space-y-2"></div>

      <h4 class="mt-4">Login Activity</h4>
      <div id="reportLogins" class="mt-2 space-y-2"></div>
    </div>
  </section>

</main>

<!-- toast -->
<div id="toast" class="hidden fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-2 rounded shadow"></div>

<script>
/* =========================
   STORAGE & STATE
   ========================= */
const LS = {
  get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch(e){ return def; } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
};
const K = {
  COMPANIES:'bm_companies',
  USERS:'bm_users',
  LOCS:'bm_locations',
  TRIPS:'bm_trips',
  RUNS:'bm_runs',
  LOGINS:'bm_logins',
  SESSION:'bm_session'
};
if(!LS.get(K.COMPANIES)) LS.set(K.COMPANIES, []);
if(!LS.get(K.USERS)) LS.set(K.USERS, []);
if(!LS.get(K.LOCS)) LS.set(K.LOCS, []);
if(!LS.get(K.TRIPS)) LS.set(K.TRIPS, []);
if(!LS.get(K.RUNS)) LS.set(K.RUNS, []);
if(!LS.get(K.LOGINS)) LS.set(K.LOGINS, []);

// small utilities
function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
function toast(msg, ms=1800){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), ms); }
function fmtISO(iso){ try{ return new Date(iso).toLocaleString(); }catch(e){ return iso; } }
function haversine(lat1,lon1,lat2,lon2){ const toRad=v=>v*Math.PI/180; const R=6371000; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; }

/* =========================
   Seed minimal data if empty
   ========================= */
(function seed(){
  if(LS.get(K.COMPANIES,[]).length===0){
    const comp = { id: uid('comp'), name:'Demo Transit Co', logo:'', enabled:true };
    LS.set(K.COMPANIES, [comp]);
    LS.set(K.USERS, [
      { username:'bhagyesh', pass:'bhagyesh', role:'Master', companyId:null, enabled:true, displayName:'Bhagyesh Limbad' },
      { username:'admin', pass:'admin', role:'Admin', companyId:comp.id, enabled:true, displayName:'Admin' },
      { username:'operator', pass:'operator', role:'Operator', companyId:comp.id, enabled:true, displayName:'Operator 1' }
    ]);
    const locs = [
      { id: uid('loc'), name:'Station A', lat:21.6417, lng:69.6293, radius:500, msg:'Station A — please prepare to disembark', imgData:null, companyId:comp.id },
      { id: uid('loc'), name:'Station B', lat:21.6517, lng:69.6390, radius:400, msg:'Station B — doors will open on the left', imgData:null, companyId:comp.id },
      { id: uid('loc'), name:'Station C', lat:21.6617, lng:69.6490, radius:300, msg:'Station C — final stop', imgData:null, companyId:comp.id }
    ];
    LS.set(K.LOCS, locs);
    LS.set(K.TRIPS, [{ id: uid('trip'), name:'Demo Route', locs: locs.map(l=>({...l})), companyId: comp.id }]);
  }
})();

/* =========================
   Runtime
   ========================= */
let locMap=null, locMarker=null, locCircle=null;
let runMap=null, runMarkers=[], runCircles=[], runPolyline=null;
let watchId = null, autoRefreshIntervalId = null;
let runtime = {
  active: null, // { tripId, name, locs[], startedAt, reached:[], idx, meMarker }
  lastPos: null,
  ttsVolume: 1
};

/* =========================
   Navigation helper
   ========================= */
function go(pageId){
  // hide all main sections
  document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
  const el = document.getElementById(pageId);
  if(el) el.classList.remove('hidden');

  // page-specific inits
  if(pageId==='pageLocations'){ setTimeout(initLocMap,80); renderLocationList(); }
  if(pageId==='pageTripSetup'){ renderAvailList(); renderPlanned(); renderTripList(); }
  if(pageId==='pageStartTrip'){ renderStartSelect(); }
  if(pageId==='pageReports'){ renderReports(); }
  if(pageId==='pageUsers'){ renderUserList(); }
  if(pageId==='pageMasterAdmin'){ renderCompanyList(); }
}

/* =========================
   Auth
   ========================= */
function handleLogin(){
  const userInput = (document.getElementById('loginUser').value||'').trim();
  const passInput = (document.getElementById('loginPass').value||'').trim();
  if(!userInput) return alert('Enter username');

  // Master admin quick credentials
  if(userInput.toLowerCase()==='bhagyesh' && passInput==='bhagyesh'){
    const s = { user:'bhagyesh', role:'Master', companyId:null, displayName:'Bhagyesh Limbad' };
    LS.set(K.SESSION, s); logLogin(s.user, s.role); bootAfterLogin(); return;
  }

  const users = LS.get(K.USERS,[]);
  const found = users.find(u => u.username.toLowerCase() === userInput.toLowerCase() && u.pass === passInput);
  if(!found) return alert('Invalid credentials');
  if(found.enabled===false) return alert('User disabled');

  const sess = { user: found.username, role: found.role, companyId: found.companyId || null, displayName: found.displayName || found.username };
  LS.set(K.SESSION, sess); logLogin(sess.user, sess.role); bootAfterLogin();
}
function logLogin(user, role){ const logs = LS.get(K.LOGINS,[]); logs.push({ user, role, time:new Date().toISOString(), device:navigator.userAgent, ip:'0.0.0.0' }); LS.set(K.LOGINS, logs); }
function logout(){
  LS.set(K.SESSION, null);
  if(watchId!==null) { navigator.geolocation.clearWatch(watchId); watchId=null; }
  if(autoRefreshIntervalId!==null) { clearInterval(autoRefreshIntervalId); autoRefreshIntervalId=null; }
  runtime.active=null;
  document.getElementById('pageLogin').classList.remove('hidden');
  document.getElementById('pageHome').classList.add('hidden');
  document.getElementById('logoutBtn').classList.add('hidden');
  document.getElementById('userLabel').textContent = 'Guest';
  document.getElementById('roleLabel').textContent = '';
}

/* After login boot */
function bootAfterLogin(){
  const s = LS.get(K.SESSION, null);
  if(!s) return;
  document.getElementById('logoutBtn').classList.remove('hidden');
  document.getElementById('userLabel').textContent = s.displayName || s.user;
  document.getElementById('roleLabel').textContent = s.role;
  applyHeader();
  go('pageHome');
}

/* header & tile visibility */
function applyHeader(){
  const s = LS.get(K.SESSION, null);
  const comps = LS.get(K.COMPANIES,[]);
  const comp = s?.companyId ? comps.find(c=>c.id===s.companyId) : null;
  document.getElementById('companyTitle').textContent = comp?.name || 'BusMate';
  document.getElementById('companySub').textContent = 'Vehicle Tracking Prototype';
  if(!s) return;

  document.getElementById('userLabel').textContent = s.displayName || s.user;
  document.getElementById('roleLabel').textContent = s.role;

  // show tiles
  ['tileCompanies','tileUsers','tileLocations','tileTrips','tileStart','tileReports'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  if(s.user==='bhagyesh' || s.role==='Master'){
    ['tileCompanies','tileUsers','tileLocations','tileTrips','tileStart','tileReports'].forEach(id=>document.getElementById(id).classList.remove('hidden'));
  } else if(s.role==='Admin'){
    ['tileUsers','tileLocations','tileTrips','tileStart','tileReports'].forEach(id=>document.getElementById(id).classList.remove('hidden'));
  } else if(s.role==='Operator'){
    ['tileStart','tileReports'].forEach(id=>document.getElementById(id).classList.remove('hidden'));
  }

  document.getElementById('statLocations').textContent = LS.get(K.LOCS,[]).length;
  document.getElementById('statTrips').textContent = LS.get(K.TRIPS,[]).length;
  document.getElementById('statCompanies').textContent = LS.get(K.COMPANIES,[]).length;
  document.getElementById('statRuns').textContent = LS.get(K.RUNS,[]).length;
}

/* =========================
   COMPANY (master)
   ========================= */
function renderCompanyList(){
  const wrap = document.getElementById('companyList'); wrap.innerHTML='';
  const comps = LS.get(K.COMPANIES,[]);
  if(comps.length===0){ wrap.innerHTML = '<div class="text-sm text-slate-400">No companies</div>'; return; }
  comps.forEach(c=>{
    const div = document.createElement('div'); div.className='flex items-center justify-between';
    div.innerHTML = `<div><div class="font-semibold">${c.name}</div><div class="text-xs text-slate-500">${c.id} · ${c.enabled ? 'Enabled' : 'Disabled'}</div></div>
      <div class="flex gap-2">
        <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editCompany('${c.id}')">Edit</button>
        <button class="${c.enabled?'bg-yellow-500':'bg-green-600'} text-white px-3 py-1 rounded" onclick="toggleCompany('${c.id}')">${c.enabled ? 'Disable':'Enable'}</button>
        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" onclick="deleteCompany('${c.id}')">Delete</button>
      </div>`;
    wrap.appendChild(div);
  });
}
function openCompanyForm(){ document.getElementById('companyModal').classList.remove('hidden'); document.getElementById('companyNameInp').value=''; document.getElementById('companyLogoInp').value=''; window._editingCompany=null; }
function closeCompanyModal(){ document.getElementById('companyModal').classList.add('hidden'); window._editingCompany=null; }
function saveCompany(){ const name=(document.getElementById('companyNameInp').value||'').trim(); const logo=(document.getElementById('companyLogoInp').value||'').trim(); if(!name) return alert('Company name required'); const comps=LS.get(K.COMPANIES,[]); if(window._editingCompany){ const i=comps.findIndex(c=>c.id===window._editingCompany); if(i>=0){ comps[i].name=name; comps[i].logo=logo; } } else { comps.push({ id: uid('comp'), name, logo, enabled:true }); } LS.set(K.COMPANIES, comps); renderCompanyList(); closeCompanyModal(); applyHeader(); toast('Company saved'); }
function editCompany(id){ const comps=LS.get(K.COMPANIES,[]); const c=comps.find(x=>x.id===id); if(!c) return; window._editingCompany=id; document.getElementById('companyNameInp').value=c.name; document.getElementById('companyLogoInp').value=c.logo||''; document.getElementById('companyModal').classList.remove('hidden'); }
function toggleCompany(id){ const comps=LS.get(K.COMPANIES,[]); const i=comps.findIndex(c=>c.id===id); if(i===-1) return; comps[i].enabled=!comps[i].enabled; LS.set(K.COMPANIES, comps); renderCompanyList(); }
function deleteCompany(id){ if(!confirm('Delete company and related data?')) return; LS.set(K.COMPANIES, LS.get(K.COMPANIES,[]).filter(c=>c.id!==id)); LS.set(K.USERS, LS.get(K.USERS,[]).filter(u=>u.companyId!==id)); LS.set(K.LOCS, LS.get(K.LOCS,[]).filter(l=>l.companyId!==id)); LS.set(K.TRIPS, LS.get(K.TRIPS,[]).filter(t=>t.companyId!==id)); renderCompanyList(); renderUserList(); renderLocationList(); renderTripList(); toast('Company deleted'); }

/* =========================
   USERS (company scoped)
   ========================= */
function renderUserList(){
  const wrap = document.getElementById('usersList'); wrap.innerHTML='';
  const s = LS.get(K.SESSION, null);
  const users = LS.get(K.USERS,[]);
  const visible = (!s || s.user==='bhagyesh') ? users : users.filter(u=>u.companyId===s.companyId);
  if(visible.length===0){ wrap.innerHTML = '<div class="text-sm text-slate-400">No users</div>'; return; }
  visible.forEach(u=>{
    const comp = LS.get(K.COMPANIES,[]).find(c=>c.id===u.companyId);
    const div = document.createElement('div'); div.className='list-row flex items-center justify-between';
    div.innerHTML = `<div><div class="font-medium">${u.displayName || u.username} <span class="chip">${u.role}</span></div><div class="text-xs text-slate-500">${u.username} · ${comp?comp.name:'—'}</div></div>
      <div class="flex gap-2"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editUser('${u.username}')">Edit</button><button class="bg-yellow-500 px-3 py-1 rounded text-white" onclick="toggleUser('${u.username}')">${u.enabled? 'Disable':'Enable'}</button><button class="bg-red-600 px-3 py-1 rounded text-white" onclick="deleteUser('${u.username}')">Delete</button></div>`;
    wrap.appendChild(div);
  });
}
function openUserForm(){
  const comps = LS.get(K.COMPANIES,[]); const sel = document.getElementById('userCompanyInp'); sel.innerHTML=''; comps.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o); });
  window._editingUser=null; document.getElementById('userNameInp').value=''; document.getElementById('userPassInp').value=''; document.getElementById('userDisplayInp').value=''; document.getElementById('userRoleInp').value='Operator'; document.getElementById('userModal').classList.remove('hidden');
}
function closeUserModal(){ document.getElementById('userModal').classList.add('hidden'); window._editingUser=null; document.getElementById('userNameInp').disabled=false; }
function saveUser(){ const username=(document.getElementById('userNameInp').value||'').trim(); const pass=(document.getElementById('userPassInp').value||'').trim(); const display=(document.getElementById('userDisplayInp').value||'').trim(); const role=document.getElementById('userRoleInp').value; const companyId=document.getElementById('userCompanyInp').value||null; if(!username||!pass) return alert('Username & password required'); const users=LS.get(K.USERS,[]); if(window._editingUser){ const i=users.findIndex(u=>u.username===window._editingUser); if(i>=0){ users[i].pass=pass; users[i].displayName=display; users[i].role=role; users[i].companyId=companyId; users[i].enabled=true; } } else { if(users.find(u=>u.username===username)) return alert('Username exists'); users.push({ username, pass, role, companyId, enabled:true, displayName:display }); } LS.set(K.USERS, users); closeUserModal(); renderUserList(); toast('User saved'); }
function editUser(username){ const users=LS.get(K.USERS,[]); const u=users.find(x=>x.username===username); if(!u) return; window._editingUser=username; document.getElementById('userNameInp').value=u.username; document.getElementById('userNameInp').disabled=true; document.getElementById('userPassInp').value=u.pass; document.getElementById('userDisplayInp').value=u.displayName||''; document.getElementById('userRoleInp').value=u.role; const comps=LS.get(K.COMPANIES,[]); const sel=document.getElementById('userCompanyInp'); sel.innerHTML=''; comps.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; if(c.id===u.companyId) o.selected=true; sel.appendChild(o); }); document.getElementById('userModal').classList.remove('hidden'); }
function toggleUser(username){ const users=LS.get(K.USERS,[]); const i=users.findIndex(u=>u.username===username); if(i===-1) return; users[i].enabled = !users[i].enabled; LS.set(K.USERS, users); renderUserList(); }
function deleteUser(username){ if(!confirm('Delete user?')) return; LS.set(K.USERS, LS.get(K.USERS,[]).filter(u=>u.username!==username)); renderUserList(); toast('User deleted'); }

/* =========================
   LOCATIONS (map picker) 
   ========================= */
function initLocMap(){
  if(locMap){ try{ locMap.invalidateSize(); }catch(e){} return; }
  locMap = L.map('locMap');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(locMap);
  locMap.setView([21.6417,69.6293], 12);
  locMap.on('click', e=> setPicker(e.latlng.lat, e.latlng.lng));
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=> locMap.setView([p.coords.latitude,p.coords.longitude], 14), ()=>{});
  }
  renderLocationList();
}
function setPicker(lat,lng){
  document.getElementById('locLat').value = lat.toFixed(6);
  document.getElementById('locLng').value = lng.toFixed(6);
  const r = parseInt(document.getElementById('locRadius').value||500,10);
  if(!locMarker){ locMarker = L.marker([lat,lng], { draggable:true }).addTo(locMap); locMarker.on('dragend', e=>{ const p=e.target.getLatLng(); document.getElementById('locLat').value = p.lat.toFixed(6); document.getElementById('locLng').value = p.lng.toFixed(6); drawLocCircle(p.lat,p.lng); }); } else locMarker.setLatLng([lat,lng]);
  drawLocCircle(lat,lng,r);
}
function drawLocCircle(lat,lng){
  const radius = parseInt(document.getElementById('locRadius').value||500,10);
  if(locCircle) locMap.removeLayer(locCircle);
  locCircle = L.circle([lat,lng], { radius, fillOpacity:0.06, color:'#2563eb' }).addTo(locMap);
}
function useCurrentGPS(){
  if(!navigator.geolocation) return alert('Geolocation not available');
  navigator.geolocation.getCurrentPosition(p=>{ locMap.setView([p.coords.latitude,p.coords.longitude],16); setPicker(p.coords.latitude,p.coords.longitude); toast('Picker updated'); }, err=> alert('GPS error: '+err.message), { enableHighAccuracy:true });
}
function testAnnouncement(){ const msg=(document.getElementById('locMsg').value||'Test announcement').trim(); speak(msg); }
function saveLocation(){
  const name=(document.getElementById('locName').value||'').trim(); const lat=parseFloat(document.getElementById('locLat').value); const lng=parseFloat(document.getElementById('locLng').value); const radius=parseInt(document.getElementById('locRadius').value||500,10); const msg=(document.getElementById('locMsg').value||'').trim();
  if(!name || isNaN(lat) || isNaN(lng)) return alert('Provide name, lat and lng');
  if(radius<=0) return alert('Radius > 0 required');
  const s = LS.get(K.SESSION, null); const companyId = (s && s.user!=='bhagyesh') ? s.companyId : LS.get(K.COMPANIES,[])[0]?.id || null;
  const locs = LS.get(K.LOCS,[]); locs.push({ id: uid('loc'), name, lat, lng, radius, msg, imgData:null, companyId, createdAt:new Date().toISOString() }); LS.set(K.LOCS, locs);
  document.getElementById('locName').value=''; document.getElementById('locLat').value=''; document.getElementById('locLng').value=''; document.getElementById('locMsg').value='';
  if(locMarker){ try{ locMap.removeLayer(locMarker); }catch(e){} locMarker=null; } if(locCircle){ try{ locMap.removeLayer(locCircle);}catch(e){} locCircle=null; }
  renderLocationList(); renderAvailList(); toast('Location saved');
}
function renderLocationList(){
  const wrap=document.getElementById('locationList'); wrap.innerHTML='';
  const s = LS.get(K.SESSION, null); const locs = LS.get(K.LOCS,[]); const visible = (!s || s.user==='bhagyesh') ? locs : locs.filter(l=>l.companyId===s.companyId);
  if(visible.length===0){ wrap.innerHTML='<div class="text-sm text-slate-400">No locations yet.</div>'; return; }
  visible.forEach(l=>{
    const row=document.createElement('div'); row.className='list-row flex items-start justify-between';
    row.innerHTML = `<div class="flex-1"><div class="font-semibold">${l.name}</div><div class="text-xs text-slate-500">Lat: ${l.lat.toFixed(6)} · Lng: ${l.lng.toFixed(6)} · R: ${l.radius}m</div>${l.msg?`<div class="text-xs text-slate-600 mt-1">Msg: ${l.msg}</div>`:''}</div>
      <div class="flex flex-col gap-2 ml-3">
        <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editLocation('${l.id}')">Edit</button>
        <button class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" onclick="deleteLocation('${l.id}')">Delete</button>
      </div>`;
    wrap.appendChild(row);
  });
}
function editLocation(id){ const locs=LS.get(K.LOCS,[]); const l=locs.find(x=>x.id===id); if(!l) return; document.getElementById('locName').value=l.name; document.getElementById('locLat').value=l.lat; document.getElementById('locLng').value=l.lng; document.getElementById('locRadius').value=l.radius; document.getElementById('locMsg').value=l.msg||''; setPicker(l.lat,l.lng); locs.splice(locs.findIndex(x=>x.id===id),1); LS.set(K.LOCS, locs); renderLocationList(); renderAvailList(); }
function deleteLocation(id){ if(!confirm('Delete location?')) return; LS.set(K.LOCS, LS.get(K.LOCS,[]).filter(x=>x.id!==id)); renderLocationList(); renderAvailList(); }

/* =========================
   TRIPS (fixed)
   ========================= */
let planned = [], plannedSelIdx = null;
function renderAvailList(){
  const wrap = document.getElementById('availList'); wrap.innerHTML='';
  const s = LS.get(K.SESSION, null);
  const locsAll = LS.get(K.LOCS,[]);
  const visible = (!s || s.user==='bhagyesh') ? locsAll : locsAll.filter(l=>l.companyId===s.companyId);
  if(visible.length===0){ wrap.innerHTML = '<div class="text-sm text-slate-400">No locations available.</div>'; return; }
  visible.forEach(l=>{
    const el = document.createElement('div'); el.className='p-2 rounded hover:bg-slate-50 flex items-center justify-between';
    el.innerHTML = `<div><div class="font-medium">${l.name}</div><div class="text-xs text-slate-500">${l.lat.toFixed(4)}, ${l.lng.toFixed(4)}</div></div><div><button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded" onclick="planAdd('${l.id}')">Add</button></div>`;
    wrap.appendChild(el);
  });
}
function planAdd(locId){ const loc = LS.get(K.LOCS,[]).find(x=>x.id===locId); if(!loc) return; planned.push({ id: loc.id, name: loc.name, lat: loc.lat, lng: loc.lng, radius: loc.radius, msg: loc.msg||'' }); renderPlanned(); }
function renderPlanned(){ const wrap=document.getElementById('plannedList'); wrap.innerHTML=''; if(planned.length===0){ wrap.innerHTML='<div class="text-sm text-slate-400">No planned stops</div>'; return; } planned.forEach((p,i)=>{ const el=document.createElement('div'); el.className='p-2 rounded hover:bg-slate-50 flex items-center justify-between'; el.innerHTML=`<div><div class="font-medium">${i+1}. ${p.name}</div><div class="text-xs text-slate-500">R ${p.radius}m</div></div><div class="flex gap-2"><button class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded" onclick="plannedSelect(${i})">Select</button></div>`; if(i===plannedSelIdx) el.classList.add('ring','ring-blue-300'); wrap.appendChild(el); }); }
function plannedSelect(i){ plannedSelIdx = (plannedSelIdx===i? null : i); renderPlanned(); }
function addPlanned(){ toast('Use Add on Available Locations'); }
function removePlanned(){ if(plannedSelIdx===null) return alert('Select planned stop'); planned.splice(plannedSelIdx,1); plannedSelIdx=null; renderPlanned(); }
function movePlanned(dir){ if(plannedSelIdx===null) return alert('Select planned stop'); const i=plannedSelIdx, j=i+dir; if(j<0||j>=planned.length) return; [planned[i],planned[j]]=[planned[j],planned[i]]; plannedSelIdx=j; renderPlanned(); }
function clearPlanned(){ if(!confirm('Clear planned stops?')) return; planned=[]; plannedSelIdx=null; renderPlanned(); }
function saveTrip(){ const name=(document.getElementById('tripName').value||'').trim(); if(!name) return alert('Trip name required'); if(planned.length<2) return alert('Select at least 2 stops'); const s=LS.get(K.SESSION,null); const companyId = (!s || s.user==='bhagyesh') ? null : s.companyId; const trips=LS.get(K.TRIPS,[]); trips.push({ id: uid('trip'), name, locs: planned.map(x=>({...x})), companyId, createdAt:new Date().toISOString() }); LS.set(K.TRIPS,trips); planned=[]; plannedSelIdx=null; document.getElementById('tripName').value=''; renderPlanned(); renderTripList(); renderStartSelect(); toast('Trip saved'); }
function renderTripList(){ const wrap=document.getElementById('tripList'); wrap.innerHTML=''; const s=LS.get(K.SESSION,null); const trips=LS.get(K.TRIPS,[]); const visible = (!s||s.user==='bhagyesh') ? trips : trips.filter(t=>t.companyId===s.companyId); if(visible.length===0){ wrap.innerHTML='<div class="text-sm text-slate-400">No trips</div>'; return; } visible.forEach(t=>{ const row=document.createElement('div'); row.className='list-row flex items-center justify-between'; row.innerHTML=`<div><div class="font-semibold">${t.name}</div><div class="text-xs text-slate-500">${t.locs.map(x=>x.name).join(' → ')}</div></div><div class="flex gap-2"><button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded" onclick="startTripById('${t.id}')">Start</button><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editTrip('${t.id}')">Edit</button><button class="bg-red-600 px-3 py-1 rounded text-white hover:bg-red-700" onclick="deleteTrip('${t.id}')">Delete</button></div>`; wrap.appendChild(row); }); }
function editTrip(id){ const trips=LS.get(K.TRIPS,[]); const t=trips.find(x=>x.id===id); if(!t) return; document.getElementById('tripName').value=t.name; planned = t.locs.map(x=>({...x})); renderPlanned(); trips.splice(trips.findIndex(x=>x.id===id),1); LS.set(K.TRIPS,trips); renderTripList(); go('pageTripSetup'); }
function deleteTrip(id){ if(!confirm('Delete trip?')) return; LS.set(K.TRIPS, LS.get(K.TRIPS,[]).filter(t=>t.id!==id)); renderTripList(); renderStartSelect(); }

/* =========================
   START TRIP & ONGOING LOGIC (FIXES applied)
   ========================= */
function renderStartSelect(){
  const sel = document.getElementById('startTripSelect'); sel.innerHTML='';
  const s=LS.get(K.SESSION,null);
  const trips=LS.get(K.TRIPS,[]); const visible = (!s||s.user==='bhagyesh') ? trips : trips.filter(t=>t.companyId===s.companyId);
  visible.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; sel.appendChild(o); });
  const wrap = document.getElementById('startTripList'); wrap.innerHTML=''; if(visible.length===0){ wrap.innerHTML='<div class="text-sm text-slate-400">No trips available.</div>'; return; }
  visible.forEach(t=>{ const row=document.createElement('div'); row.className='list-row flex items-center justify-between'; row.innerHTML=`<div><div class="font-semibold">${t.name}</div><div class="text-xs text-slate-500">${t.locs.map(x=>x.name).join(' → ')}</div></div><div><button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded" onclick="startTripById('${t.id}')">Start</button></div>`; wrap.appendChild(row); });
}

function startSelectedTrip(){ const id=document.getElementById('startTripSelect').value; if(!id) return alert('Select trip'); startTripById(id); }

function startTripById(id){
  const trips = LS.get(K.TRIPS,[]); const t = trips.find(x=>x.id===id); if(!t) return alert('Trip not found');
  runtime.active = { tripId:t.id, name:t.name, locs: JSON.parse(JSON.stringify(t.locs)), startedAt: new Date().toISOString(), reached: [], idx: 0, meMarker: null, _prevPos: null };
  document.getElementById('ongoingTripName').textContent = runtime.active.name;
  document.getElementById('ongoingStart').textContent = fmtISO(runtime.active.startedAt);

  // Map & markers
  if(!runMap) initRunMap();
  runMarkers.forEach(m=>{ try{ runMap.removeLayer(m);}catch(e){} }); runCircles.forEach(c=>{ try{ runMap.removeLayer(c);}catch(e){} }); runMarkers=[]; runCircles=[];
  if(runPolyline){ try{ runMap.removeLayer(runPolyline);}catch(e){} runPolyline=null; }

  const latlngs = runtime.active.locs.map(l=>[l.lat,l.lng]);
  runPolyline = L.polyline(latlngs, { color:'#2563eb', weight:4 }).addTo(runMap);
  runtime.active.locs.forEach((l,idx)=>{ const m = L.marker([l.lat,l.lng]).addTo(runMap).bindPopup(`${idx+1}. ${l.name}`); runMarkers.push(m); const c = L.circle([l.lat,l.lng], { radius:Number(l.radius||500), fillOpacity:0.06, color:'#2563eb' }).addTo(runMap); runCircles.push(c); });

  try{ runMap.fitBounds(runPolyline.getBounds(), { padding:[20,20] }); }catch(e){}
  // show ongoing panel
  document.getElementById('startPanel').classList.add('hidden');
  document.getElementById('ongoingPanel').classList.remove('hidden');

  // reset any previous state on locs: _enterCount / _arrived
  runtime.active.locs.forEach(l=>{ l._enterCount=0; l._arrived=false; });

  // start GPS watch
  if(watchId!==null){ try{ navigator.geolocation.clearWatch(watchId);}catch(e){} watchId=null; }
  if(navigator.geolocation) watchId = navigator.geolocation.watchPosition(onGPS, gpsError, { enableHighAccuracy:true, maximumAge:2000 });
  startPeriodicRefreshImmediate();
  updateProgressUI();
}

function initRunMap(){ if(runMap){ try{ runMap.invalidateSize(); }catch(e){} return; } runMap = L.map('runMap'); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(runMap); runMap.setView([21.6417,69.6293], 12); }
function createBusIcon(){ const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='36' height='36'><rect x='6' y='12' width='52' height='36' rx='6' fill='#0ea5e9' stroke='#0369a1' stroke-width='2'/><circle cx='20' cy='52' r='4' fill='#0b1220'/><circle cx='44' cy='52' r='4' fill='#0b1220'/><rect x='16' y='20' width='8' height='12' fill='#fff'/><rect x='40' y='20' width='8' height='12' fill='#fff'/></svg>`); return L.divIcon({ html:`<img src="data:image/svg+xml;charset=utf-8,${svg}" style="width:36px;height:36px;"/>`, className:'', iconSize:[36,36], iconAnchor:[18,18] }); }

function onGPS(pos){
  runtime.lastPos = pos;
  const lat = pos.coords.latitude, lng = pos.coords.longitude, sp = pos.coords.speed;
  if(!runtime.active) return;
  if(!runtime.active.meMarker) runtime.active.meMarker = L.marker([lat,lng], { icon:createBusIcon(), title:'Vehicle' }).addTo(runMap);
  else runtime.active.meMarker.setLatLng([lat,lng]);
  try{ runMap.panTo([lat,lng], { animate:true, duration:.6 }); }catch(e){}
  document.getElementById('curLat').textContent = lat.toFixed(6);
  document.getElementById('curLng').textContent = lng.toFixed(6);
  document.getElementById('curSpeed').textContent = sp ? (sp*3.6).toFixed(1) + ' km/h' : '—';

  // update upcoming & check for arrival
  updateUpcomingAndCheck(lat,lng,sp);
}
function gpsError(err){ console.warn('GPS error', err); }

function updateUpcomingAndCheck(lat,lng,speedMs){
  const trip = runtime.active; if(!trip) return;
  if(trip.idx >= trip.locs.length) return;

  const next = trip.locs[trip.idx];
  const d = haversine(lat,lng,next.lat,next.lng); // meters
  document.getElementById('upcomingName').textContent = next.name;
  document.getElementById('distNext').textContent = d>=1000 ? (d/1000).toFixed(2)+' km' : Math.round(d)+' m';

  // ETA calculation (fallback to estimate if speed missing)
  let sp = speedMs;
  if(!sp && trip._lastPos && trip._lastPosTime){
    const dt = (Date.now() - trip._lastPosTime)/1000; // s
    if(dt>0){
      const dMoved = haversine(trip._lastPos.lat, trip._lastPos.lng, lat, lng);
      sp = dMoved / dt; // m/s
    }
  }
  trip._lastPos = { lat,lng }; trip._lastPosTime = Date.now();
  let etaText = '—';
  const spUse = sp || 8.33; // fallback 30 km/h
  if(spUse > 0.1){ const sec = d / spUse; const min = Math.round(sec/60); etaText = (min<=1) ? '~1 min' : `~${min} min`; }
  document.getElementById('etaNext').textContent = etaText;

  // draw dotted line to next
  if(trip._nextLine){ try{ runMap.removeLayer(trip._nextLine); }catch(e){} trip._nextLine=null; }
  trip._nextLine = L.polyline([[lat,lng],[next.lat,next.lng]], { color:'blue', dashArray:'6' }).addTo(runMap);

  const preRadius = Math.max(100, next.radius);
  const arrRadius = Math.max(50, Math.round(next.radius / 2));

  if(!next._enterCount) next._enterCount = 0;
  if(!next._arrived) next._arrived = false;

  // Announce custom message (up to 3x) while within preRadius
  if(!next._arrived && d <= preRadius && next._enterCount < 3){
    next._enterCount++;
    const msg = next.msg && next.msg.trim() ? next.msg : `Next stop: ${next.name}`;
    speak(msg);
  }

  // Arrival: mark arrived, increment idx, update progress
  if(!next._arrived && d <= arrRadius){
    next._arrived = true;
    trip.reached.push({ name: next.name, time: new Date().toISOString() });

    // Update marker/circle visuals for this stop
    try{ if(runMarkers[trip.idx]) runMarkers[trip.idx].setIcon(L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/190/190411.png', iconSize:[28,28] })); }catch(e){}
    try{ if(runCircles[trip.idx]) runCircles[trip.idx].setStyle({ color:'#16a34a' }); }catch(e){}

    // increment to next
    trip.idx++;
    updateProgressUI();

    // announce arrival (use same message or a distinct 'arrived' message)
    const arrMsg = next.msg && next.msg.trim() ? next.msg : `Arrived at ${next.name}`;
    speak(arrMsg);

    // if completed all stops, finalize
    if(trip.idx >= trip.locs.length){
      speak('Destination reached. Trip complete.');
      setTimeout(()=> finishAndSaveRun(), 1200);
      return;
    } else {
      // set upcoming to next stop name immediately for UI
      document.getElementById('upcomingName').textContent = trip.locs[trip.idx].name;
    }
  }
}

function updateProgressUI(){
  if(!runtime.active){ document.getElementById('progressStops').textContent='—'; document.getElementById('progressBar').style.width='0%'; return; }
  const reached = runtime.active.reached.length; const total = runtime.active.locs.length;
  const pct = total===0 ? 0 : Math.round((reached/total)*100);
  document.getElementById('progressStops').textContent = `${reached} / ${total} (${pct}%)`;
  document.getElementById('progressBar').style.width = pct + '%';
}

function finishAndSaveRun(){
  if(!runtime.active) return;
  const endedAt = new Date().toISOString();
  const durationMin = Math.round((new Date(endedAt) - new Date(runtime.active.startedAt))/60000);
  const run = { tripName: runtime.active.name, startedAt: runtime.active.startedAt, endedAt, durationMin, reached: runtime.active.reached };
  const runs = LS.get(K.RUNS,[]); runs.push(run); LS.set(K.RUNS, runs);
  toast('Run saved');
  setTimeout(()=> endTrip(), 800);
}

function manualAnn(){ if(!runtime.active) return; const idx = Math.max(0, Math.min(runtime.active.idx, runtime.active.locs.length-1)); const next = runtime.active.locs[idx]; const msg = next.msg && next.msg.trim() ? next.msg : `Next stop: ${next.name}`; speak(msg); }

function endTrip(){
  if(!runtime.active) return;
  const endedAt = new Date().toISOString();
  const durationMin = Math.round((new Date(endedAt) - new Date(runtime.active.startedAt))/60000);
  const run = { tripName: runtime.active.name, startedAt: runtime.active.startedAt, endedAt, durationMin, reached: runtime.active.reached };
  const runs = LS.get(K.RUNS,[]); runs.push(run); LS.set(K.RUNS, runs);

  if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  if(autoRefreshIntervalId!==null){ clearInterval(autoRefreshIntervalId); autoRefreshIntervalId=null; }
  if(runtime.active && runtime.active.meMarker){ try{ runMap.removeLayer(runtime.active.meMarker); }catch(e){} }
  runtime.active = null;

  document.getElementById('ongoingPanel').classList.add('hidden');
  document.getElementById('startPanel').classList.remove('hidden');
  toast('Trip ended and saved to reports');
  renderReports();
  renderTripList();
  renderStartSelect();
}

/* center map and gps helpers */
function centerMap(){ if(runtime.lastPos && runMap) runMap.panTo([runtime.lastPos.coords.latitude, runtime.lastPos.coords.longitude]); }
function centerCurrentGPS(){ if(!navigator.geolocation) return alert('Geolocation not available'); navigator.geolocation.getCurrentPosition(p=>{ onGPS(p); runMap.panTo([p.coords.latitude,p.coords.longitude]); }, err=>alert('GPS error: '+err.message)); }

/* TTS and volume */
function setVolume(v){ runtime.ttsVolume = Number(v); toast('Volume: ' + runtime.ttsVolume); }
function speak(text){ try{ const u = new SpeechSynthesisUtterance(text); u.volume = Number(runtime.ttsVolume || 1.0); speechSynthesis.speak(u); }catch(e){ console.warn('TTS error', e); } }

/* =========================
   Periodic refresh
   ========================= */
function startPeriodicRefreshImmediate(){
  if(autoRefreshIntervalId) clearInterval(autoRefreshIntervalId);
  if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=> onGPS(p), ()=>{}); }
  setAutoRefreshInterval();
}
function setAutoRefreshInterval(){
  if(autoRefreshIntervalId) clearInterval(autoRefreshIntervalId);
  const secs = Number(document.getElementById('autoRefreshSelect').value || 10);
  autoRefreshIntervalId = setInterval(()=> {
    if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=> onGPS(p), ()=>{}); }
  }, secs*1000);
  toast('Auto refresh ' + secs + 's');
}

/* =========================
   Reports & exports
   ========================= */
function renderReports(){
  const ul = document.getElementById('reportTrips'); ul.innerHTML='';
  const runs = LS.get(K.RUNS,[]);
  if(runs.length===0) ul.innerHTML = '<div class="text-sm text-slate-400">No trip reports yet.</div>';
  runs.slice().reverse().forEach(r=>{
    const div=document.createElement('div'); div.className='list-row';
    div.innerHTML = `<div class="font-semibold">${r.tripName}</div><div class="text-xs text-slate-500">Start: ${fmtISO(r.startedAt)} | End: ${fmtISO(r.endedAt)} | Duration: ${r.durationMin} min</div><div class="text-xs text-slate-600 mt-1">Stops: ${r.reached.map(s=>s.name+' ('+fmtISO(s.time)+')').join(', ') || '—'}</div>`;
    ul.appendChild(div);
  });
  const logs = LS.get(K.LOGINS,[]); const ul2 = document.getElementById('reportLogins'); ul2.innerHTML='';
  if(logs.length===0) ul2.innerHTML = '<div class="text-sm text-slate-400">No login activity</div>';
  logs.slice().reverse().forEach(l=>{ const li=document.createElement('div'); li.className='list-row'; li.innerHTML = `<div class="font-medium">${l.user}</div><div class="text-xs text-slate-500">${l.role} · ${fmtISO(l.time)} · ${l.device}</div>`; ul2.appendChild(li); });
}
function exportTripsExcel(){ const runs = LS.get(K.RUNS,[]); const rows = []; runs.forEach(r=>{ rows.push({ Trip: r.tripName, StartedAt: r.startedAt, EndedAt: r.endedAt, DurationMin: r.durationMin }); r.reached.forEach(s=> rows.push({ Trip: r.tripName, StopReached: s.name, ReachedAt: s.time })); }); const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'TripReports'); XLSX.writeFile(wb, 'trip_reports.xlsx'); }
function exportLoginsExcel(){ const logs = LS.get(K.LOGINS,[]); const ws = XLSX.utils.json_to_sheet(logs); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'LoginLogs'); XLSX.writeFile(wb, 'login_logs.xlsx'); }

/* =========================
   Small helpers & boot
   ========================= */
function showHelp(){ alert('BusMate prototype — Master: bhagyesh/bhagyesh; Admin: admin/admin; Operator: operator/operator. Serve via static server for geolocation.'); }

/* Boot */
(function boot(){
  const s = LS.get(K.SESSION, null);
  if(s){ document.getElementById('logoutBtn').classList.remove('hidden'); document.getElementById('userLabel').textContent = s.displayName || s.user; document.getElementById('roleLabel').textContent = s.role; applyHeader(); go('pageHome'); } else { go('pageLogin'); }
  // initial renders
  renderCompanyList(); renderUserList(); renderLocationList(); renderAvailList(); renderTripList(); renderStartSelect(); renderReports();
})();

/* Expose debug object */
window._bm = { LS, K, runtime };

</script>
</body>
</html>
