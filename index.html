<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BusMate Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap 5 (responsive UI) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet (map, OSM tiles) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- SheetJS (Excel export) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root { --brand:#0d6efd; }
    body{ background:#f6f7fb; }
    header.appbar{
      position:sticky; top:0; z-index:1030;
      background:var(--brand); color:#fff; padding:.8rem 1rem;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .logo-title{ display:flex; align-items:center; gap:.6rem; font-weight:700; }
    .logo { width:30px; height:30px; border-radius:6px; background:#fff; display:inline-block; }
    .page { display:none; padding:1rem; }
    .page.active{ display:block; }
    .card-btn{ padding:18px; font-size:1rem; }
    .mapbox{ height:320px; width:100%; border-radius:.5rem; overflow:hidden; border:1px solid #e5e7eb; }
    .list-mini { font-size:.9rem; color:#555; }
    .pill { background:#eef2ff; color:#3730a3; padding:.2rem .5rem; border-radius:999px; font-size:.75rem; }
    .footer-gap{ height:50px; } /* safe space on mobile */
    @media (min-width: 992px){
      .mapbox{ height:420px; }
      .card-btn{ font-size:1.05rem; }
    }
  </style>
</head>
<body>

  <!-- Top App Bar -->
  <header class="appbar">
    <div class="logo-title">
      <span class="logo"></span>
      <span id="topCompany">BusMate</span>
    </div>
    <div>
      <span id="topUser" class="me-2"></span>
      <button class="btn btn-sm btn-light" id="btnLogout" onclick="logout()" style="display:none">Logout</button>
    </div>
  </header>

  <!-- LOGIN PAGE -->
  <section class="page active" id="pageLogin">
    <div class="container" style="max-width:520px">
      <div class="card shadow-sm p-4 mt-4">
        <div class="text-center">
          <div class="logo mb-2" style="width:54px;height:54px;"></div>
          <h3 class="mb-1">BusMate</h3>
          <div class="text-muted">Sign in to continue</div>
        </div>
        <div class="mt-3">
          <label class="form-label">Username / Email</label>
          <input class="form-control" id="loginUser" placeholder="e.g. operator1 or admin" />
        </div>
        <div class="mt-3">
          <label class="form-label">Password</label>
          <input class="form-control" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div class="d-grid mt-4">
          <button class="btn btn-primary" onclick="handleLogin()">Login</button>
        </div>
        <div class="text-center text-muted mt-3 small">
          Tip: Use <b>admin</b> as username to see Admin Panel.
        </div>
      </div>
    </div>
  </section>

  <!-- HOME (DASHBOARD) -->
  <section class="page" id="pageHome">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center my-2">
        <div>
          <div class="fw-bold">Welcome, <span id="welcomeUser">Operator</span></div>
          <div class="small text-muted">Company: <span id="homeCompany">‚Äî</span></div>
        </div>
        <span class="pill" id="rolePill">User</span>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-6 col-lg-4">
          <button class="btn btn-outline-primary w-100 card-btn" onclick="go('pageStartTrip')">üöç Start Trip</button>
        </div>
        <div class="col-6 col-lg-4">
          <button class="btn btn-outline-primary w-100 card-btn" onclick="go('pageLocations')">üìç Locations</button>
        </div>
        <div class="col-6 col-lg-4">
          <button class="btn btn-outline-primary w-100 card-btn" onclick="go('pageTripSetup')">üõ† Trip Setup</button>
        </div>
        <div class="col-6 col-lg-4">
          <button class="btn btn-outline-primary w-100 card-btn" onclick="go('pageCompany')">üè¢ Company Info</button>
        </div>
        <div class="col-6 col-lg-4">
          <button class="btn btn-outline-primary w-100 card-btn" onclick="go('pageReports')">üìä Reports</button>
        </div>
        <div class="col-6 col-lg-4 adminOnly" style="display:none">
          <button class="btn btn-danger w-100 card-btn" onclick="go('pageAdmin')">‚öô Admin Panel</button>
        </div>
      </div>
    </div>
    <div class="footer-gap"></div>
  </section>

  <!-- COMPANY INFO -->
  <section class="page" id="pageCompany">
    <div class="container">
      <h4>Company Information</h4>
      <div class="row g-3 mt-1">
        <div class="col-12 col-lg-6">
          <label class="form-label">Company Name</label>
          <input class="form-control" id="companyNameInp" placeholder="Enter company name">
        </div>
        <div class="col-12 col-lg-6">
          <label class="form-label">Company Logo URL</label>
          <input class="form-control" id="companyLogoInp" placeholder="https://‚Ä¶">
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-success" onclick="saveCompany()">Save</button>
        <button class="btn btn-secondary" onclick="go('pageHome')">Back</button>
      </div>

      <hr class="my-4"/>
      <h5>Registered Users</h5>
      <div class="d-flex gap-2 mt-2">
        <input class="form-control" id="newUserName" placeholder="New user name">
        <button class="btn btn-outline-primary" onclick="addUser()">Add</button>
      </div>
      <ul class="list-group mt-3" id="userList"></ul>
    </div>
  </section>

  <!-- LOCATIONS (with Leaflet picker) -->
  <section class="page" id="pageLocations">
    <div class="container">
      <h4>Locations</h4>
      <div class="mapbox mt-2" id="locMap"></div>
      <div class="row g-2 mt-2">
        <div class="col-12 col-md-6">
          <label class="form-label">Location Name</label>
          <input class="form-control" id="locName" placeholder="e.g., Rajkot Bus Stand">
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Latitude</label>
          <input class="form-control" id="locLat" placeholder="lat">
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Longitude</label>
          <input class="form-control" id="locLng" placeholder="lng">
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Radius (m)</label>
          <select class="form-select" id="locRadius">
            <option>100</option><option>200</option><option>300</option>
            <option selected>500</option><option>1000</option>
          </select>
        </div>
        <div class="col-12 col-md-9">
          <label class="form-label">Announcement Message (optional)</label>
          <input class="form-control" id="locMsg" placeholder="Custom message for this stop">
        </div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-primary" onclick="useCurrentGPS()">Use Current GPS</button>
        <button class="btn btn-success" onclick="addLocation()">Add Location</button>
        <button class="btn btn-secondary" onclick="go('pageHome')">Back</button>
      </div>

      <h5 class="mt-4">Saved Locations</h5>
      <ul class="list-group" id="locationList"></ul>
    </div>
  </section>

  <!-- TRIP SETUP -->
  <section class="page" id="pageTripSetup">
    <div class="container">
      <h4>Trip Setup</h4>
      <div class="row g-2 mt-1">
        <div class="col-12 col-md-6">
          <label class="form-label">Trip Name</label>
          <input class="form-control" id="tripName" placeholder="Porbandar ‚Äì Junagadh Express">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Select Locations (multi)</label>
          <select class="form-select" id="tripLocations" multiple size="6"></select>
        </div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-success" onclick="addTrip()">Save Trip</button>
        <button class="btn btn-secondary" onclick="go('pageHome')">Back</button>
      </div>
      <h5 class="mt-4">Saved Trips</h5>
      <ul class="list-group" id="tripList"></ul>
    </div>
  </section>

  <!-- START TRIP -->
  <section class="page" id="pageStartTrip">
    <div class="container">
      <h4>Start Trip</h4>
      <div id="startTripList"></div>

      <hr class="my-3"/>
      <div id="activeTripPane" style="display:none">
        <h5 id="activeTripTitle">Active Trip</h5>
        <div class="mapbox mt-2" id="runMap"></div>
        <div class="row g-2 mt-2">
          <div class="col-6">
            <div class="card p-2">
              <div class="small text-muted">Latitude</div>
              <div id="curLat">‚Äî</div>
            </div>
          </div>
          <div class="col-6">
            <div class="card p-2">
              <div class="small text-muted">Longitude</div>
              <div id="curLng">‚Äî</div>
            </div>
          </div>
          <div class="col-12">
            <div class="card p-2">
              <div class="small text-muted">Upcoming Stop</div>
              <div id="upcomingStop">‚Äî</div>
              <div class="small text-muted">Distance to Next</div>
              <div id="distToNext">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-primary" id="btnStartGPS" onclick="startGPS()">Start GPS</button>
          <button class="btn btn-outline-secondary" onclick="speak('Manual announcement')">üîä Announce</button>
          <div class="ms-auto d-flex align-items-center gap-2">
            <label class="form-label m-0 small">Volume</label>
            <input type="range" min="0" max="1" step="0.1" id="volSlider" value="1" oninput="setVolume(this.value)" />
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-success" onclick="markReached()">Mark Reached</button>
          <button class="btn btn-danger" onclick="endTrip()">End Trip</button>
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-secondary" onclick="go('pageHome')">Back</button>
      </div>
    </div>
  </section>

  <!-- REPORTS -->
  <section class="page" id="pageReports">
    <div class="container">
      <h4>Reports</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="exportTripsExcel()">Export Trip Reports (Excel)</button>
        <button class="btn btn-outline-primary" onclick="exportLoginsExcel()">Export Login Logs (Excel)</button>
        <button class="btn btn-secondary" onclick="go('pageHome')">Back</button>
      </div>
      <h5 class="mt-4">Trip History</h5>
      <ul class="list-group" id="reportList"></ul>
    </div>
  </section>

  <!-- ADMIN PANEL -->
  <section class="page" id="pageAdmin">
    <div class="container">
      <h4>Admin Panel</h4>
      <div class="row g-2">
        <div class="col-12 col-lg-6">
          <div class="card p-3">
            <h6>Create New Company</h6>
            <input class="form-control mb-2" id="adminCompanyName" placeholder="Company Name">
            <button class="btn btn-success" onclick="adminCreateCompany()">Create Company</button>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card p-3">
            <h6>Add User to Company</h6>
            <input class="form-control mb-2" id="adminUserName" placeholder="User Name">
            <button class="btn btn-primary" onclick="adminAddUser()">Add User</button>
          </div>
        </div>
      </div>

      <h5 class="mt-4">Login Analytics</h5>
      <ul class="list-group" id="adminLoginList"></ul>

      <div class="mt-3">
        <button class="btn btn-secondary" onclick="go('pageHome')">Back</button>
      </div>
    </div>
  </section>

  <script>
    /* =========================
       STORAGE & STATE
       ========================= */
    const LS = {
      get(k, def){ try { return JSON.parse(localStorage.getItem(k)) ?? def; } catch { return def; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    };

    // App data keys
    const K = {
      COMPANY: 'bm_company',
      USERS: 'bm_users',
      LOCS: 'bm_locations',
      TRIPS: 'bm_trips',
      RUNS: 'bm_runs',         // completed trip runs (reports)
      LOGINS: 'bm_logins',     // login logs for admin
      SESSION: 'bm_session'    // {user, role}
    };

    // default data
    if(!LS.get(K.USERS)) LS.set(K.USERS, []);
    if(!LS.get(K.LOCS)) LS.set(K.LOCS, []);
    if(!LS.get(K.TRIPS)) LS.set(K.TRIPS, []);
    if(!LS.get(K.RUNS)) LS.set(K.RUNS, []);
    if(!LS.get(K.LOGINS)) LS.set(K.LOGINS, []);

    let runWatchId = null;       // geolocation watch id
    let runMap, runMarkers = [], runPolyline;
    let locMap, locPickerMarker = null, locCircle = null;

    // active trip runtime
    const runtime = {
      active: null,   // {name, locs:[{name,lat,lng,radius,msg}], startedAt, reached:[...], idx}
      ttsVolume: 1
    };

    /* =========================
       NAVIGATION
       ========================= */
    function go(id){
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      if(id==='pageLocations') setTimeout(initLocMap, 50);
      if(id==='pageStartTrip') { renderStartTripList(); setTimeout(initRunMap, 50); }
      if(id==='pageReports') renderReports();
      if(id==='pageAdmin') renderAdmin();
      if(id==='pageCompany') loadCompanyForm();
      if(id==='pageTripSetup') { renderTripLocationsSelect(); renderTripList(); }
    }

    function logout(){
      LS.set(K.SESSION, null);
      document.getElementById('btnLogout').style.display='none';
      document.getElementById('topUser').textContent='';
      go('pageLogin');
    }

    /* =========================
       LOGIN
       ========================= */
    function handleLogin(){
      const u = document.getElementById('loginUser').value.trim() || 'operator';
      const role = (u.toLowerCase()==='admin') ? 'Admin' : 'User';

      LS.set(K.SESSION, { user: u, role });
      document.getElementById('btnLogout').style.display='inline-block';
      document.getElementById('topUser').textContent = u;
      document.getElementById('welcomeUser').textContent = u;
      document.getElementById('rolePill').textContent = role;

      // show/hide admin tile
      document.querySelectorAll('.adminOnly').forEach(el => el.style.display = (role==='Admin'?'block':'none'));

      // company header
      const company = LS.get(K.COMPANY, {name:'BusMate', logo:''});
      document.getElementById('topCompany').textContent = company.name || 'BusMate';
      document.getElementById('homeCompany').textContent = company.name || '‚Äî';

      // track login
      const logs = LS.get(K.LOGINS, []);
      logs.push({
        user: u,
        role,
        time: new Date().toISOString(),
        device: navigator.userAgent
      });
      LS.set(K.LOGINS, logs);

      go('pageHome');
    }

    /* =========================
       COMPANY INFO + USERS
       ========================= */
    function loadCompanyForm(){
      const c = LS.get(K.COMPANY, {name:'',logo:''});
      document.getElementById('companyNameInp').value = c.name || '';
      document.getElementById('companyLogoInp').value = c.logo || '';
      renderUserList();
    }

    function saveCompany(){
      const name = document.getElementById('companyNameInp').value.trim();
      const logo = document.getElementById('companyLogoInp').value.trim();
      LS.set(K.COMPANY, {name, logo});
      document.getElementById('topCompany').textContent = name || 'BusMate';
      document.getElementById('homeCompany').textContent = name || '‚Äî';
      alert('Company info saved');
    }

    function renderUserList(){
      const users = LS.get(K.USERS, []);
      const ul = document.getElementById('userList');
      ul.innerHTML = '';
      users.forEach((u,idx)=>{
        const li = document.createElement('li');
        li.className='list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<span>${u}</span>
                        <div>
                          <button class="btn btn-sm btn-outline-secondary me-2" onclick="renameUser(${idx})">Edit</button>
                          <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${idx})">Delete</button>
                        </div>`;
        ul.appendChild(li);
      });
    }
    function addUser(){
      const v = document.getElementById('newUserName').value.trim();
      if(!v) return;
      const users = LS.get(K.USERS, []);
      users.push(v);
      LS.set(K.USERS, users);
      document.getElementById('newUserName').value='';
      renderUserList();
    }
    function renameUser(i){
      const users = LS.get(K.USERS, []);
      const nv = prompt('Rename user', users[i]);
      if(nv){ users[i]=nv; LS.set(K.USERS, users); renderUserList(); }
    }
    function deleteUser(i){
      const users = LS.get(K.USERS, []);
      users.splice(i,1);
      LS.set(K.USERS, users);
      renderUserList();
    }

    /* =========================
       LOCATIONS + MAP PICKER (Leaflet)
       ========================= */
    function initLocMap(){
      if(locMap) { locMap.invalidateSize(); return; }
      locMap = L.map('locMap');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'¬© OpenStreetMap'
      }).addTo(locMap);
      locMap.setView([21.6417, 69.6293], 8); // Saurashtra default

      locMap.on('click', (e)=>{
        const {lat,lng} = e.latlng;
        setPicker(lat,lng);
      });

      // Try fit to current GPS
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          locMap.setView([pos.coords.latitude,pos.coords.longitude], 13);
        }, ()=>{});
      }
      renderLocationList();
      renderTripLocationsSelect();
    }

    function setPicker(lat,lng){
      document.getElementById('locLat').value = lat.toFixed(6);
      document.getElementById('locLng').value = lng.toFixed(6);
      const r = parseInt(document.getElementById('locRadius').value||500,10);

      if(!locPickerMarker){
        locPickerMarker = L.marker([lat,lng],{draggable:true}).addTo(locMap);
        locPickerMarker.on('dragend', (e)=>{
          const p = e.target.getLatLng();
          document.getElementById('locLat').value = p.lat.toFixed(6);
          document.getElementById('locLng').value = p.lng.toFixed(6);
          drawLocCircle(p.lat,p.lng);
        });
      }else{
        locPickerMarker.setLatLng([lat,lng]);
      }
      drawLocCircle(lat,lng,r);
    }

    function drawLocCircle(lat,lng,r){
      const radius = parseInt(document.getElementById('locRadius').value || r || 500,10);
      if(locCircle) locMap.removeLayer(locCircle);
      locCircle = L.circle([lat,lng], {radius: radius, fillOpacity:.1}).addTo(locMap);
    }

    function useCurrentGPS(){
      if(!navigator.geolocation) return alert('Geolocation not available');
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        locMap.setView([lat,lng], 16);
        setPicker(lat,lng);
      }, err=> alert('Unable to fetch GPS: '+err.message));
    }

    function addLocation(){
      const name = document.getElementById('locName').value.trim();
      const lat  = parseFloat(document.getElementById('locLat').value);
      const lng  = parseFloat(document.getElementById('locLng').value);
      const radius = parseInt(document.getElementById('locRadius').value,10)||500;
      const msg  = (document.getElementById('locMsg').value||'').trim();
      if(!name || isNaN(lat) || isNaN(lng)) return alert('Please provide name and lat/lng');

      const locs = LS.get(K.LOCS, []);
      locs.push({name, lat, lng, radius, msg});
      LS.set(K.LOCS, locs);

      // reset
      document.getElementById('locName').value='';
      document.getElementById('locMsg').value='';

      renderLocationList();
      renderTripLocationsSelect();
      alert('Location added');
    }

    function renderLocationList(){
      const ul = document.getElementById('locationList');
      ul.innerHTML = '';
      const locs = LS.get(K.LOCS, []);
      locs.forEach((l, i)=>{
        const li = document.createElement('li');
        li.className='list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div>
            <div class="fw-semibold">${l.name}</div>
            <div class="list-mini">Lat: ${l.lat.toFixed(6)}, Lng: ${l.lng.toFixed(6)} ¬∑ Radius: ${l.radius}m</div>
            ${l.msg ? `<div class="list-mini">Msg: ${l.msg}</div>`:''}
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="editLocation(${i})">Edit</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteLocation(${i})">Delete</button>
          </div>`;
        ul.appendChild(li);
      });
    }

    function editLocation(i){
      const locs = LS.get(K.LOCS, []);
      const l = locs[i];
      document.getElementById('locName').value = l.name;
      document.getElementById('locLat').value  = l.lat;
      document.getElementById('locLng').value  = l.lng;
      document.getElementById('locRadius').value = l.radius;
      document.getElementById('locMsg').value = l.msg || '';
      setPicker(l.lat, l.lng);
      // Convert add to save
      locs.splice(i,1);
      LS.set(K.LOCS, locs);
      renderLocationList();
    }

    function deleteLocation(i){
      const locs = LS.get(K.LOCS, []);
      locs.splice(i,1);
      LS.set(K.LOCS, locs);
      renderLocationList();
      renderTripLocationsSelect();
    }

    document.getElementById('locRadius').addEventListener('change', ()=>{
      const lat = parseFloat(document.getElementById('locLat').value);
      const lng = parseFloat(document.getElementById('locLng').value);
      if(!isNaN(lat)&&!isNaN(lng)) drawLocCircle(lat,lng);
    });

    /* =========================
       TRIPS
       ========================= */
    function renderTripLocationsSelect(){
      const sel = document.getElementById('tripLocations');
      sel.innerHTML='';
      const locs = LS.get(K.LOCS, []);
      locs.forEach((l, idx)=>{
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = `${l.name} (${l.radius}m)`;
        sel.appendChild(opt);
      });
    }

    function addTrip(){
      const name = document.getElementById('tripName').value.trim();
      if(!name) return alert('Trip name is required');
      const sel = document.getElementById('tripLocations');
      const idxs = Array.from(sel.selectedOptions).map(o=>parseInt(o.value,10));
      if(idxs.length<2) return alert('Select at least 2 locations (start & destination)');

      const locs = LS.get(K.LOCS, []);
      const chosen = idxs.map(i=>locs[i]);

      const trips = LS.get(K.TRIPS, []);
      trips.push({name, locs:chosen});
      LS.set(K.TRIPS, trips);

      document.getElementById('tripName').value='';
      renderTripList();
      alert('Trip saved');
    }

    function renderTripList(){
      const ul = document.getElementById('tripList');
      ul.innerHTML = '';
      const trips = LS.get(K.TRIPS, []);
      trips.forEach((t,i)=>{
        const li = document.createElement('li');
        li.className='list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div>
            <div class="fw-semibold">${t.name}</div>
            <div class="list-mini">${t.locs.map(x=>x.name).join(' ‚Üí ')}</div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="startTrip(${i})">Start</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="editTrip(${i})">Edit</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteTrip(${i})">Delete</button>
          </div>`;
        ul.appendChild(li);
      });
    }

    function editTrip(i){
      const trips = LS.get(K.TRIPS, []);
      const t = trips[i];
      document.getElementById('tripName').value = t.name;
      // Preselect (simple approach: clear & re-add)
      renderTripLocationsSelect();
      const locs = LS.get(K.LOCS, []);
      const sel = document.getElementById('tripLocations');
      for(let o of sel.options){
        if(t.locs.find(x=>x.name===locs[o.value].name)) o.selected=true;
      }
      trips.splice(i,1);
      LS.set(K.TRIPS, trips);
      renderTripList();
      go('pageTripSetup');
    }

    function deleteTrip(i){
      const trips = LS.get(K.TRIPS, []);
      trips.splice(i,1);
      LS.set(K.TRIPS, trips);
      renderTripList();
      renderStartTripList();
    }

    /* =========================
       START TRIP + LIVE MAP
       ========================= */
    function renderStartTripList(){
      const wrap = document.getElementById('startTripList');
      wrap.innerHTML = '';
      const trips = LS.get(K.TRIPS, []);
      if(trips.length===0){
        wrap.innerHTML = `<div class="alert alert-info mt-2">No trips yet. Add in Trip Setup.</div>`;
        return;
      }
      const list = document.createElement('ul');
      list.className='list-group';
      trips.forEach((t,i)=>{
        const li = document.createElement('li');
        li.className='list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div>
            <div class="fw-semibold">${t.name}</div>
            <div class="list-mini">${t.locs.map(x=>x.name).join(' ‚Üí ')}</div>
          </div>
          <button class="btn btn-sm btn-primary" onclick="startTrip(${i})">Start</button>`;
        list.appendChild(li);
      });
      wrap.appendChild(list);
    }

    function initRunMap(){
      if(runMap) { runMap.invalidateSize(); return; }
      runMap = L.map('runMap');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap' }).addTo(runMap);
      runMap.setView([21.6417, 69.6293], 8);
    }

    function startTrip(i){
      const trips = LS.get(K.TRIPS, []);
      const t = trips[i];
      runtime.active = {
        name: t.name,
        locs: JSON.parse(JSON.stringify(t.locs)),
        startedAt: new Date().toISOString(),
        reached: [],
        idx: 0
      };
      document.getElementById('activeTripPane').style.display='block';
      document.getElementById('activeTripTitle').textContent = `Active Trip: ${t.name}`;
      document.getElementById('upcomingStop').textContent = t.locs[0].name;

      // Draw markers/polyline
      if(!runMap) initRunMap();
      runMarkers.forEach(m=>runMap.removeLayer(m)); runMarkers=[];
      if(runPolyline) runMap.removeLayer(runPolyline);

      const latlngs = t.locs.map(l=>[l.lat,l.lng]);
      runPolyline = L.polyline(latlngs).addTo(runMap);
      t.locs.forEach((l,idx)=>{
        const m = L.marker([l.lat,l.lng]).addTo(runMap).bindPopup(`${idx+1}. ${l.name}`);
        runMarkers.push(m);
      });
      runMap.fitBounds(runPolyline.getBounds(), {padding:[20,20]});
      go('pageStartTrip');
    }

    function startGPS(){
      if(!navigator.geolocation) return alert('Geolocation not supported');
      if(runWatchId!==null) return; // already running

      runWatchId = navigator.geolocation.watchPosition(pos=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        document.getElementById('curLat').textContent = lat.toFixed(6);
        document.getElementById('curLng').textContent = lng.toFixed(6);

        // Pan/marker for live location
        if(!runtime.meMarker){
          runtime.meMarker = L.marker([lat,lng], {title:'You'}).addTo(runMap);
        }else{
          runtime.meMarker.setLatLng([lat,lng]);
        }
        runMap.panTo([lat,lng], {animate:true, duration:.3});

        updateUpcomingAndCheck(lat,lng);
      }, err=>{
        alert('GPS error: '+err.message);
      }, { enableHighAccuracy:true, maximumAge:1000 });
    }

    function updateUpcomingAndCheck(lat,lng){
      const trip = runtime.active;
      if(!trip) return;
      if(trip.idx >= trip.locs.length) return;

      const next = trip.locs[trip.idx];
      const d = haversine(lat,lng,next.lat,next.lng);
      document.getElementById('upcomingStop').textContent = next.name;
      document.getElementById('distToNext').textContent = d.toFixed(0)+' m';

      const preRadius = Math.max(100, next.radius);      // pre‚Äëannounce at radius
      const arrRadius = Math.max(50, Math.round(next.radius/2));  // arrival at half

      if(!next._pre && d <= preRadius){
        speak(next.msg || `Next stop: ${next.name}`);
        next._pre = true;
      }
      if(!next._arr && d <= arrRadius){
        speak(`Arrived: ${next.name}`);
        next._arr = true;
        runtime.active.reached.push({ name: next.name, time: new Date().toISOString() });
        trip.idx++;
        // update to following stop
        if(trip.idx < trip.locs.length){
          document.getElementById('upcomingStop').textContent = trip.locs[trip.idx].name;
        } else {
          speak('Destination reached. Trip complete.');
        }
      }
    }

    function markReached(){
      const trip = runtime.active;
      if(!trip) return;
      if(trip.idx >= trip.locs.length) return;
      const next = trip.locs[trip.idx];
      next._pre = true; next._arr = true;
      runtime.active.reached.push({ name: next.name, time: new Date().toISOString() });
      trip.idx++;
      if(trip.idx < trip.locs.length){
        document.getElementById('upcomingStop').textContent = trip.locs[trip.idx].name;
      } else {
        speak('Destination reached. Trip complete.');
      }
    }

    function endTrip(){
      if(!runtime.active) return;
      const endedAt = new Date().toISOString();
      const run = {
        tripName: runtime.active.name,
        startedAt: runtime.active.startedAt,
        endedAt,
        durationMin: Math.round((new Date(endedAt)-new Date(runtime.active.startedAt))/60000),
        reached: runtime.active.reached
      };
      const runs = LS.get(K.RUNS, []);
      runs.push(run);
      LS.set(K.RUNS, runs);

      // cleanup
      if(runWatchId!==null){ navigator.geolocation.clearWatch(runWatchId); runWatchId=null; }
      if(runtime.meMarker){ runMap.removeLayer(runtime.meMarker); runtime.meMarker=null; }
      runtime.active = null;
      document.getElementById('activeTripPane').style.display='none';
      renderReports();
      alert('Trip ended and saved to reports');
    }

    /* =========================
       REPORTS + EXPORT
       ========================= */
    function renderReports(){
      const ul = document.getElementById('reportList');
      ul.innerHTML='';
      const runs = LS.get(K.RUNS, []);
      if(runs.length===0){
        ul.innerHTML = `<li class="list-group-item">No trip reports yet.</li>`;
        return;
      }
      runs.slice().reverse().forEach(r=>{
        const li = document.createElement('li');
        li.className='list-group-item';
        li.innerHTML = `
          <div class="fw-semibold">${r.tripName}</div>
          <div class="list-mini">Start: ${fmt(r.startedAt)} | End: ${fmt(r.endedAt)} | Duration: ${r.durationMin} min</div>
          <div class="list-mini">Stops: ${r.reached.map(x=>x.name+' ('+fmt(x.time)+')').join(', ') || '‚Äî'}</div>`;
        ul.appendChild(li);
      });
    }

    function exportTripsExcel(){
      const runs = LS.get(K.RUNS, []);
      const rows = [];
      runs.forEach(r=>{
        rows.push({Trip:r.tripName, StartedAt:r.startedAt, EndedAt:r.endedAt, DurationMin:r.durationMin});
        r.reached.forEach(s=>{
          rows.push({Trip:r.tripName, StopReached:s.name, ReachedAt:s.time});
        });
      });
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'TripReports');
      XLSX.writeFile(wb, 'trip_reports.xlsx');
    }

    function exportLoginsExcel(){
      const logs = LS.get(K.LOGINS, []);
      const ws = XLSX.utils.json_to_sheet(logs);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'LoginLogs');
      XLSX.writeFile(wb, 'login_logs.xlsx');
    }

    /* =========================
       ADMIN
       ========================= */
    function renderAdmin(){
      const list = document.getElementById('adminLoginList');
      list.innerHTML='';
      const logs = LS.get(K.LOGINS, []);
      if(logs.length===0){
        list.innerHTML = `<li class="list-group-item">No login data</li>`;
        return;
      }
      // aggregate by user
      const agg = {};
      logs.forEach(l=>{
        agg[l.user] = agg[l.user] || {count:0, devices:new Set()};
        agg[l.user].count++;
        agg[l.user].devices.add(l.device);
      });
      Object.entries(agg).forEach(([user,info])=>{
        const li = document.createElement('li');
        li.className='list-group-item';
        li.innerHTML = `<div class="fw-semibold">${user}</div>
                        <div class="list-mini">Logins: ${info.count}</div>
                        <div class="list-mini">Devices: ${Array.from(info.devices).map(d=>d.slice(0,80)).join(' | ')}</div>`;
        list.appendChild(li);
      });
    }

    function adminCreateCompany(){
      const n = (document.getElementById('adminCompanyName').value||'').trim();
      if(!n) return alert('Enter company name');
      LS.set(K.COMPANY, {name:n, logo:''});
      document.getElementById('topCompany').textContent=n;
      document.getElementById('homeCompany').textContent=n;
      alert('Company created/updated');
    }

    function adminAddUser(){
      const u = (document.getElementById('adminUserName').value||'').trim();
      if(!u) return alert('Enter user name');
      const users = LS.get(K.USERS, []);
      users.push(u);
      LS.set(K.USERS, users);
      alert('User added to company');
    }

    /* =========================
       UTILITIES
       ========================= */
    function haversine(lat1, lon1, lat2, lon2){
      const toRad = (v)=>v*Math.PI/180;
      const R = 6371000;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c; // meters
    }
    function fmt(iso){ try { return new Date(iso).toLocaleString(); } catch { return iso; } }

    function speak(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.volume = runtime.ttsVolume;
        speechSynthesis.speak(u);
      }catch(e){}
    }
    function setVolume(v){
      runtime.ttsVolume = Number(v);
    }

    // Boot: restore session if any
    (function boot(){
      const s = LS.get(K.SESSION, null);
      if(s){
        document.getElementById('btnLogout').style.display='inline-block';
        document.getElementById('topUser').textContent = s.user;
        document.getElementById('welcomeUser').textContent = s.user;
        document.getElementById('rolePill').textContent = s.role;
        document.querySelectorAll('.adminOnly').forEach(el => el.style.display = (s.role==='Admin'?'block':'none'));
        const company = LS.get(K.COMPANY, {name:'BusMate'});
        document.getElementById('topCompany').textContent = company.name || 'BusMate';
        document.getElementById('homeCompany').textContent = company.name || '‚Äî';
        go('pageHome');
      } else {
        go('pageLogin');
      }
    })();
  </script>

</body>
</html>
