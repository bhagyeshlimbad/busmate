<!--
====================================================================================
üöå BUSMATE WEB APPLICATION 
====================================================================================
Version: Final Production Build
Author: Bhagyesh Limbad

üîß Functional Summary:
- Full Supabase integration (no localStorage)
- User management with plain-text passwords
- Role-based UI (Admin / Operator / Driver)
- Company logo, trips, and locations management
- Audio announcements with signed URLs (1000 days)
- Prevents overlapping and multiple audio triggers
- Nearest-location detection (handles skipped stops)
- Wake Lock API for background operation
- Live Trips map with bus icons (auto-refresh)
- Editable locations (updates in real-time)
- Map display fix for desktop/tablet
- Password update widget
- Toast notifications and global onclick handlers
- Dynamic ETA and distance display
- Automatic trip correction on skipped stops
- Zero database persistence for live-trip overlay

ü™≤ Added Fix (Oct 2025):
- Trip now always fetches the latest location data (radius, name, lat/lng)
  from Supabase at trip start. Updates reflected without re-creating the trip.

====================================================================================
-->
<!DOCTYPE html>

<html lang="en">
<head>
<style>
/* --- Hide debug toggle button completely for production --- */
#debugToggleBtn {
  display: none !important;
  visibility: hidden !important;
}
</style>
<meta charset="utf-8"/>
<title>BusMate - Test Mode</title>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com">

// --- Announcement: configurable cooldown & single-play guard ---
const ANNOUNCEMENT_COOLDOWN_MS = 10000; // <-- edit this value (milliseconds)

let _lastAnnouncedId = null;
let _lastAnnouncedAt = 0;
let _currentAudio = null;

function markLocationArrived(locId){
  try{
    if(!runtime || !runtime.active || !Array.isArray(runtime.active.locs)) return;
    const idx = runtime.active.locs.findIndex(l => l.id === locId);
    if(idx === -1) return;
    const loc = runtime.active.locs[idx];
    // prevent repeated visual update
    if(loc._arrived) return;
    loc._arrived = true;

    // circle and marker arrays correspond to runtime.active.locs order
    try{
      const circle = (typeof runCircles !== 'undefined' && runCircles[idx]) ? runCircles[idx] : null;
      const marker = (typeof runMarkers !== 'undefined' && runMarkers[idx]) ? runMarkers[idx] : null;
      if(circle && typeof circle.setStyle === 'function'){
        circle.setStyle({ color:'#16a34a', fillColor:'#16a34a' });
      }
      // add emoji overlay marker if not added
      if(!loc._emojiMarker && typeof L !== 'undefined' && typeof runMap !== 'undefined'){
        const icon = L.divIcon({ className:'emoji-marker', html:'<div style=\"font-size:20px;line-height:20px\">‚úÖ</div>', iconSize:[24,24], iconAnchor:[12,12] });
        try{
          const em = L.marker([loc.lat, loc.lng], { icon }).addTo(runMap);
          loc._emojiMarker = em;
        }catch(e){ console.error('emoji add failed', e); }
      }
      // append "‚úÖ Arrived" to popup content (idempotent)
      if(marker && typeof marker.bindPopup === 'function'){
        try{
          const prev = marker.getPopup ? (marker.getPopup() ? marker.getPopup().getContent() : '') : '';
          if(!/‚úÖ Arrived/.test(prev)){
            const newContent = (prev||'') + '<div class=\"mt-1 font-semibold\">‚úÖ Arrived</div>';
            marker.bindPopup(newContent);
          }
        }catch(e){ console.error('popup update failed', e); }
      }
    }catch(e){ console.error('markLocationArrived inner error', e); }
  }catch(e){ console.error('markLocationArrived error', e); }
}

function playAnnouncementById(locId){
  try{
    const now = Date.now();
    // debounce: prevent same announcement within configured cooldown
    if(_lastAnnouncedId === locId && (now - _lastAnnouncedAt) < ANNOUNCEMENT_COOLDOWN_MS){
      console.log('‚è∏Ô∏è Skipped overlapping announcement for', locId);
      return;
    }
    _lastAnnouncedId = locId;
    _lastAnnouncedAt = now;

    const loc = (runtime && runtime.active && runtime.active.locs) ? runtime.active.locs.find(x=>x.id===locId) : null;
    if(!loc){ console.warn('Location not found for ID:', locId); toast('Location not found'); return; }

    // stop any currently playing audio or TTS
    try{ if(_currentAudio){ _currentAudio.pause(); _currentAudio.src=''; _currentAudio = null; } }catch(e){}
    try{ speechSynthesis.cancel(); }catch(e){}

    console.log('üîä Playing announcement for', loc.name, 'ID:', locId);
    if(loc.audio_url){
      _currentAudio = new Audio(loc.audio_url);
      _currentAudio.volume = (runtime && runtime.ttsVolume) ? runtime.ttsVolume : 1;
      _currentAudio.play().catch(err=>{
        console.error('Audio play failed', err);
        toast('Audio playback error');
        _currentAudio = null;
      });
      _currentAudio.addEventListener('ended', ()=>{
        _currentAudio = null;
      });
    } else {
      const msg = loc.msg || loc.name || 'Announcement';
      const utter = new SpeechSynthesisUtterance(msg);
      utter.volume = (runtime && runtime.ttsVolume) ? runtime.ttsVolume : 1;
      utter.rate = 1;
      utter.pitch = 1;
      utter.onend = function(){ _currentAudio = null; };
      speechSynthesis.speak(utter);
    }

    // Visual: mark as arrived (turn circle green + add ‚úÖ overlay + update popup)
    try{ markLocationArrived(locId); }catch(e){ console.error('markLocationArrived failed', e); }

  }catch(e){
    console.error('playAnnouncementById error', e);
    toast('Announcement failed');
  }
}
window.playAnnouncementById = playAnnouncementById;


window.playAnnouncementFromPopup = function(btn){
  try{
    const hidden = btn.previousElementSibling;
    const id = hidden ? hidden.value : null;
    if(!id){ console.warn('No hidden ID found for playAnnouncement'); toast('Invalid location ID'); return; }
    if(typeof playAnnouncementById === 'function'){
      playAnnouncementById(id);
    } else if(window.playAnnouncementById){
      window.playAnnouncementById(id);
    } else {
      console.error('playAnnouncementById not found');
      toast('Announcement function missing');
    }
  }catch(e){
    console.error('playAnnouncementFromPopup error', e);
  }
};
window.playAnnouncementById = playAnnouncementById;

</script>
<!-- Leaflet -->
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- SheetJS for export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    body{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .mapbox{ width:100%; height:56vh; min-height:280px; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(2,6,23,0.06); }
    @media (min-width:1024px){ .mapbox{ height:48vh; } }
    .list-row{ background:#fff; border-radius:10px; padding:.75rem; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .chip{ background:#eef2ff;color:#3730a3;padding:.2rem .5rem;border-radius:999px;font-size:.75rem; }
    .small-muted{ color:#64748b; font-size:.9rem; }
    .hidden{ display:none!important; }
    .page-back{ margin-bottom:.75rem; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace; }
    .logo-small{ width:36px;height:24px;object-fit:contain;border-radius:4px; }
  </style>
<meta content="no-cache, no-store, must-revalidate" http-equiv="Cache-Control"/>
<meta content="no-cache" http-equiv="Pragma"/>
<meta content="0" http-equiv="Expires"/>
</head>
<body class="bg-slate-50 text-slate-900">
<!-- HEADER -->
<header class="bg-blue-600 text-white sticky top-0 z-40">
<div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
<div class="flex items-center gap-3">
<div class="w-10 h-10 bg-white rounded-md flex items-center justify-center text-blue-600 font-bold" id="logoBox">BM</div>
<div>
<div class="font-semibold" id="companyTitle">BusMate</div>
<div class="text-xs opacity-90" id="companySub">Smart Buddy for Bus Operator</div> <div class="ml-4"><button class="hidden bg-white text-blue-600 px-3 py-1 rounded" id="debugToggleBtn" onclick="toggleDebug()">Enable Debug</button></div>
</div>
</div>
<div class="flex items-center gap-4">
<div class="text-sm" id="roleLabel" style="display: none;"></div>
<div class="text-sm">Welcome,  <span id="userLabel">Guest</span></div>
<button class="hidden bg-white text-blue-600 px-3 py-1 rounded" id="logoutBtn" onclick="logout()">Logout</button>
<button class="ml-2 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm" id="clearCacheBtn" onclick="clearAllCaches(this)">
  Clear Cache
</button>

</div>
</div>
</header>
<main class="max-w-6xl mx-auto p-4 space-y-6">
<!-- LOGIN -->
<section id="pageLogin">
<div class="max-w-md mx-auto bg-white rounded-xl shadow p-6">
<div class="text-center">
<div class="w-14 h-14 rounded-xl bg-blue-600 mx-auto mb-2"></div>
<h2 class="text-2xl font-bold">BusMate</h2>
<p class="text-sm text-slate-500 mt-1">Sign in ‚Äî Master / Admin / Operator</p>
</div>
<div class="mt-6 space-y-3">
<label class="block text-sm">Username</label>
<input class="w-full rounded-lg border px-3 py-2" id="loginUser" placeholder="Enter Your Username"/>
<label class="block text-sm">Password</label>
<input class="w-full rounded-lg border px-3 py-2" id="loginPass" placeholder="Enter Your Password" type="password"/>
<div class="flex gap-2 mt-4">
<button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" id="loginBtn" onclick="handleLogin()">Login</button>
<button class="bg-slate-100 px-4 py-2 rounded hover:bg-slate-200" id="helpBtn" onclick="showHelp()">Help</button>
</div>
<div class="text-xs text-slate-400 mt-3 text-center">Design & Developed by: <a class="underline" href="mailto:bhagyeshlimbad@gmail.com">bhagyeshlimbad@gmail.com</a></div>
</div>
</div>
</section>
<!-- HOME / DASHBOARD -->
<section class="hidden" id="pageHome">
<div class="grid gap-4">
<div class="bg-white rounded-xl shadow p-4 flex items-center justify-between">
<div>
<div class="text-lg font-semibold" id="homeCompanyTitle"></div>
<div class="text-sm text-slate-500" id="homeCompanySub">Dashboard</div>
</div>
<div class="text-right">
<div class="font-medium" id="homeUserLabel"></div>
<div class="text-xs text-slate-200" id="homeRole"></div>
</div>
</div>
<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
<button class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileCompanies" onclick="go('pageMasterAdmin')">
<div class="font-semibold">Company Management</div>
<div class="text-sm text-slate-500">Create / Enable / Disable</div>
</button>
<button class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileUsers" onclick="go('pageUsers')">
<div class="font-semibold">Manage Users</div>
<div class="text-sm text-slate-500">Create / Edit / Assign</div>
</button>
<button class="tile bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileVendors" onclick="go('pageVendors')">
<div class="font-semibold">Manage Assets</div>
<div class="text-sm text-slate-500">Vendors &amp; Vehicles</div>
</button>
<button class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileLocations" onclick="go('pageLocations')">
<div class="font-semibold">Manage Locations</div>
<div class="text-sm text-slate-500">Stops / Radius / Msg</div>
</button>
<button class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileTrips" onclick="go('pageTripSetup')">
<div class="font-semibold">Manage Trips</div>
<div class="text-sm text-slate-500">Create / Order / Save</div>
</button>
<button class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileStart" onclick="go('pageStartTrip')">
<div class="font-semibold">Start Trip</div>
<div class="text-sm text-slate-500">Start &amp; Track</div>
</button>
<button class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileReports" onclick="go('pageReports')">
<div class="font-semibold">Reports</div>
<div class="text-sm text-slate-500">Trip history &amp; logs</div>
</button>
<!-- New Added Tiles -->
<button class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileFuelRequest" onclick="go('pageFuelRequest')">
<div class="font-semibold">Fuel Request</div>
<div class="text-sm text-slate-500">Create / Track</div>
</button>
<button class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileMyRequests" onclick="go('pageMyRequests')">
<div class="font-semibold">My Requests</div>
<div class="text-sm text-slate-500">View Submitted</div>
</button>
<button class="tile hidden bg-white rounded-xl shadow p-4 text-left hover:shadow-md" id="tileFuelApprovals" onclick="go('pageFuelApprovals')">
<div class="font-semibold">Approvals</div>
<div class="text-sm text-slate-500">Review / Approve</div>
</button>
</div>
<div class="bg-white rounded-xl shadow p-4">
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<div><div class="text-sm text-slate-500">Vendors</div><div class="font-semibold" id="statVendors">0</div></div>
<div><div class="text-sm text-slate-500">Vehicles</div><div class="font-semibold" id="statVehicles">0</div></div>
<div><div class="text-sm text-slate-500">Locations</div><div class="font-semibold" id="statLocations">0</div></div>
<div><div class="text-sm text-slate-500">Trips</div><div class="font-semibold" id="statTrips">0</div></div>
<div><div class="text-sm text-slate-500">Companies</div><div class="font-semibold" id="statCompanies">0</div></div>
<div><div class="text-sm text-slate-500">Runs</div><div class="font-semibold" id="statRuns">0</div></div>
</div>
</div>
<!-- Account / Password -->
<div class="bg-white rounded-xl shadow p-4" id="passwordBox">
<div class="flex items-center justify-between">
<div>
<h3 class="font-semibold">My Account</h3>
<div class="text-xs text-slate-500">Change your password</div>
</div>
<div>
<button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded" onclick="openPasswordForm()">Change Password</button>
</div>
</div>
</div>
</div>
</section>
<!-- MASTER ADMIN -->
<section class="hidden" id="pageMasterAdmin">
<div class="bg-white rounded-xl shadow p-4">
<div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button></div>
<div class="flex items-center justify-between">
<h2 class="text-lg font-semibold">Master Admin ‚Äî Companies</h2>
<div>
<button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="openCompanyForm()">Create Company</button>
</div>
</div>
<div class="mt-4"><ul class="space-y-3" id="companyList"></ul></div>
</div>
<div class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40" id="companyModal">
<div class="bg-white p-4 rounded-xl w-96">
<h3 class="font-semibold">Create / Edit Company</h3>
<label class="block mt-2 text-sm">Company Name</label>
<input class="w-full border rounded px-3 py-2" id="companyNameInp"/>
<label class="block mt-2 text-sm">Logo URL (optional)</label>
<input class="w-full border rounded px-3 py-2" id="companyLogoInp"/>
<div class="flex gap-2 mt-3">
<button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="saveCompany()">Save</button>
<button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="closeCompanyModal()">Cancel</button>
</div>
</div>
</div>
</section>
<!-- USERS -->
<section class="hidden" id="pageUsers">
<div class="bg-white rounded-xl shadow p-4">
<div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button></div>
<div class="flex items-center justify-between">
<h2 class="text-lg font-semibold">Users</h2>
<div><button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="openUserForm()">Add User</button></div>
</div>
<div class="mt-4"><ul class="space-y-3" id="usersList"></ul></div>
</div>
<div class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40" id="userModal">
<div class="bg-white p-4 rounded-xl w-96">
<h3 class="font-semibold">Add / Edit User</h3>
<label class="block mt-2 text-sm">Username</label>
<input class="w-full border rounded px-3 py-2" id="userNameInp"/>
<label class="block mt-2 text-sm">Password</label>
<input class="w-full border rounded px-3 py-2" id="userPassInp"/>
<label class="block mt-2 text-sm">Display Name</label>
<input class="w-full border rounded px-3 py-2" id="userDisplayInp"/>
<label class="block mt-2 text-sm">Role</label>
<select class="w-full border rounded px-3 py-2" id="userRoleInp"><option>Admin</option><option>Operator</option></select>
<label class="block mt-2 text-sm">Company</label>
<select class="w-full border rounded px-3 py-2" id="userCompanyInp"></select>
<div class="flex gap-2 mt-3">
<label class="block mt-2 font-semibold">Permissions</label>
<div class="grid grid-cols-2 gap-2 text-sm">
<label><input id="permCompanies" type="checkbox"/> Manage Company</label>
<label><input id="permUsers" type="checkbox"/> Manage Users</label>
<label><input id="permVendors" type="checkbox"/> Vendor / Asset Manage</label>
<label><input id="permLocations" type="checkbox"/> Manage Location</label>
<label><input id="permTrips" type="checkbox"/> Manage Trips</label>
<label><input id="permStart" type="checkbox"/> Start Trip</label>
<label><input id="permDashboard" type="checkbox"/> Dashboard</label>
<label><input id="permReports" type="checkbox"/> Reports</label>
<label><input id="permMyRequests" type="checkbox"/> My Requests</label>
<label><input id="permFuelRequest" type="checkbox"/> Fuel Request</label>
<label><input id="permFuelApprovals" type="checkbox"/> Fuel Approvals</label>
</div>
<button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="saveUser()">Save</button>
<button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="closeUserModal()">Cancel</button>
</div>
</div>
</div>
</section>
<!-- LOCATIONS -->
<section class="hidden" id="pageLocations">
<div class="grid md:grid-cols-2 gap-4">
<div class="bg-white rounded-xl shadow p-4">
<div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button></div>
<h3 class="font-semibold">Add / Edit Location</h3>
<label class="block mt-3 text-sm">Name</label>
<input id="locId" type="hidden"/>
<input class="w-full border rounded px-3 py-2" id="locName"/>
<div class="grid grid-cols-2 gap-2 mt-2">
<div><label class="text-sm">Latitude</label><input class="w-full border rounded px-3 py-2" id="locLat"/></div>
<div><label class="text-sm">Longitude</label><input class="w-full border rounded px-3 py-2" id="locLng"/></div>
</div>
<label class="block mt-2 text-sm">Radius (meters)</label>
<input class="w-full border rounded px-3 py-2" id="locRadius" type="number" value="500"/>
<label class="block mt-2 text-sm">Announcement message</label>
<input class="w-full border rounded px-3 py-2" id="locMsg" placeholder="Custom announcement text (played during trip)"/>
<label class="block mt-2 text-sm">Announcement Audio (optional)</label>
<input accept="audio/*" class="w-full border rounded px-3 py-2" id="locAudio" type="file"/>
<div class="flex gap-2 mt-3">
<button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" onclick="useCurrentGPS()">Use Current GPS</button>
<button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="saveLocation()">Save</button>
<button class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded" onclick="testAnnouncement()">Test Announcement</button>
</div>
</div>
<div class="bg-white rounded-xl shadow p-4">
<h3 class="font-semibold">Map Picker</h3>
<div class="mapbox mt-2" id="locMap"></div>
<h4 class="mt-4">Saved Locations</h4>
<div class="mt-2 space-y-2" id="locationList"></div>
</div>
</div>
</section>
<!-- TRIP SETUP -->
<section class="hidden" id="pageTripSetup">
<div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button></div>
<div class="bg-white rounded-xl shadow p-4">
<h3 class="font-semibold">Manage Trips</h3>
<div class="grid md:grid-cols-3 gap-4 mt-4">
<div>
<label class="text-sm">Trip Name</label>
<input class="w-full border rounded px-3 py-2" id="tripName"/>
<label class="text-sm mt-2">Available Locations</label>
<div class="border rounded mt-2 p-2 h-64 overflow-auto bg-white" id="availList"></div>
</div>
<div class="flex flex-col items-center justify-center gap-2">
<button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="addPlanned()">Add ‚Üí</button>
<button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="removePlanned()">‚Üê Remove</button>
<button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="movePlanned(-1)">‚Üë Up</button>
<button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="movePlanned(1)">‚Üì Down</button>
<button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded" onclick="clearPlanned()">Clear</button>
</div>
<div>
<label class="text-sm">Planned Trip (ordered)</label>
<div class="border rounded mt-2 p-2 h-64 overflow-auto bg-white" id="plannedList"></div>
<div class="flex gap-2 mt-3">
<button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="saveTrip()">Save Trip</button>
</div>
</div>
</div>
<h4 class="mt-4">Saved Trips</h4>
<div class="mt-2 space-y-2" id="tripList"></div>
</div>
</section>
<!-- PASSWORD MODAL (like Manage Trip modal) -->
<div class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40" id="passwordModal">
<div class="bg-white p-4 rounded-xl w-96">
<h3 class="font-semibold">Change Password</h3>
<input class="w-full border rounded px-3 py-2 mt-3" id="newPassModal1" placeholder="New password" type="password"/>
<input class="w-full border rounded px-3 py-2 mt-2" id="newPassModal2" placeholder="Confirm new password" type="password"/>
<div class="flex gap-2 mt-3 justify-end">
<button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="closePasswordModal()">Cancel</button>
<button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="savePassword()">Save</button>
</div>
</div>
</div>
<!-- START TRIP -->
<section class="hidden" id="pageStartTrip">
<div class="bg-white rounded-xl shadow p-4" id="startPanel">
<div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button></div>
<h3 class="font-semibold">Start Trip</h3>
<label class="block mt-3 text-sm">Choose trip</label>
<select class="w-full border rounded px-3 py-2" id="startTripSelect"></select>
<div class="flex gap-2 mt-3">
<button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="startSelectedTrip()">Start Trip</button>
</div>
</div>
<div class="hidden mt-4" id="ongoingPanel">
<!-- BACK BUTTON (INSIDE ONGOING PANEL) -> ALWAYS GO HOME -->
<div class="flex justify-between items-center mb-3">
<div>
<button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back to Home</button>
</div>
<div>
<button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" onclick="endTrip()">End Trip</button>
</div>
</div>
<!-- 
        <div><button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" onclick="endTrip()">End Trip</button></div> -->
</div>
<div>
<div class="mapbox" id="runMap"></div>
</div>
<div class="mt-3 flex items-center justify-between">
<div class="flex items-center gap-3">
<label class="text-sm small-muted">Auto Refresh:</label>
<select class="border rounded px-2 py-1 bg-white" id="autoRefreshSelect" onchange="setAutoRefreshInterval()">
<option value="5">5s</option>
<option selected="" value="10">10s</option>
<option value="15">15s</option>
<option value="20">20s</option>
</select>
<div class="text-sm text-slate-500 ml-2">Device GPS mode</div>
</div>
<div class="flex items-center gap-2">
<button class="bg-white border px-3 py-1 rounded hover:bg-gray-50" onclick="centerCurrentGPS()">Current Location</button>
</div>
</div>
<div class="bg-white rounded-xl shadow p-4 mt-4">
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
<div class="flex flex-wrap gap-2 items-center">
<button class="bg-white border px-3 py-2 rounded shadow hover:bg-gray-50" onclick="centerMap()">Center Map</button>
<div class="flex items-center gap-2 pl-2">
<div class="text-xs small-muted">Volume</div>
<input id="volControl" max="1" min="0" onchange="setVolume(this.value)" step="0.1" type="range" value="1"/>
</div>
</div>
<div class="text-sm text-slate-600">
<div><span class="font-semibold" id="ongoingTripName">‚Äî</span></div>
<div class="text-xs text-slate-400">Started: <span id="ongoingStart">‚Äî</span></div>
</div>
</div>
<hr class="my-3"/>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<div class="text-xs small-muted">Current Latitude / Longitude</div>
<div class="font-mono" id="curLat">‚Äî</div>
<div class="font-mono" id="curLng">‚Äî</div>
<div class="text-xs small-muted mt-2">Current Speed</div>
<div id="curSpeed">‚Äî</div>
</div>
<div>
<div class="text-xs small-muted">Upcoming Stop</div>
<div class="font-semibold" id="upcomingName">‚Äî</div>
<div class="text-xs small-muted mt-2">Distance to Next</div>
<div id="distNext">‚Äî</div>
<div class="text-xs small-muted mt-2">ETA to Next</div>
<div id="etaNext">‚Äî</div>
</div>
<div>
<div class="text-xs small-muted">Progress</div>
<div class="font-semibold" id="progressStops">‚Äî</div>
<div class="w-full bg-slate-100 h-3 rounded mt-2 overflow-hidden">
<div class="bg-blue-600 h-3 rounded" id="progressBar" style="width:0%"></div>
</div>
<div class="text-xs text-slate-500 mt-2">Stops reached / total</div>
</div>
</div>
</div>
</section>
<!-- REPORTS -->
<section class="hidden" id="pageReports">
<div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button></div>
<div class="bg-white rounded-xl shadow p-4">
<div class="flex items-center justify-between">
<h3 class="font-semibold">Reports</h3>
<div>
<button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded" onclick="exportTripsExcel()">Export Trips</button>
<button class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded" onclick="exportLoginsExcel()">Export Logins</button>
</div>
</div>
<h4 class="mt-4">Trip History</h4>
<div class="mt-2 space-y-2" id="reportTrips"></div>
<h4 class="mt-4">Login Activity</h4>
<div class="mt-2 space-y-2" id="reportLogins"></div>
</div>
</section>
<!-- VENDORS & VEHICLES -->
<section class="hidden" id="pageVendors">
<div class="grid md:grid-cols-2 gap-4">
<div class="bg-white rounded-xl shadow p-4">
<div class="page-back"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button></div>
<h3 class="font-semibold">Vendors</h3>
<div class="flex items-center justify-between mt-3">
<div class="text-sm text-slate-500">Create or edit vendors</div>
<div><button class="bg-blue-600 text-white px-3 py-1 rounded" onclick="openVendorForm()">Add Vendor</button></div>
</div>
<div class="mt-4 space-y-3" id="vendorList"></div>
</div>
<div class="bg-white rounded-xl shadow p-4">
<div class="page-back"><h3 class="font-semibold">Vehicles</h3></div>
<div class="flex items-center justify-between mt-1">
<div class="text-sm text-slate-500">Vehicles linked to vendors</div>
<div><button class="bg-blue-600 text-white px-3 py-1 rounded" onclick="openVehicleForm()">Add Vehicle</button></div>
</div>
<div class="mt-4 space-y-3" id="vehicleList"></div>
</div>
</div>
<!-- Vendor Modal -->
<div class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40" id="vendorModal">
<div class="bg-white p-4 rounded-xl w-96">
<h3 class="font-semibold">Add / Edit Vendor</h3>
<input id="vendorId" type="hidden"/>
<label class="block mt-2 text-sm">Vendor Name</label>
<input class="w-full border rounded px-3 py-2" id="vendorName"/>
<label class="block mt-2 text-sm">Notes (optional)</label>
<input class="w-full border rounded px-3 py-2" id="vendorNotes"/>
<div class="flex gap-2 mt-3 justify-end">
<button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="closeVendorModal()">Cancel</button>
<button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="saveVendor()">Save</button>
</div>
</div>
</div>
<!-- Vehicle Modal -->
<div class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40" id="vehicleModal">
<div class="bg-white p-4 rounded-xl w-96">
<h3 class="font-semibold">Add / Edit Vehicle</h3>
<input id="vehicleId" type="hidden"/>
<label class="block mt-2 text-sm">Vehicle Number / Name</label>
<input class="w-full border rounded px-3 py-2" id="vehicleName"/>
<label class="block mt-2 text-sm">Notes (optional)</label>
<input class="w-full border rounded px-3 py-2" id="vehicleNotes"/>
<div class="flex gap-2 mt-3 justify-end">
<button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="closeVehicleModal()">Cancel</button>
<button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="saveVehicle()">Save</button>
</div>
</div>
</div>
</section>
</main>
<!-- toast -->
<div class="hidden fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-2 rounded shadow" id="toast"></div>
<!-- Supabase client import and main logic -->
<script type="module">

// --- Clear any Supabase/IndexedDB/Storage remnants before anything runs ---
try {
  if(window.localStorage) localStorage.clear();
  if(window.sessionStorage) sessionStorage.clear();
  if(window.indexedDB && indexedDB.databases) {
    indexedDB.databases().then(dbs => { dbs.forEach(db => indexedDB.deleteDatabase(db.name)); });
  }
  console.log('üßπ Cleared local/session/IndexedDB caches');
} catch(e) { console.warn('Cache clear failed', e); }

/* Supabase config */
const SUPABASE_URL = 'https://wxulwistfjspubqhidrr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4dWx3aXN0ZmpzcHVicWhpZHJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNzExNDgsImV4cCI6MjA3Mjc0NzE0OH0.y3BVIcjcx17QABUTsSkD3hAgyGhu5evILiKXbrcrBLQ';

/* load supabase-js as ES module */
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: false,
    autoRefreshToken: false,
    storageKey: null
  },
  global: {
    headers: { 'Cache-Control': 'no-store' }
  }
});

window.SB = sb;

/* helpers */
const DEBUG = false;
function logd(...args){ if(window._debugOn) console.debug(...args); }
function toggleDebug(){ window._debugOn = !window._debugOn; const b = document.getElementById("debugToggleBtn"); if(b) b.textContent = window._debugOn? "Disable Debug":"Enable Debug"; try{ b.classList.remove("hidden"); }catch(e){} toast("Debug " + (window._debugOn?"ON":"OFF"),1200); }

const Cache = { _cache:{}, get(key){ return this._cache[key]; }, set(key,val){ this._cache[key]=val; } };
function toast(msg, ms=1600){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), ms); }
function fmtISO(iso){ try{ return new Date(iso).toLocaleString(); }catch(e){ return iso; } }
function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
function haversine(lat1,lon1,lat2,lon2){ const toRad=v=>v*Math.PI/180; const R=6371000; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lon2))*Math.sin(dLon/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; }

/* DB helpers */
async function db_select(table, opts={}) {
  let q = sb.from(table).select('*');
  if(opts.eq) for(const k in opts.eq) q = q.eq(k, opts.eq[k]);
  if(opts.order) q = q.order(opts.order.col, { ascending: opts.order.asc });
  const { data, error } = await q;
  if(error) { console.error('db_select error', table, error); return []; }
  return data || [];
}
async function db_insert(table, records) {
  const { data, error } = await sb.from(table).insert(records).select();
  if(error){ console.error('db_insert error', table, error); throw error; }
  return data;
}
async function db_update(table, updates, match) {
  const { data, error } = await sb.from(table).update(updates).match(match).select();
  if(error){ console.error('db_update error', table, error); throw error; }
  return data;
}
async function db_delete(table, match) {
  const { data, error } = await sb.from(table).delete().match(match).select();
  if(error){ console.error('db_delete error', table, error); throw error; }
  return data;
}

/* Storage helpers: upload & create signed URL (1000 days) */
async function uploadAudioFile(file, destPath){
  if(!file) return null;
  const filename = `${Date.now()}_${file.name.replace(/\s/g,'_')}`;
  const path = `${destPath || 'location_audio'}/${filename}`;
  // upload
  const { error: upErr } = await sb.storage.from('audio').upload(path, file, { cacheControl: '3600', upsert: false });
  if(upErr){ console.error('uploadAudioFile error', upErr); throw upErr; }
  // create signed URL valid ~1000 days
  const expiry = 60 * 60 * 24 * 1000; // seconds = 1000 days
  const { data, error } = await sb.storage.from('audio').createSignedUrl(path, expiry);
  if(error){ console.error('createSignedUrl error', error); return null; }
  return data?.signedUrl || null;
}

/* seed demo */
async function seedDemoIfEmpty(){
  try{
    const comps = await db_select('companies');
    if(comps.length>0) return;
    const [comp] = await db_insert('companies', [{ id: uid('comp'), name:'Demo Transit Co', logo:'', enabled:true }]);
    await db_insert('users', [
      { username:'bhagyesh', pass:'bhagyesh', role:'Master', company_id:null, enabled:true, display_name:'Bhagyesh Limbad' },
      { username:'admin', pass:'admin', role:'Admin', company_id:comp.id, enabled:true, display_name:'Admin' },
      { username:'operator', pass:'operator', role:'Operator', company_id:comp.id, enabled:true, display_name:'Operator 1' }
    ]);
    const locs = [
      { id: uid('loc'), name:'Station A', lat:21.6417, lng:69.6293, radius:500, msg:'Station A ‚Äî please prepare to disembark', audio_url:null, company_id:comp.id },
      { id: uid('loc'), name:'Station B', lat:21.6517, lng:69.6390, radius:400, msg:'Station B ‚Äî doors will open on the left', audio_url:null, company_id:comp.id },
      { id: uid('loc'), name:'Station C', lat:21.6617, lng:69.6490, radius:300, msg:'Station C ‚Äî final stop', audio_url:null, company_id:comp.id }
    ];
    await db_insert('locations', locs);
    await db_insert('trips', [{ id: uid('trip'), name:'Demo Route', locs: locs, company_id:comp.id }]);
    }catch(e){ }
}

/* Authentication */
async function handleLogin(){
  const userInput = (document.getElementById('loginUser').value||'').trim();
  const passInput = (document.getElementById('loginPass').value||'').trim();
  if(!userInput) return alert('Enter username');

  // Master quick-check
  if(userInput.toLowerCase()==='bhagyesh' && passInput==='bhagyesh'){
    const s = { user:'bhagyesh', role:'Master', company_id:null, display_name:'Bhagyesh Limbad', permissions: {
      tileStart:true,tileTrips:true,tileUsers:true,tileReports:true,tileVendors:true,tileCompanies:true,tileDashboard:true,tileLocations:true
    } };
    await saveSessionLocally(s);
    await logLogin(s.user, s.role);
    bootAfterLogin(); 
    return;
  }

  const users = await db_select('users');
  const found = users.find(u => u.username.toLowerCase() === userInput.toLowerCase() && u.pass === passInput);
  if(!found) return alert('Invalid credentials');
  if(found.enabled===false) return alert('User disabled');
  // Include permissions from DB when creating session
  const sess = { user: found.username, role: found.role, company_id: found.company_id || null, display_name: found.display_name || found.username, permissions: found.permissions || {} };
  await saveSessionLocally(sess);
  await logLogin(sess.user, sess.role);
  bootAfterLogin();
}
async function saveSessionLocally(sess){ localStorage.setItem('bm_session', JSON.stringify(sess)); }
function getSessionLocally(){ try{ return JSON.parse(localStorage.getItem('bm_session')); }catch(e){ return null; } }
function clearSessionLocal(){ localStorage.removeItem('bm_session'); }

async function logLogin(user, role){
  try{ await db_insert('logins', [{ user, role, time: new Date().toISOString(), device: navigator.userAgent }]); }catch(e){ }
}

async function logout(){
  clearSessionLocal();
  if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  if(autoRefreshIntervalId!==null){ clearInterval(autoRefreshIntervalId); autoRefreshIntervalId=null; }
  runtime.active=null;
  document.getElementById('pageLogin').classList.remove('hidden');
  document.getElementById('pageHome').classList.add('hidden');
  document.getElementById('logoutBtn').classList.add('hidden');
  document.getElementById('userLabel').textContent = 'Guest';
  document.getElementById('roleLabel').textContent = '';
  toast('Logged out');
}

async function bootAfterLogin(){
  // show debug toggle for owner
  try{ document.getElementById('debugToggleBtn').classList.remove('hidden'); }catch(e){}

  const s = getSessionLocally();
  // permissions are pulled from the saved session (set during login). No DOM reads here.
  if(!s) return;
  document.getElementById('logoutBtn').classList.remove('hidden');
  document.getElementById('userLabel').textContent = s.display_name || s.user;
  document.getElementById('roleLabel').textContent = s.role;
  await applyHeader();
  go('pageHome');

  // Apply per-user page permissions if present
  const perms = s.permissions || {};
  Object.keys(perms).forEach(key => {
    if (perms[key]) {
      const el = document.getElementById(key);
      if (el) el.classList.remove('hidden');
    } else {
      const el = document.getElementById(key);
      if (el) el.classList.add('hidden');
    }
  });

}

/* change password modal functions */
function openPasswordForm(){ document.getElementById('passwordModal').classList.remove('hidden'); document.getElementById('newPassModal1').value=''; document.getElementById('newPassModal2').value=''; }
function closePasswordModal(){ document.getElementById('passwordModal').classList.add('hidden'); }
async function savePassword(){
  const s = getSessionLocally(); if(!s) return alert('Not logged in');
  const p1 = document.getElementById('newPassModal1').value.trim(); const p2 = document.getElementById('newPassModal2').value.trim();
  if(!p1 || !p2) return alert('Enter both fields'); if(p1!==p2) return alert('Passwords do not match');
  try{ await db_update('users', { pass: p1 }, { username: s.user }); closePasswordModal(); toast('Password updated. Please login again.'); logout(); }catch(e){ console.error('savePassword err', e); alert('Could not update password'); }
}

/* applyHeader */
async function applyHeader(){
  const s = getSessionLocally();
  const comps = await db_select('companies');
  const comp = s?.company_id ? comps.find(c=>c.id===s.company_id) : null;
  document.getElementById('companyTitle').textContent = comp?.name || 'BusMate';
  document.getElementById('companySub').textContent = 'Welcomes You ';

  // --- Update company logo in header ---
  const logoBox = document.getElementById('logoBox');
  if (logoBox) {
    if (comp && comp.logo) {
      logoBox.innerHTML = `<img src="${comp.logo}" alt="Logo" style="width:100%;height:100%;object-fit:contain;border-radius:6px;" onerror="this.src='';this.textContent='BM';">`;
    } else {
      logoBox.textContent = 'BM'; // fallback if no logo
    }
  }

  if(!s) return;
  document.getElementById('userLabel').textContent = s.display_name || s.user;
  document.getElementById('roleLabel').textContent = s.role;

  // show tiles based on role
  ['tileCompanies','tileUsers','tileLocations','tileTrips','tileStart','tileReports','tileVendors'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  if(s.user==='bhagyesh' || s.role==='Master'){
    ['tileCompanies','tileUsers','tileLocations','tileTrips','tileStart','tileReports','tileVendors'].forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.remove('hidden'); });
  } else if(s.role==='Admin'){
    ['tileUsers','tileLocations','tileTrips','tileStart','tileReports','tileVendors'].forEach(id=>document.getElementById(id).classList.remove('hidden'));
  } else if(s.role==='Operator'){
    ['tileStart','tileReports','tileVendors'].forEach(id=>document.getElementById(id).classList.remove('hidden'));
  }

  const [locCount, tripCount, compCount, runCount] = await Promise.all([
    db_select('locations').then(d=>d.length).catch(()=>0),
    db_select('trips').then(d=>d.length).catch(()=>0),
    db_select('companies').then(d=>d.length).catch(()=>0),
    db_select('runs').then(d=>d.length).catch(()=>0)
  ]);
  document.getElementById('statLocations').textContent = locCount;
  document.getElementById('statTrips').textContent = tripCount;
  document.getElementById('statCompanies').textContent = compCount;
  document.getElementById('statRuns').textContent = runCount;
}

/* navigation helper with map invalidation */
function go(pageId){
  document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
  const el = document.getElementById(pageId);
  if(el) el.classList.remove('hidden');
  if(pageId==='pageLocations'){ setTimeout(()=>{ initLocMap(); if(locMap) try{ locMap.invalidateSize(); }catch(e){} },80); } // renderLocationList(); removed from line
  if(pageId==='pageTripSetup'){ renderAvailList(); renderPlanned(); renderTripList(); }
  if(pageId==='pageStartTrip'){ renderStartSelect(); setTimeout(()=>{ if(runMap) try{ runMap.invalidateSize(); }catch(e){} },300); }
  if(pageId==='pageReports'){ renderReports(); }
  if(pageId==='pageUsers'){ renderUserList(); }
  if(pageId==='pageMasterAdmin'){ renderCompanyList(); }
  if(pageId==='pageFuelRequest'){ loadFuelRequestForm(); } // its load after open fuel request page
  if(pageId==='pageVendors'){renderVendorList(),renderVehicleList();} // its loads vendor/vehicle in asset
  if(pageId==='pageMyRequests'){loadMyRequests()}
  if (pageId === 'pageFuelApprovals') { renderFuelApprovals(); }

}

/* Company CRUD */
let _editingCompany = null;
async function renderCompanyList(){
  const wrap = document.getElementById('companyList'); wrap.innerHTML='';
  const comps = await db_select('companies');
  if(comps.length===0){ wrap.innerHTML = '<div class="text-sm text-slate-400">No companies</div>'; return; }
  comps.forEach(c=>{
    const div = document.createElement('div'); div.className='flex items-center justify-between';
    div.innerHTML = `<div class="flex items-center gap-3"><img src="${c.logo||''}" class="logo-small" onerror="this.style.display='none'"/><div><div class="font-semibold">${c.name}</div><div class="text-xs text-slate-500">${c.id} ¬∑ ${c.enabled ? 'Enabled' : 'Disabled'}</div></div></div>
      <div class="flex gap-2">
        <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editCompany('${c.id}')">Edit</button>
        <button class="${c.enabled?'bg-yellow-500':'bg-green-600'} text-white px-3 py-1 rounded" onclick="toggleCompany('${c.id}')">${c.enabled ? 'Disable':'Enable'}</button>
        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" onclick="deleteCompany('${c.id}')">Delete</button>
      </div>`;
    wrap.appendChild(div);
  });
}
function openCompanyForm(){ document.getElementById('companyModal').classList.remove('hidden'); document.getElementById('companyNameInp').value=''; document.getElementById('companyLogoInp').value=''; window._editingCompany=null; }
function closeCompanyModal(){ document.getElementById('companyModal').classList.add('hidden'); window._editingCompany=null; }
async function saveCompany(){
  const name=(document.getElementById('companyNameInp').value||'').trim(); const logo=(document.getElementById('companyLogoInp').value||'').trim();
  if(!name) return alert('Company name required');
  try{
    if(window._editingCompany){
      await db_update('companies', { name, logo }, { id: window._editingCompany });
    } else {
      await db_insert('companies', [{ id: uid('comp'), name, logo, enabled:true }]);
    }
    await renderCompanyList();
    closeCompanyModal();
    await applyHeader();
    toast('Company saved');
  }catch(e){ alert('Error saving company'); console.error(e); }
}
async function editCompany(id){
  const comps=await db_select('companies'); const c=comps.find(x=>x.id===id); if(!c) return;
  window._editingCompany=id;
  document.getElementById('companyNameInp').value=c.name; document.getElementById('companyLogoInp').value=c.logo||''; document.getElementById('companyModal').classList.remove('hidden');
}
async function toggleCompany(id){
  try{
    const comps = await db_select('companies'); const idx = comps.findIndex(c=>c.id===id);
    if(idx===-1) return;
    const newVal = !comps[idx].enabled;
    await db_update('companies', { enabled: newVal }, { id });
    await renderCompanyList();
    await applyHeader();
  }catch(e){ }
}
async function deleteCompany(id){
  if(!confirm('Delete company and related data?')) return;
  try{
    await db_delete('companies', { id });
    await db_delete('users', { company_id: id });
    await db_delete('locations', { company_id: id });
    await db_delete('trips', { company_id: id });
    await renderCompanyList(); await renderUserList(); await renderLocationList(); await renderTripList(); toast('Company deleted');
  }catch(e){ console.error('deleteCompany', e); alert('Delete failed'); }
}

/* Users */

const PERM_MAP = {
  permCompanies: 'tileCompanies',
  permUsers: 'tileUsers',
  permVendors: 'tileVendors',
  permLocations: 'tileLocations',
  permTrips: 'tileTrips',
  permStart: 'tileStart',
  permDashboard: 'tileDashboard',
  permReports: 'tileReports',
  permMyRequests: 'tileMyRequests',
  permFuelRequest: 'tileFuelRequest',
  permFuelApprovals: 'tileFuelApprovals'
};


function currentSessionPermissions(){
  const s = getSessionLocally() || {};
  // ensure object shape
  return s.permissions || {};
}

function currentUserCanGrant(permKey){
  const s = getSessionLocally();
  if(!s) return false;
  if(s.user === 'bhagyesh' || s.role === 'Master') return true;
  const perms = s.permissions || {};
  return !!perms[permKey];
}

/* Users */
let _editingUser = null;
async function renderUserList(){
  const wrap = document.getElementById('usersList'); wrap.innerHTML='';
  const s = getSessionLocally();
  const users = await db_select('users');
  const visible = (!s || s.user==='bhagyesh') ? users : users.filter(u=>u.company_id===s.company_id);
  if(visible.length===0){ wrap.innerHTML = '<div class="text-sm text-slate-400">No users</div>'; return; }
  const comps = await db_select('companies');
  visible.forEach(u=>{
    const comp = comps.find(c=>c.id===u.company_id);
    const div = document.createElement('div'); div.className='list-row flex items-center justify-between';
    div.innerHTML = `<div><div class="font-medium">${u.display_name || u.username} <span class="chip">${u.role}</span></div><div class="text-xs text-slate-500">${u.username} ¬∑ ${comp?comp.name:'‚Äî'}</div></div>
      <div class="flex gap-2"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editUser('${u.username}')">Edit</button><button class="bg-yellow-500 px-3 py-1 rounded text-white" onclick="toggleUser('${u.username}')">${u.enabled? 'Disable':'Enable'}</button><button class="bg-red-600 px-3 py-1 rounded text-white" onclick="deleteUser('${u.username}')">Delete</button></div>`;
    wrap.appendChild(div);
  });
}
async function openUserForm(){
  const comps = await db_select('companies'); const sel = document.getElementById('userCompanyInp'); sel.innerHTML=''; comps.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o); });
  _editingUser=null; document.getElementById('userNameInp').value=''; document.getElementById('userPassInp').value=''; document.getElementById('userDisplayInp').value=''; document.getElementById('userRoleInp').value='Operator';
  // initialize permission checkboxes based on current user's permissions
  const curPerms = currentSessionPermissions();
  Object.keys(PERM_MAP).forEach(chkId => {
    const permKey = PERM_MAP[chkId];
    const el = document.getElementById(chkId);
    if(!el) return;
    el.checked = false; // new user default
    if(currentUserCanGrant(permKey)){
      el.disabled = false; el.title='You can grant this permission';
    } else {
      el.disabled = true; el.title='You cannot grant this permission';
    }
  });
  document.getElementById('userModal').classList.remove('hidden');
}
function closeUserModal(){ document.getElementById('userModal').classList.add('hidden'); _editingUser=null; document.getElementById('userNameInp').disabled=false; }
async function saveUser(){
  const username=(document.getElementById('userNameInp').value||'').trim(); const pass=(document.getElementById('userPassInp').value||'').trim(); const display=(document.getElementById('userDisplayInp').value||'').trim(); const role=document.getElementById('userRoleInp').value; const companyId=document.getElementById('userCompanyInp').value||null;
  if(!username||!pass) return alert('Username & password required');
  try{
    const users = await db_select('users');
    // Build permissions object but only allow granting those permissions the current user is allowed to grant
    const permsToSave = {};
    Object.keys(PERM_MAP).forEach(chkId => {
      const permKey = PERM_MAP[chkId];
      const el = document.getElementById(chkId);
      const requested = !!(el && el.checked);
      if(currentUserCanGrant(permKey)){
        permsToSave[permKey] = requested;
      } else {
        // ensure we do not accidentally grant permissions current user doesn't have
        permsToSave[permKey] = false;
      }
    });

    if(_editingUser){
      await db_update('users', { pass, display_name: display, role, company_id: companyId, permissions: permsToSave, enabled:true }, { username: _editingUser });
    } else {
      if(users.find(u=>u.username===username)) return alert('Username exists');
      await db_insert('users', [{ username, pass, role, company_id: companyId, permissions: permsToSave, enabled:true, display_name: display }]);
    }
    closeUserModal(); await renderUserList(); toast('User saved');
  }catch(e){ console.error('saveUser', e); alert('Failed to save'); }
}
async function editUser(username){
  const users = await db_select('users'); const u = users.find(x=>x.username===username); if(!u) return;
  _editingUser=username; document.getElementById('userNameInp').value=u.username; document.getElementById('userNameInp').disabled=true; document.getElementById('userPassInp').value=u.pass; document.getElementById('userDisplayInp').value=u.display_name||''; document.getElementById('userRoleInp').value=u.role;
  const comps=await db_select('companies'); const sel=document.getElementById('userCompanyInp'); sel.innerHTML=''; comps.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; if(c.id===u.company_id) o.selected=true; sel.appendChild(o); });
  // populate permission checkboxes from the loaded user and disable ones current user cannot grant
  const userPerms = u.permissions || {};
  Object.keys(PERM_MAP).forEach(chkId => {
    const permKey = PERM_MAP[chkId];
    const el = document.getElementById(chkId);
    if(!el) return;
    el.checked = !!userPerms[permKey];
    if(currentUserCanGrant(permKey)){
      el.disabled = false; el.title='You can grant this permission';
    } else {
      el.disabled = true; el.title='You cannot grant this permission';
    }
  });
  document.getElementById('userModal').classList.remove('hidden');
}
async function toggleUser(username){
  try{
    const users = await db_select('users'); const u = users.find(x=>x.username===username); if(!u) return;
    await db_update('users', { enabled: !u.enabled }, { username });
    await renderUserList();
  }catch(e){ }
}
async function deleteUser(username){
  if(!confirm('Delete user?')) return; try{ await db_delete('users', { username }); await renderUserList(); toast('User deleted'); }catch(e){ console.error('deleteUser', e); alert('Delete failed'); }
}

/* Locations */
let locMap=null, locMarker=null, locCircle=null;
async function initLocMap(){
  if(locMap){ try{ locMap.invalidateSize(); }catch(e){} return; }
  locMap = L.map('locMap');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap' }).addTo(locMap);
  locMap.setView([21.6417,69.6293], 12);
  locMap.on('click', e=> setPicker(e.latlng.lat, e.latlng.lng));
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=> locMap.setView([p.coords.latitude,p.coords.longitude], 14), ()=>{});
  }
  renderLocationList();
}
function setPicker(lat,lng){
  document.getElementById('locLat').value = lat.toFixed(6);
  document.getElementById('locLng').value = lng.toFixed(6);
  const r = parseInt(document.getElementById('locRadius').value||500,10);
  if(!locMarker){ locMarker = L.marker([lat,lng], { draggable:true }).addTo(locMap); locMarker.on('dragend', e=>{ const p=e.target.getLatLng(); document.getElementById('locLat').value = p.lat.toFixed(6); document.getElementById('locLng').value = p.lng.toFixed(6); drawLocCircle(p.lat,p.lng); }); } else locMarker.setLatLng([lat,lng]);
  drawLocCircle(lat,lng,r);
}
function drawLocCircle(lat,lng){
  const radius = parseInt(document.getElementById('locRadius').value||500,10);
  if(locCircle) locMap.removeLayer(locCircle);
  locCircle = L.circle([lat,lng], { radius, fillOpacity:0.06, color:'#2563eb' }).addTo(locMap);
}
function useCurrentGPS(){
  if(!navigator.geolocation) return alert('Geolocation not available');
  navigator.geolocation.getCurrentPosition(p=>{ locMap.setView([p.coords.latitude,p.coords.longitude],16); setPicker(p.coords.latitude,p.coords.longitude); toast('Picker updated'); }, err=> alert('GPS error: '+err.message), { enableHighAccuracy:true });
}
function testAnnouncement(){ const msg=(document.getElementById('locMsg').value||'Test announcement').trim(); speak(msg); }

async function saveLocation(){
  const idEl = document.getElementById('locId');
  const id = idEl ? idEl.value.trim() : '';
  const name = (document.getElementById('locName').value||'').trim();
  const lat = parseFloat(document.getElementById('locLat').value);
  const lng = parseFloat(document.getElementById('locLng').value);
  const radius = parseInt(document.getElementById('locRadius').value||500,10);
  const msg = (document.getElementById('locMsg').value||'').trim();
  const audioFile = document.getElementById('locAudio') ? document.getElementById('locAudio').files[0] || null : null;

  if(!name || isNaN(lat) || isNaN(lng)){
    return alert('Provide name, lat and lng');
  }
  if(radius<=0) return alert('Radius > 0 required');

  try{
    let audioUrl = null;
    if(audioFile){
      audioUrl = await uploadAudioFile(audioFile, 'location_audio');
    }

    const s = getSessionLocally();
    const companyId = (s && s.user!=='bhagyesh') ? s.company_id : (await db_select('companies'))[0]?.id || null;

    if(id){
      // Update existing location - preserve ID
      await db_update('locations', { name, lat, lng, radius, msg, audio_url: audioUrl, company_id: companyId }, { id });
      } else {
      // Insert with generated id to satisfy NOT NULL constraint on id
      const newId = uid('loc');
      const record = { id: newId, name, lat, lng, radius, msg, audio_url: audioUrl, company_id: companyId, created_at: new Date().toISOString() };
      await db_insert('locations', [record]);
      }

    if(idEl) idEl.value = '';
    // clear form fields (optional)
    document.getElementById('locName').value=''; document.getElementById('locLat').value=''; document.getElementById('locLng').value=''; document.getElementById('locMsg').value=''; if(document.getElementById('locAudio')) document.getElementById('locAudio').value='';
    await renderLocationList(); await renderAvailList(); toast('Location saved');
  }catch(e){
    console.error('saveLocation error', e);
    alert('Failed to save location: ' + (e.message||e));
  }
}

async function renderLocationList(){
  const wrap=document.getElementById('locationList'); wrap.innerHTML=''; // clear before render (fix duplicates)
  const s = getSessionLocally(); const locs = await db_select('locations');
  const comps = await db_select('companies'); const compMap = {}; comps.forEach(c=>compMap[c.id]=c);
  const visible = (!s || s.user==='bhagyesh') ? locs : locs.filter(l=>l.company_id===s.company_id);
  if(visible.length===0){ wrap.innerHTML='<div class="text-sm text-slate-400">No locations yet.</div>'; return; }
  visible.forEach(l=>{
    const row=document.createElement('div'); row.className='list-row flex items-start justify-between';
    const company = compMap[l.company_id] || null;
    const companyHtml = company && company.logo ? `<img src="${company.logo}" class="logo-small mr-2" onerror="this.style.display='none'">` : '';
    const audioHtml = l.audio_url ? `<div class="text-xs text-slate-600 mt-1">Audio: <a href="${l.audio_url}" target="_blank" class="underline">Listen</a> ¬∑ <button class="bg-gray-100 px-2 py-1 rounded ml-2" onclick="playUrl('${encodeURIComponent(l.audio_url)}')">Play</button></div>` : '';
    row.innerHTML = `<div class="flex-1">${companyHtml}<div class="font-semibold">${l.name}</div><div class="text-xs text-slate-500">Lat: ${Number(l.lat).toFixed(6)} ¬∑ Lng: ${Number(l.lng).toFixed(6)} ¬∑ R: ${l.radius}m</div>${l.msg?`<div class="text-xs text-slate-600 mt-1">Msg: ${l.msg}</div>`:''}${audioHtml}</div>
      <div class="flex flex-col gap-2 ml-3">
        <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editLocation('${l.id}')">Edit</button>
        <button class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" onclick="deleteLocation('${l.id}')">Delete</button>
      </div>`;
    wrap.appendChild(row);
  });
}



/* helper to play a signed URL safely (decode and play) */
function playUrl(encodedUrl){
  try{
    const url = decodeURIComponent(encodedUrl);
    const a = new Audio(url);
    a.play().catch(e=>{ alert('Could not play audio'); });
  }catch(e){ }
}

async function editLocation(id){
  try{
    const { data, error } = await sb.from('locations').select('*').eq('id', id).single();
    if(error || !data){ alert('Location not found'); return; }
    const elId = document.getElementById('locId');
    if(elId) elId.value = data.id || '';
    document.getElementById('locName').value = data.name || '';
    document.getElementById('locLat').value = data.lat || '';
    document.getElementById('locLng').value = data.lng || '';
    document.getElementById('locRadius').value = data.radius || 500;
    document.getElementById('locMsg').value = data.msg || '';
    // open the locations page UI
    renderLocationList();
  }catch(e){
    console.error('editLocation err', e);
    alert('Failed to load location for editing');
  }
}
async function deleteLocation(id){
  if(!confirm('Delete location?')) return;
  try{ await db_delete('locations', { id }); await renderLocationList(); await renderAvailList(); toast('Location deleted'); }catch(e){ console.error('deleteLocation', e); alert('Delete failed'); }
}

/* Trips */
let planned = [], plannedSelIdx = null;
async function renderAvailList(){
  const wrap = document.getElementById('availList'); wrap.innerHTML='';
  const s = getSessionLocally();
  const locsAll = await db_select('locations');
  const visible = (!s || s.user==='bhagyesh') ? locsAll : locsAll.filter(l=>l.company_id===s.company_id);
  if(visible.length===0){ wrap.innerHTML = '<div class="text-sm text-slate-400">No locations available.</div>'; return; }
  visible.forEach(l=>{
    const el = document.createElement('div'); el.className='p-2 rounded hover:bg-slate-50 flex items-center justify-between';
    el.innerHTML = `<div><div class="font-medium">${l.name}</div><div class="text-xs text-slate-500">${Number(l.lat).toFixed(4)}, ${Number(l.lng).toFixed(4)}</div></div><div><button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded" onclick="planAddFromButton('${l.id}')">Add</button></div>`;
    wrap.appendChild(el);
  });
}
async function planAddFromButton(locId){
  const loc = (await db_select('locations')).find(x=>x.id===locId);
  if(!loc) return;
  planned.push({ id: loc.id, name: loc.name, lat: loc.lat, lng: loc.lng, radius: loc.radius, msg: loc.msg||'', audio_url: loc.audio_url||null });
  renderPlanned();
}
function renderPlanned(){ const wrap=document.getElementById('plannedList'); wrap.innerHTML=''; if(planned.length===0){ wrap.innerHTML='<div class="text-sm text-slate-400">No planned stops</div>'; return; } planned.forEach((p,i)=>{ const el=document.createElement('div'); el.className='p-2 rounded hover:bg-slate-50 flex items-center justify-between'; el.innerHTML=`<div><div class="font-medium">${i+1}. ${p.name}</div><div class="text-xs text-slate-500">R ${p.radius}m</div></div><div class="flex gap-2"><button class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded" onclick="plannedSelect(${i})">Select</button></div>`; if(i===plannedSelIdx) el.classList.add('ring','ring-blue-300'); wrap.appendChild(el); }); }
function plannedSelect(i){ plannedSelIdx = (plannedSelIdx===i? null : i); renderPlanned(); }
function removePlanned(){ if(plannedSelIdx===null) return alert('Select planned stop'); planned.splice(plannedSelIdx,1); plannedSelIdx=null; renderPlanned(); }
function movePlanned(dir){ if(plannedSelIdx===null) return alert('Select planned stop'); const i=plannedSelIdx, j=i+dir; if(j<0||j>=planned.length) return; [planned[i],planned[j]]=[planned[j],planned[i]]; plannedSelIdx=j; renderPlanned(); }
function clearPlanned(){ if(!confirm('Clear planned stops?')) return; planned=[]; plannedSelIdx=null; renderPlanned(); }
async function saveTrip(){ const name=(document.getElementById('tripName').value||'').trim(); if(!name) return alert('Trip name required'); if(planned.length<2) return alert('Select at least 2 stops'); const s=getSessionLocally(); const companyId = (!s || s.user==='bhagyesh') ? null : s.company_id; try{ // store only IDs for locs (backward compatible)
    const locIds = planned.map(x=>x.id);
    await db_insert('trips', [{ id: uid('trip'), name, locs: locIds, company_id: companyId, created_at: new Date().toISOString() }]);
    planned=[]; plannedSelIdx=null; document.getElementById('tripName').value=''; renderPlanned(); renderTripList(); renderStartSelect(); toast('Trip saved'); }catch(e){ console.error('saveTrip', e); alert('Failed to save trip'); } }
async function renderTripList(){
  const wrap=document.getElementById('tripList'); wrap.innerHTML=''; const s=getSessionLocally(); const trips=await db_select('trips'); const visible = (!s||s.user==='bhagyesh') ? trips : trips.filter(t=>t.company_id===s.company_id);
  if(visible.length===0){ wrap.innerHTML='<div class="text-sm text-slate-400">No trips</div>'; return; }
  // Render each trip. Support trips where t.locs is an array of IDs or an array of full objects.
  for(const t of visible){
    let locNames = [];
    try{
      if(Array.isArray(t.locs) && t.locs.length>0 && typeof t.locs[0] === 'string'){
        // fetch names for IDs (preserve order)
        const { data: locData, error } = await sb.from('locations').select('id,name').in('id', t.locs);
        if(!error && Array.isArray(locData)){
          const nameMap = {}; locData.forEach(l=> nameMap[l.id]=l.name);
          locNames = t.locs.map(id => nameMap[id] || '(unknown)');
        } else {
          locNames = t.locs.map(id=>'(loading)');
        }
      } else if(Array.isArray(t.locs)){
        locNames = (t.locs||[]).map(x=>x.name || '(unknown)');
      } else {
        locNames = [];
      }
    }catch(e){ locNames = (t.locs||[]).map(x=> x.name || (typeof x==='string'?x:'(unknown)')); }

    const row=document.createElement('div'); row.className='list-row flex items-center justify-between';
    row.innerHTML = `<div><div class="font-semibold">${t.name}</div><div class="text-xs text-slate-500">${locNames.join(' ‚Üí ')}</div></div><div class="flex gap-2"><button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded" onclick="startTripById('${t.id}')">Start</button><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editTrip('${t.id}')">Edit</button><button class="bg-red-600 px-3 py-1 rounded text-white hover:bg-red-700" onclick="deleteTrip('${t.id}')">Delete</button></div>`;
    wrap.appendChild(row);
  }
}
async function editTrip(id){ const trips=await db_select('trips'); const t=trips.find(x=>x.id===id); if(!t) return; document.getElementById('tripName').value=t.name; // prepare planned array
  if(Array.isArray(t.locs) && t.locs.length>0 && typeof t.locs[0] === 'string'){
    // stored as IDs -> fetch full location rows
    try{
      const { data: locData, error } = await sb.from('locations').select('*').in('id', t.locs);
      if(error) { console.error('editTrip fetch locs', error); planned = []; }
      else planned = (locData||[]).map(l=>({ id: l.id, name: l.name, lat: l.lat, lng: l.lng, radius: l.radius, msg: l.msg||'', audio_url: l.audio_url||null }));
    }catch(e){ console.error('editTrip fetch failed', e); planned = []; }
  } else {
    // old format (full objects) -> use as-is
    planned = (t.locs||[]).map(x=>({ id: x.id, name: x.name, lat: x.lat, lng: x.lng, radius: x.radius, msg: x.msg||'', audio_url: x.audio_url||null }));
  }
  renderPlanned(); await db_delete('trips', { id }); renderTripList(); go('pageTripSetup'); }
async function deleteTrip(id){ if(!confirm('Delete trip?')) return; await db_delete('trips', { id }); renderTripList(); renderStartSelect(); }

/* START TRIP */
let runMap=null, runMarkers=[], runCircles=[];
let watchId = null, autoRefreshIntervalId = null;
let runtime = { active: null, lastPos: null, ttsVolume: 1 };

async function renderStartSelect(){
  const sel = document.getElementById('startTripSelect'); sel.innerHTML='';
  const s=getSessionLocally();
  const trips=await db_select('trips'); const visible = (!s||s.user==='bhagyesh') ? trips : trips.filter(t=>t.company_id===s.company_id);
  visible.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; sel.appendChild(o); });
}
function startSelectedTrip(){ const id=document.getElementById('startTripSelect').value; if(!id) return alert('Select trip'); startTripById(id); }
async function startTripById(id){
  const trips = await db_select('trips'); const t = trips.find(x=>x.id===id); if(!t) return alert('Trip not found');
  // Fetch latest locations: support both old full-object trips and id-only trips
  let locsLatest = [];
  try{
    if(Array.isArray(t.locs) && t.locs.length>0 && typeof t.locs[0] === 'string'){
      // stored as IDs -> fetch
      const { data: locData, error } = await sb.from('locations').select('*').in('id', t.locs);
      if(error){ console.error('startTripById loc fetch err', error); locsLatest = []; }
      else locsLatest = (locData||[]).map(l=>({ id: l.id, name: l.name, lat: l.lat, lng: l.lng, radius: l.radius, msg: l.msg||'', audio_url: l.audio_url||null }));
      } else {
      // old format - already full objects
      locsLatest = (t.locs||[]).map(x=>({ id: x.id, name: x.name, lat: x.lat, lng: x.lng, radius: x.radius, msg: x.msg||'', audio_url: x.audio_url||null }));
      }
  }catch(e){ console.error('startTripById fetch err', e); }

  runtime.active = { tripId: t.id, name: t.name, locs: JSON.parse(JSON.stringify(locsLatest)), startedAt: new Date().toISOString(), reached: [], idx: 0, meMarker: null, _prevPos: null };
  document.getElementById('ongoingTripName').textContent = runtime.active.name; document.getElementById('ongoingStart').textContent = fmtISO(runtime.active.startedAt);

  if(!runMap) initRunMap();
  // clear existing markers & circles (no polyline)
  runMarkers.forEach(m=>{ try{ runMap.removeLayer(m);}catch(e){} }); runCircles.forEach(c=>{ try{ runMap.removeLayer(c);}catch(e){} }); runMarkers=[]; runCircles=[];
  // ensure we do not render a polyline; only show markers and radius circles
  runtime.active.locs.forEach((l,idx)=>{ const m = L.marker([l.lat,l.lng]).addTo(runMap).bindPopup(`${idx+1}. ${l.name}<br><button class='bg-blue-600 text-white px-2 py-1 rounded mt-1' onclick="playAnnouncementById('${l.id}')">‚ñ∂ Play Announcement</button>`); runMarkers.push(m); const c = L.circle([l.lat,l.lng], { radius:Number(l.radius||500), fillOpacity:0.06, color:'#2563eb' }).addTo(runMap); runCircles.push(c); });
  try{ if(runtime.active.locs.length>0){ const latlngs = runtime.active.locs.map(l=>[l.lat,l.lng]); runMap.fitBounds(L.latLngBounds(latlngs), { padding:[20,20] }); } }catch(e){}
  document.getElementById('startPanel').classList.add('hidden'); document.getElementById('ongoingPanel').classList.remove('hidden');

  // ensure map layout recalculates (fix laptop/tablet rendering)
  setTimeout(()=>{ try{ runMap.invalidateSize(); }catch(e){} }, 300);

  runtime.active.locs.forEach(l=>{ l._enterCount=0; l._arrived=false; });
  if(watchId!==null){ try{ navigator.geolocation.clearWatch(watchId);}catch(e){} watchId=null; }
  if(navigator.geolocation) watchId = navigator.geolocation.watchPosition(onGPS, gpsError, { enableHighAccuracy:true, maximumAge:2000 });
  startPeriodicRefreshImmediate();
  updateProgressUI();
}
// Populate manual announcement dropdown
try{
  const sel = document.getElementById('manualSelect');
  if(sel){
    sel.innerHTML = '<option value="">-- Select Location --</option>';
    runtime.active.locs.forEach(l => {
      sel.innerHTML += `<option value="${l.id}">${l.name}</option>`;
    });
  }
}catch(e){ }

function initRunMap(){ if(runMap){ try{ runMap.invalidateSize(); }catch(e){} return; } runMap = L.map('runMap'); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap' }).addTo(runMap); runMap.setView([21.6417,69.6293], 12); }
function createBusIcon(){ const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='36' height='36'><rect x='6' y='12' width='52' height='36' rx='6' fill='#0ea5e9' stroke='#0369a1' stroke-width='2'/><circle cx='20' cy='52' r='4' fill='#0b1220'/><circle cx='44' cy='52' r='4' fill='#0b1220'/><rect x='16' y='20' width='8' height='12' fill='#fff'/><rect x='40' y='20' width='8' height='12' fill='#fff'/></svg>`); return L.divIcon({ html:`<img src="data:image/svg+xml;charset=utf-8,${svg}" style="width:36px;height:36px;"/>`, className:'', iconSize:[36,36], iconAnchor:[18,18] }); }

function onGPS(pos){
  runtime.lastPos = pos;
  const lat = pos.coords.latitude, lng = pos.coords.longitude, sp = pos.coords.speed;
  if(!runtime.active) return;
  if(!runtime.active.meMarker) runtime.active.meMarker = L.marker([lat,lng], { icon:createBusIcon(), title:'Vehicle' }).addTo(runMap);
  else runtime.active.meMarker.setLatLng([lat,lng]);
  try{ runMap.panTo([lat,lng], { animate:true, duration:.6 }); }catch(e){}
  document.getElementById('curLat').textContent = lat.toFixed(6);
  document.getElementById('curLng').textContent = lng.toFixed(6);
  document.getElementById('curSpeed').textContent = sp ? (sp*3.6).toFixed(1) + ' km/h' : '‚Äî';
  updateUpcomingAndCheck(lat,lng,sp);
}
function gpsError(err){ }


function updateUpcomingAndCheck(lat, lng, speedMs){
  try{
    const trip = runtime.active;
    if(!trip || !Array.isArray(trip.locs) || trip.locs.length === 0) return;

    // for all stops, compute distance and take action
    for(let rIdx=0; rIdx < trip.locs.length; rIdx++){
      const loc = trip.locs[rIdx];
      if(!loc) continue;
      const rawRadius = Number(loc.radius || loc.rad || loc.reachRadius || 500);
      const preRadius = Math.max(100, rawRadius);
      const arrRadius = Math.max(50, Math.round(rawRadius/2));

      const dist = haversine(lat, lng, Number(loc.lat), Number(loc.lng));

      loc._preAnnounced = loc._preAnnounced || false;
      loc._arrived = loc._arrived || false;

      // pre-announce
      if(!loc._preAnnounced && dist <= preRadius){
        loc._preAnnounced = true;
        try{ playAnnouncement(loc); 
    // --- AUTO-DETECTION: check if we're within any stop radius and announce ---
    try{
      if(runtime && runtime.active && Array.isArray(runtime.active.locs)){
        runtime.active.locs.forEach(l => {
          try{
            if(!l) return;
            // ensure flags exist
            if(typeof l._arrived === 'undefined') l._arrived = false;
            if(typeof l._enterCount === 'undefined') l._enterCount = 0;
            const dist = haversine(lat, lng, Number(l.lat), Number(l.lng));
            // when within radius and not already arrived, trigger announcement
            if(dist <= (Number(l.radius) || 0) && !l._arrived){
              l._arrived = true;
              l._enterCount = (l._enterCount||0) + 1;
              console.log('üü¢ Auto-arrived at', l.name, 'id:', l.id, 'dist:', Math.round(dist));
              // play announcement using global-safe function
              if(typeof window.playAnnouncementById === 'function'){
                try{ window.playAnnouncementById(l.id); }catch(e){ console.error('Auto announce failed', e); }
              } else {
                try{ playAnnouncementById(l.id); }catch(e){ console.error('Auto announce (local) failed', e); }
              }
              // UI feedback: toast and update progress if available
              try{ if(typeof toast === 'function') toast('Arrived: ' + (l.name||'Stop')); }catch(e){};
              try{
                // mark circle green if runCircles exists and matches this location (by coordinates)
                if(window.runCircles && Array.isArray(window.runCircles)){
                  window.runCircles.forEach(c => {
                    try{
                      const center = c.getLatLng();
                      if(Math.abs(center.lat - Number(l.lat))<0.0001 && Math.abs(center.lng - Number(l.lng))<0.0001){
                        c.setStyle({ color: '#16a34a', fillOpacity: 0.08 });
                      }
                    }catch(e){}
                  });
                }
              }catch(e){}
            }
          }catch(e){ console.error('per-loc auto-detect error', e); }
        });
      }
    }catch(e){ console.error('auto-detect outer error', e); }
    // --- END AUTO-DETECTION ---
}catch(e){ if(typeof speak === 'function') speak('Approaching ' + loc.name); }
      }

      // arrival
      if(!loc._arrived && dist <= arrRadius){
        loc._arrived = true;
        trip.reached = trip.reached || [];
        trip.reached.push({ name: loc.name, id: loc.id, time: new Date().toISOString(), idx: rIdx });

        // style circle green
        try{ if(typeof runCircles !== 'undefined' && runCircles[rIdx]) runCircles[rIdx].setStyle({ color:'#16a34a', fillColor:'#16a34a' }); }catch(e){}

        // change marker to a tick icon
        try{
          if(typeof runMarkers !== 'undefined' && runMarkers[rIdx]){
            runMarkers[rIdx].setIcon(L.divIcon({ className:'arrived-marker', html:'<div style="font-size:14px;padding:4px;border-radius:6px;background:#16a34a;color:#fff;">‚úîÔ∏è</div>', iconSize:[28,28] }));
          }
        }catch(e){}

        // update trip list tick
        try{
          const stopEl = document.querySelector("[data-stop-id='" + loc.id + "']");
          if(stopEl && !stopEl.textContent.includes('‚úîÔ∏è')){
            stopEl.textContent = stopEl.textContent.trim() + ' ‚úîÔ∏è';
          }
        }catch(e){}

        // announcement on arrival
        try{ playAnnouncement(loc); }catch(e){ if(typeof speak === 'function') speak('Arrived at ' + loc.name); }

        // advance trip idx if applicable
        try{ if(typeof trip.idx === 'number' && rIdx >= trip.idx) trip.idx = rIdx + 1; }catch(e){}

        // update progress UI
        try{ updateProgressUI(); }catch(e){}
      }

    } // end for

    // update upcoming UI based on current trip.idx
    try{
      const nextLoc = trip.locs[trip.idx];
      if(nextLoc){
        const dnext = haversine(lat, lng, Number(nextLoc.lat), Number(nextLoc.lng));
        const elUp = document.getElementById('upcomingName'); if(elUp) elUp.textContent = nextLoc.name;
        const elDist = document.getElementById('distNext'); if(elDist) elDist.textContent = dnext>=1000 ? (dnext/1000).toFixed(2)+' km' : Math.round(dnext)+' m';
        const spUse = speedMs || (trip._lastSpeed || 8.33);
        let etaText = '‚Äî';
        if(spUse > 0.1){ const sec = dnext / spUse; const min = Math.round(sec/60); etaText = min<=1 ? '~1 min' : ('~' + min + ' min'); }
        const elEta = document.getElementById('etaNext'); if(elEta) elEta.textContent = etaText;
      }
    }catch(e){}

    // store last pos/speed
    try{ trip._lastPos = { lat:lat, lng:lng }; trip._lastPosTime = Date.now(); trip._lastSpeed = speedMs || trip._lastSpeed; }catch(e){}

  }catch(err){
    console.error('updateUpcomingAndCheck error', err);
  }
}

function updateProgressUI(){
  if(!runtime.active){ document.getElementById('progressStops').textContent='‚Äî'; document.getElementById('progressBar').style.width='0%'; return; }
  const reached = runtime.active.reached.length; const total = runtime.active.locs.length;
  const pct = total===0 ? 0 : Math.round((reached/total)*100);
  document.getElementById('progressStops').textContent = `${reached} / ${total} (${pct}%)`;
  document.getElementById('progressBar').style.width = pct + '%';
}

async function finishAndSaveRun(){
  if(!runtime.active) return;
  const endedAt = new Date().toISOString();
  const durationMin = Math.round((new Date(endedAt) - new Date(runtime.active.startedAt))/60000);
  const run = { id: uid('run'), trip_name: runtime.active.name, started_at: runtime.active.startedAt, ended_at: endedAt, duration_min: durationMin, reached: runtime.active.reached };
  try{ await db_insert('runs', [run]); toast('Run saved'); setTimeout(()=> endTrip(), 800); }catch(e){ console.error('finish save run', e); endTrip(); }
}

async function endTrip(){
  if(!runtime.active) return;
  const endedAt = new Date().toISOString();
  const durationMin = Math.round((new Date(endedAt) - new Date(runtime.active.startedAt))/60000);
  const run = { id: uid('run'), trip_name: runtime.active.name, started_at: runtime.active.startedAt, ended_at: endedAt, duration_min: durationMin, reached: runtime.active.reached };
  try{ await db_insert('runs', [run]); }catch(e){ }
  if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  if(autoRefreshIntervalId!==null){ clearInterval(autoRefreshIntervalId); autoRefreshIntervalId=null; }
  if(runtime.active && runtime.active.meMarker){ try{ runMap.removeLayer(runtime.active.meMarker); }catch(e){} }
  runtime.active = null;
  document.getElementById('ongoingPanel').classList.add('hidden');
  document.getElementById('startPanel').classList.remove('hidden');
  toast('Trip ended and saved to reports');
  await renderReports(); await renderTripList(); await renderStartSelect();
}

/* center map and gps helpers */
function centerMap(){ if(runtime.lastPos && runMap) runMap.panTo([runtime.lastPos.coords.latitude, runtime.lastPos.coords.longitude]); }
function centerCurrentGPS(){ if(!navigator.geolocation) return alert('Geolocation not available'); navigator.geolocation.getCurrentPosition(p=>{ onGPS(p); runMap.panTo([p.coords.latitude,p.coords.longitude]); }, err=>alert('GPS error: '+err.message)); }

/* TTS and audio handling */
function setVolume(v){ runtime.ttsVolume = Number(v); toast('Volume: ' + runtime.ttsVolume); }
function speak(text){ try{ const u = new SpeechSynthesisUtterance(text); u.volume = Number(runtime.ttsVolume || 1.0); speechSynthesis.speak(u); }catch(e){ } }

function playAnnouncement(loc){
  if(!loc) return;
  try{
    if(loc.audio_url){
      const a = new Audio(loc.audio_url);
      a.volume = Number(runtime.ttsVolume || 1.0);
      a.play().catch(e=>{ if(loc.msg) speak(loc.msg); });
    } else if(loc.msg && loc.msg.trim()){
      speak(loc.msg);
    } else {
      speak('Next stop');
    }
  }catch(e){ }
}

/* Periodic refresh */
function startPeriodicRefreshImmediate(){
  if(autoRefreshIntervalId) clearInterval(autoRefreshIntervalId);
  if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=> onGPS(p), ()=>{}); }
  setAutoRefreshInterval();
}

function setAutoRefreshInterval(){
  try{
    if(autoRefreshIntervalId) clearInterval(autoRefreshIntervalId);
    const secs = Number(document.getElementById('autoRefreshSelect').value || 10);
    autoRefreshIntervalId = setInterval(async () => {
      try{
        if(!navigator.geolocation) return;
        if (navigator.permissions && navigator.permissions.query) {
          const perm = await navigator.permissions.query({ name: 'geolocation' });
          if (perm.state === 'granted') {
            navigator.geolocation.getCurrentPosition(pos => onGPS(pos), () => {});
          } else {
            // silently skip if not granted
          }
        } else {
          navigator.geolocation.getCurrentPosition(pos => onGPS(pos), () => {});
        }
      }catch(e){}
    }, secs * 1000);
    toast('Auto refresh ' + secs + 's');
  }catch(e){
    console.error('setAutoRefreshInterval error', e);
  }
}



/* Reports & exports */
async function renderReports(){
  const ul = document.getElementById('reportTrips'); ul.innerHTML='';
  const runs = await db_select('runs');
  if(runs.length===0) ul.innerHTML = '<div class="text-sm text-slate-400">No trip reports yet.</div>';
  runs.slice().reverse().forEach(r=>{
    const div=document.createElement('div'); div.className='list-row';
    div.innerHTML = `<div class="font-semibold">${r.trip_name}</div><div class="text-xs text-slate-500">Start: ${fmtISO(r.started_at)} | End: ${fmtISO(r.ended_at)} | Duration: ${r.duration_min} min</div><div class="text-xs text-slate-600 mt-1">Stops: ${(r.reached||[]).map(s=>s.name+' ('+fmtISO(s.time)+')').join(', ') || '‚Äî'}</div>`;
    ul.appendChild(div);
  });
  const logs = await db_select('logins'); const ul2 = document.getElementById('reportLogins'); ul2.innerHTML='';
  if(logs.length===0) ul2.innerHTML = '<div class="text-sm text-slate-400">No login activity</div>';
  logs.slice().reverse().forEach(l=>{ const li=document.createElement('div'); li.className='list-row'; li.innerHTML = `<div class="font-medium">${l.user}</div><div class="text-xs text-slate-500">${l.role} ¬∑ ${fmtISO(l.time)} ¬∑ ${l.device}</div>`; ul2.appendChild(li); });
}
async function exportTripsExcel(){ const runs = await db_select('runs'); const rows = []; runs.forEach(r=>{ rows.push({ Trip: r.trip_name, StartedAt: r.started_at, EndedAt: r.ended_at, DurationMin: r.duration_min }); (r.reached||[]).forEach(s=> rows.push({ Trip: r.trip_name, StopReached: s.name, ReachedAt: s.time })); }); const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'TripReports'); XLSX.writeFile(wb, 'trip_reports.xlsx'); }
async function exportLoginsExcel(){ const logs = await db_select('logins'); const ws = XLSX.utils.json_to_sheet(logs); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'LoginLogs'); XLSX.writeFile(wb, 'login_logs.xlsx'); }

/* Help */
function showHelp(){ alert('BusMate prototype ‚Äî Master: bhagyesh/bhagyesh; Admin: admin/admin; Operator: operator/operator. Serve via static server for geolocation.'); }

/* Boot */
(async function boot(){
  await seedDemoIfEmpty();
  const s = getSessionLocally();
  if(s){ document.getElementById('logoutBtn').classList.remove('hidden'); document.getElementById('userLabel').textContent = s.display_name || s.user; document.getElementById('roleLabel').textContent = s.role; await applyHeader(); go('pageHome'); } else { go('pageLogin'); }
  await renderCompanyList(); await renderUserList(); await renderLocationList(); await renderAvailList(); await renderTripList(); await renderStartSelect(); await renderReports();
})();

/* expose debug and functions for inline onclick */
window._bm = { sb, db_select, db_insert, db_update, db_delete, runtime };


/* Vendors & Vehicles CRUD */
let _editingVendor = null;
let _editingVehicle = null;

async function renderVendorList(){
  const wrap = document.getElementById('vendorList'); wrap.innerHTML='';
  const s = getSessionLocally();
  const vendors = await db_select('vendors');
  const visible = (!s || s.user==='bhagyesh') ? vendors : vendors.filter(v=>v.company_id===s.company_id);
  if(visible.length===0){ wrap.innerHTML = '<div class="text-sm text-slate-400">No vendors</div>'; return; }
  visible.forEach(v=>{
    const div = document.createElement('div'); div.className='list-row flex items-center justify-between';
    div.innerHTML = `<div><div class="font-medium">${v.name}</div><div class="text-xs text-slate-500">${v.id} ¬∑ ${v.notes||''}</div></div>
      <div class="flex gap-2"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editVendor('${v.id}')">Edit</button><button class="bg-red-600 px-3 py-1 rounded text-white" onclick="deleteVendor('${v.id}')">Delete</button></div>`;
    wrap.appendChild(div);
  });
  // update stats
  document.getElementById('statVendors').textContent = visible.length;
  // refresh vehicle vendor dropdowns
  populateVehicleVendorOptions();
}

function openVendorForm(){ _editingVendor=null; document.getElementById('vendorId').value=''; document.getElementById('vendorName').value=''; document.getElementById('vendorNotes').value=''; document.getElementById('vendorModal').classList.remove('hidden'); }
function closeVendorModal(){ document.getElementById('vendorModal').classList.add('hidden'); _editingVendor=null; }

async function saveVendor(){
  const id = (document.getElementById('vendorId').value||'').trim();
  const name = (document.getElementById('vendorName').value||'').trim();
  const notes = (document.getElementById('vendorNotes').value||'').trim();
  if(!name) return alert('Vendor name required');
  try{
    const s = getSessionLocally(); const companyId = (s && s.user!=='bhagyesh') ? s.company_id : null;
    if(id){
      await db_update('vendors', { name, notes, company_id: companyId }, { id });
    } else {
      await db_insert('vendors', [{ id: uid('vend'), name, notes, company_id: companyId }]);
    }
    closeVendorModal(); await renderVendorList(); toast('Vendor saved');
  }catch(e){ console.error('saveVendor', e); alert('Failed to save vendor'); }
}

async function editVendor(id){
  const rows = await db_select('vendors');
  const data = (rows || []).find(r=>r.id===id);
  if(!data) return alert('Vendor not found');
  document.getElementById('vendorId').value = data.id || '';
  document.getElementById('vendorName').value = data.name || '';
  document.getElementById('vendorNotes').value = data.notes || '';
  document.getElementById('vendorModal').classList.remove('hidden');
}

async function deleteVendor(id){
  if(!confirm('Delete vendor? This will not delete vehicles automatically.')) return;
  try{ await db_delete('vendors', { id }); await renderVendorList(); toast('Vendor deleted'); }catch(e){ console.error('deleteVendor', e); alert('Delete failed'); }
}

/* Vehicles */
async function renderVehicleList(){
  const wrap = document.getElementById('vehicleList'); wrap.innerHTML='';
  const s = getSessionLocally();
  const vehicles = await db_select('vehicles');
  const visible = (!s || s.user==='bhagyesh') ? vehicles : vehicles.filter(v=>v.company_id===s.company_id);
  if(visible.length===0){ wrap.innerHTML = '<div class="text-sm text-slate-400">No vehicles</div>'; document.getElementById('statVehicles').textContent = 0; return; }
  visible.forEach(v=>{
    const row = document.createElement('div'); row.className='list-row flex items-center justify-between';
    row.innerHTML = `<div><div class="font-medium">${v.name}</div><div class="text-xs text-slate-500">${v.id}</div><div class="text-xs text-slate-500">${v.notes||''}</div></div>
      <div class="flex gap-2"><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="editVehicle('${v.id}')">Edit</button><button class="bg-red-600 px-3 py-1 rounded text-white" onclick="deleteVehicle('${v.id}')">Delete</button></div>`;
    wrap.appendChild(row);
  });
  document.getElementById('statVehicles').textContent = visible.length;
}

function openVehicleForm(){ _editingVehicle=null; document.getElementById('vehicleId').value=''; document.getElementById('vehicleName').value=''; document.getElementById('vehicleNotes').value=''; populateVehicleVendorOptions(); document.getElementById('vehicleModal').classList.remove('hidden'); }
function closeVehicleModal(){ document.getElementById('vehicleModal').classList.add('hidden'); _editingVehicle=null; }

async function populateVehicleVendorOptions(){
  // vendor dropdown removed ‚Äî no-op to keep existing calls safe
  return;
}

async function saveVehicle(){
  const id = (document.getElementById('vehicleId').value||'').trim();
  const name = (document.getElementById('vehicleName').value||'').trim();
  const notes = (document.getElementById('vehicleNotes').value||'').trim();
  if(!name) return alert('Vehicle name required');
  try{
    const s = getSessionLocally(); const companyId = (s && s.user!=='bhagyesh') ? s.company_id : null;
    if(id){
      await db_update('vehicles', { name, notes, company_id: companyId }, { id });
    } else {
      await db_insert('vehicles', [{ id: uid('veh'), name, notes, company_id: companyId }]);
    }
    closeVehicleModal(); await renderVehicleList(); toast('Vehicle saved');
  }catch(e){ console.error('saveVehicle', e); alert('Failed to save vehicle'); }
}

async function editVehicle(id){
  const rows = await db_select('vehicles');
  const data = (rows || []).find(r=>r.id===id);
  if(!data) return alert('Vehicle not found');
  document.getElementById('vehicleId').value = data.id || '';
  document.getElementById('vehicleName').value = data.name || '';
  document.getElementById('vehicleNotes').value = data.notes || '';
  document.getElementById('vehicleModal').classList.remove('hidden');
}

async function deleteVehicle(id){
  if(!confirm('Delete vehicle?')) return;
  try{ await db_delete('vehicles', { id }); await renderVehicleList(); toast('Vehicle deleted'); }catch(e){ console.error('deleteVehicle', e); alert('Delete failed'); }
}


window.handleLogin = handleLogin;

/* Expose vendor/vehicle functions */
window.openVendorForm = openVendorForm;
window.closeVendorModal = closeVendorModal;
window.saveVendor = saveVendor;
window.editVendor = editVendor;
window.deleteVendor = deleteVendor;
window.openVehicleForm = openVehicleForm;
window.closeVehicleModal = closeVehicleModal;
window.saveVehicle = saveVehicle;
window.editVehicle = editVehicle;
window.deleteVehicle = deleteVehicle;
window.renderVendorList = renderVendorList;
// window.renderVehicleList = renderVehicleList;
// window.populateVehicleVendorOptions = populateVehicleVendorOptions;
window.showHelp = showHelp;
window.logout = logout;
window.go = go;

window.openCompanyForm = openCompanyForm;
window.closeCompanyModal = closeCompanyModal;
window.saveCompany = saveCompany;
window.editCompany = editCompany;
window.toggleCompany = toggleCompany;
window.deleteCompany = deleteCompany;

window.openUserForm = openUserForm;
window.closeUserModal = closeUserModal;
window.saveUser = saveUser;
window.editUser = editUser;
window.toggleUser = toggleUser;
window.deleteUser = deleteUser;

window.useCurrentGPS = useCurrentGPS;
window.testAnnouncement = testAnnouncement;
window.saveLocation = saveLocation;
window.editLocation = editLocation;
window.deleteLocation = deleteLocation;

window.planAddFromButton = planAddFromButton;
window.plannedSelect = plannedSelect;
window.removePlanned = removePlanned;
window.movePlanned = movePlanned;
window.clearPlanned = clearPlanned;
window.saveTrip = saveTrip;
window.editTrip = editTrip;
window.deleteTrip = deleteTrip;

window.startSelectedTrip = startSelectedTrip;
window.startTripById = startTripById;
window.endTrip = endTrip;
window.centerMap = centerMap;
window.centerCurrentGPS = centerCurrentGPS;
window.setVolume = setVolume;

window.exportTripsExcel = exportTripsExcel;
window.exportLoginsExcel = exportLoginsExcel;

window.openPasswordForm = openPasswordForm;
window.closePasswordModal = closePasswordModal;
window.savePassword = savePassword;
window.playUrl = playUrl;

</script>
<!-- ***** PATCH: runtime overrides to fix audio overlap, volume, edit/save location, live map, wake-lock ***** -->
<script>
// (Truncated patch comment header for brevity)
// ... full JS patch script here ...
</script>
<!-- ***** END PATCH ***** -->
<script>
// Patch: Fetch latest location data from Supabase when trip starts
const originalStartTrip = window.startTripById;
window.startTripById = async function(id) {
  try {
    // Fetch latest trip data
    const trips = await db_select('trips');
    const trip = trips.find(t => t.id === id);
    if (!trip) return alert('Trip not found');

    // Fetch latest locations from Supabase
    const locs = await db_select('locations');
    const freshLocs = (trip.locs || []).map(loc => {
      const latest = locs.find(l => l.id === loc.id);
      return latest ? { ...loc, ...latest } : loc;
    });
    trip.locs = freshLocs;

    runtime.active = { ...trip, idx: 0, reached: [], startedAt: new Date().toISOString() };
    if (typeof renderRunMap === 'function') renderRunMap();

    // Continue normal trip behavior
    if (typeof requestWakeLock === 'function') await requestWakeLock();
    } catch (e) {
    console.error('startTripById radius fix error', e);
    if (typeof originalStartTrip === 'function') return originalStartTrip(id);
  }
};
</script>
<script>
// --- Enhanced Announcement Handler with Supabase Fallback ---
window.playAnnouncementById = async function(locId){
  try{
    const rt = window.runtime || (typeof runtime !== 'undefined' ? runtime : null);
    let loc = null;
    const locs = rt && rt.active && Array.isArray(rt.active.locs) ? rt.active.locs : null;
    if(locs){
      loc = locs.find(x => x.id === locId);
    }
    if(!loc){
      console.warn('Location not found locally for ID:', locId, '‚Üí Fetching from Supabase...');
      if(window.SB){
        try{
          const { data, error } = await window.SB.from('locations').select('*').eq('id', locId).single();
          if(!error && data){ loc = data; console.log('Fetched location:', data.name); }
        }catch(fetchErr){ console.error('Supabase fetch error', fetchErr); }
      }
    }
    if(!loc){
      console.warn('Location not found for ID:', locId);
      if(typeof toast === 'function') toast('Location not found');
      return;
    }
    console.log('üîä Playing announcement for', loc.name, 'ID:', locId);
    const url = loc.audio_url ? decodeURIComponent(loc.audio_url) : null;
    if(url){
      try{
        const a = new Audio(url);
        a.volume = (rt && rt.ttsVolume) ? rt.ttsVolume : 1;
        await a.play();
        return;
      }catch(e){ console.error('Audio play failed', e); if(typeof toast === 'function') toast('Audio playback error'); }
    }
    // fallback to TTS
    const msg = loc.msg || loc.name || 'Announcement';
    try{
      const utter = new SpeechSynthesisUtterance(msg);
      utter.volume = (rt && rt.ttsVolume) ? rt.ttsVolume : 1;
      utter.rate = 1;
      utter.pitch = 1;
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }catch(e){ console.error('TTS failed', e); if(typeof toast === 'function') toast('TTS failed'); }
  }catch(e){
    console.error('playAnnouncementById error', e);
    if(typeof toast === 'function') toast('Announcement failed');
  }
};
</script>
<script>
// --- Global Safe Auto Refresh Setter ---
window.setAutoRefreshInterval = function(value){
  try {
    const sec = Number(value);
    if(isNaN(sec) || sec <= 0) { if(typeof toast==='function') toast('Invalid refresh interval'); return; }
    if(window._autoRefreshTimer) clearInterval(window._autoRefreshTimer);
    window._autoRefreshTimer = setInterval(() => {
      try{
        if(typeof updateUpcomingAndCheck === 'function' && window.runtime && window.runtime.active && window.runtime.active.gps){
          const g = window.runtime.active.gps;
          updateUpcomingAndCheck(g.lat, g.lng, g.speedMs || 0);
        }
      }catch(e){ console.error('Auto refresh tick error', e); }
    }, sec * 1000);
    console.log('‚è±Ô∏è Auto refresh interval set to', sec, 'seconds');
    if(typeof toast==='function') toast('Auto refresh: ' + sec + 's');
  } catch(e) {
    console.error('setAutoRefreshInterval error', e);
  }
};
</script>
<script>
// --- Global Safe End Trip Handler ---
window.endTrip = function(){
  try {
    console.log('üõë Attempting to end trip...');
    if(typeof stopTrip === 'function'){ 
      stopTrip();
      if(typeof toast==='function') toast('Trip ended');
      
    // --- Return to Start Panel after end trip ---
    setTimeout(() => {
      try {
        const start = document.getElementById('startPanel');
        if(start){ start.classList.remove('hidden'); start.style.display = 'block'; }
        document.querySelectorAll('#ongoingTripPanel, #ongoingMap, .trip-live-section')
          .forEach(s => { s.classList.add('hidden'); s.style.display = 'none'; });
        console.log('‚úÖ Returned to Start Panel after trip end');
      } catch(e){ console.error('Return to Start Panel failed', e); }
    }, 300);
console.log('‚úÖ Trip ended via stopTrip()');
    } else if(window.runtime && window.runtime.active){
      window.runtime.active = null;
      if(typeof toast==='function') toast('Trip ended (fallback)');
      console.log('‚úÖ Trip ended (runtime cleared)');
    }
    // Hide ongoing panel and show home panel
    const ongoing = document.getElementById('ongoingTripPanel');
    const home = document.getElementById('homePanel');
    if(ongoing) ongoing.classList.add('hidden');
    if(home) home.classList.remove('hidden');
  } catch(e){
    console.error('endTrip error', e);
    if(typeof toast==='function') toast('End Trip failed');
  }
};
</script>
<script>
// --- Strong Global End Trip Handler (full cleanup) ---
window.endTrip = function(){
  try {
    console.log('üõë Ending trip (full cleanup)...');
    // Clear geolocation watch (try both global and module-scoped names)
    try{
      if(typeof watchId !== 'undefined' && watchId !== null){
        try{ navigator.geolocation.clearWatch(watchId); }catch(e){ console.warn('clearWatch failed for watchId', e); }
        watchId = null;
      }
      if(window.watchId){ try{ navigator.geolocation.clearWatch(window.watchId); }catch(e){} window.watchId = null; }
    }catch(e){ console.warn('watchId cleanup error', e); }

    // Clear any auto-refresh timers
    try{ if(window._autoRefreshTimer){ clearInterval(window._autoRefreshTimer); window._autoRefreshTimer = null; } }catch(e){ console.warn('autoRefresh cleanup', e); }

    // Clear runtime.active and other runtime state
    try{
      if(window.runtime && window.runtime.active){
        window.runtime.active = null;
      } else if(typeof runtime !== 'undefined' && runtime && runtime.active){
        runtime.active = null;
      }
      // also clear backup _runtime if present
      if(window._runtime){ window._runtime.active = null; }
    }catch(e){ console.warn('runtime cleanup', e); }

    // Remove markers and circles from map if present (module or window scope)
    try{
      if(window.runMarkers && Array.isArray(window.runMarkers)){
        window.runMarkers.forEach(m => { try{ if(m && m.remove) m.remove(); }catch(e){} });
        window.runMarkers = [];
      }
      if(window.runCircles && Array.isArray(window.runCircles)){
        window.runCircles.forEach(c => { try{ if(c && c.remove) c.remove(); }catch(e){} });
        window.runCircles = [];
      }
      // also try module scoped variables
      if(typeof runMarkers !== 'undefined' && Array.isArray(runMarkers)){
        runMarkers.forEach(m => { try{ if(m && m.remove) m.remove(); }catch(e){} });
      }
      if(typeof runCircles !== 'undefined' && Array.isArray(runCircles)){
        runCircles.forEach(c => { try{ if(c && c.remove) c.remove(); }catch(e){} });
      }
    }catch(e){ console.warn('marker/circle cleanup', e); }

    // Optional: remove meMarker from the map
    try{
      if(window.runtime && runtime.active && runtime.active.meMarker){
        try{ runtime.active.meMarker.remove(); }catch(e){} 
      }
    }catch(e){}

    // UI: hide ongoing panel and show home
    try{
      const ongoing = document.getElementById('ongoingPanel') || document.getElementById('ongoingTripPanel');
      const home = document.getElementById('pageHome') || document.getElementById('homePanel');
      if(ongoing) ongoing.classList.add('hidden');
      if(home) home.classList.remove('hidden');
      // show start panel again
      const startPanel = document.getElementById('startPanel');
      if(startPanel) startPanel.classList.remove('hidden');
    }catch(e){ console.warn('UI cleanup', e); }

    // Final logs and toast
    
    // --- Extra UI Reset after trip end ---
    setTimeout(() => {
      try {
        const panels = ['ongoingTripPanel','ongoingMap','tripStats','nextStopPanel'];
        panels.forEach(id => {
          const el = document.getElementById(id);
          if(el) el.classList.add('hidden');
        });
        const home = document.getElementById('homePanel');
        const start = document.getElementById('startPanel');
        if(home) home.classList.remove('hidden');
        if(start) start.classList.remove('hidden');
        console.log('‚úÖ UI fully reset to Start Trip view');
      } catch(e){ console.error('UI reset error', e); }
    }, 500);

    // --- Return to Start Panel after end trip ---
    setTimeout(() => {
      try {
        const start = document.getElementById('startPanel');
        if(start){ start.classList.remove('hidden'); start.style.display = 'block'; }
        document.querySelectorAll('#ongoingTripPanel, #ongoingMap, .trip-live-section')
          .forEach(s => { s.classList.add('hidden'); s.style.display = 'none'; });
        console.log('‚úÖ Returned to Start Panel after trip end');
      } catch(e){ console.error('Return to Start Panel failed', e); }
    }, 300);
console.log('‚úÖ Trip fully ended (cleanup complete)');
    if(typeof toast === 'function') toast('Trip ended successfully');
  } catch(e){
    console.error('endTrip fatal error', e);
    if(typeof toast === 'function') toast('End Trip failed');
  }
};
</script>
<script>
// --- UI FIX: Hide ongoing trip layout before trip start ---
document.addEventListener('DOMContentLoaded', () => {
  try {
    const ongoing = document.getElementById('ongoingTripPanel');
    if(ongoing) ongoing.classList.add('hidden');
    const map = document.getElementById('ongoingMap');
    if(map) map.classList.add('hidden');
    console.log('‚úÖ Ongoing trip layout hidden until trip start');
  } catch(e) {
    console.error('UI preload hide failed', e);
  }
});
</script>
<script>
// --- SAFETY PATCH: manualAnn fallback to prevent ReferenceError ---
if(typeof window.manualAnn === 'undefined'){
  window.manualAnn = {
    play: ()=>{ console.log('manualAnn.play() ignored (feature removed)'); },
    stop: ()=>{ console.log('manualAnn.stop() ignored (feature removed)'); }
  };
  console.log('‚úÖ manualAnn fallback applied');
}
</script>
<script>

async function showCompanyLogo() {
try {
const logoBox = document.getElementById('logoBox');
if (!logoBox) return;


// Ensure there is an <img> inside logoBox for logo display
let logoImg = document.getElementById('companyLogo');
if (!logoImg) {
logoImg = document.createElement('img');
logoImg.id = 'companyLogo';
logoImg.className = 'h-10 w-auto mx-auto my-2 block rounded-lg';
logoBox.innerHTML = ''; // Clear text like 'BM'
logoBox.appendChild(logoImg);
}


const s = getSessionLocally();
if (!s || !s.company_id) {
console.warn('‚ö†Ô∏è No active session or company ID found');
logoImg.style.display = 'none';
return;
}


// Fetch logo for the logged-in user's company
const { data, error } = await SB
.from('companies')
.select('logo')
.eq('id', s.company_id)
.single();


if (error) {
console.error('‚ùå Error fetching company logo:', error);
logoImg.style.display = 'none';
return;
}


if (data && data.logo) {
logoImg.src = data.logo;
logoImg.alt = 'Company Logo';
logoImg.style.display = 'block';
console.log('‚úÖ Company logo loaded:', data.logo);
} else {
console.warn('‚ö†Ô∏è Company logo not found for company:', s.company_id);
logoImg.style.display = 'none';
}
} catch (e) {
console.error('showCompanyLogo exception:', e);
}
}


// Run after login completes
if (typeof handleLogin === 'function') {
const oldHandleLogin = handleLogin;
window.handleLogin = async function(...args) {
const result = await oldHandleLogin.apply(this, args);
setTimeout(showCompanyLogo, 600);
return result;
};
}


// Also run after DOM load (in case session already exists)
document.addEventListener('DOMContentLoaded', () => {
const s = getSessionLocally();
if (s && s.company_id) {
showCompanyLogo();
}
});
</script>
<script>
// --- Supabase Company Logo Loader (companies.logo) ---
async function showCompanyLogo() {
  try {
    const logoEl = document.getElementById('companyLogo') || (() => {
      const img = document.createElement('img');
      img.id = 'companyLogo';
      img.className = 'h-10 w-auto mx-auto my-2 block rounded-lg';
      document.body.prepend(img);
      return img;
    })();

    let logoUrl = null;

    // 1Ô∏è‚É£ Try from runtime or user context
    if (window.runtime?.company?.logo) logoUrl = window.runtime.company.logo;
    else if (window.user?.company?.logo) logoUrl = window.user.company.logo;

    // 2Ô∏è‚É£ Fetch from Supabase if not available
    if (!logoUrl && window.supabase) {
      console.log('üîç Fetching company logo from Supabase (companies table)...');
      let companyId = null;

      // Attempt to get company ID from runtime or user object
      if (window.runtime?.company?.id) companyId = window.runtime.company.id;
      else if (window.user?.company_id) companyId = window.user.company_id;

      let query = supabase.from('companies').select('logo').limit(1);
      if (companyId) query = query.eq('id', companyId);
      const { data, error } = await query.single();

      if (!error && data?.logo) {
        logoUrl = data.logo;
      } else {
        console.warn('‚ö†Ô∏è Could not fetch logo from Supabase:', error);
      }
    }

    // 3Ô∏è‚É£ Apply logo to UI
    if (logoUrl) {
      logoEl.src = logoUrl;
      logoEl.style.display = 'block';
      const initials = document.querySelector('#companyInitials, .companyInitials');
      if (initials) initials.style.display = 'none';
      console.log('‚úÖ Company logo applied:', logoUrl);
    } else {
      logoEl.style.display = 'none';
      console.warn('‚ö†Ô∏è No company logo found');
    }
  } catch (e) {
    console.error('showCompanyLogo error', e);
  }
}

// 4Ô∏è‚É£ Run after login success
if (typeof handleLogin === 'function') {
  const oldLogin = handleLogin;
  window.handleLogin = async function(...args) {
    const res = await oldLogin.apply(this, args);
    setTimeout(showCompanyLogo, 1000);
    return res;
  };
} else {
  document.addEventListener('DOMContentLoaded', showCompanyLogo);
}
</script>
<script>
// --- UI FIX: Show only Start Panel before trip start ---
document.addEventListener('DOMContentLoaded', () => {
  try {
    const sections = document.querySelectorAll('#ongoingTripPanel, #ongoingMap, .trip-live-section');
    sections.forEach(s => { s.classList.add('hidden'); s.style.display = 'none'; });
    const start = document.getElementById('startPanel');
    if(start){ start.classList.remove('hidden'); start.style.display = 'block'; }
    console.log('‚úÖ Showing only startPanel before trip start');
  } catch(e) { console.error('UI preload hide failed', e); }
});
</script>

<script>
async function clearAllCaches(btn){
  try {
    if(btn){ btn.disabled = true; btn.textContent = 'Clearing...'; }

    // Clear local/session storage
    localStorage.clear();
    sessionStorage.clear();

    // Attempt IndexedDB clear
    if (window.indexedDB) {
      try {
        const dbs = await indexedDB.databases();
        if (dbs.length > 0) {
          await Promise.all(dbs.map(db => indexedDB.deleteDatabase(db.name)));
          console.log('üóëÔ∏è IndexedDB cleared:', dbs.map(d => d.name));
        }
      } catch (err) {
        console.warn('IndexedDB clear not supported in this mode:', err);
      }
    }

    // Attempt cookie clear (browser-safe)
    document.cookie.split(";").forEach(function(c) {
      document.cookie = c.replace(/^ +/, "")
                         .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });

    // Reset memory
    CURRENT_SESSION = null;

    // Wait to ensure everything cleared before reload
    setTimeout(() => {
      alert('‚úÖ Cache, cookies, and local data cleared. Reloading fresh...');
      location.href = location.href.split('?')[0];
    }, 500);

    if(btn){ btn.disabled = false; btn.textContent = 'Clear Cache'; }
  } catch (e) {
    console.error('Cache clear failed:', e);
    alert('‚ö†Ô∏è Failed to clear some cache. Try manual browser clear.');
    if(btn){ btn.disabled = false; btn.textContent = 'Clear Cache'; }
  }
}
</script>



<section id="pageFuelRequest" class="hidden p-4">
  <div class="max-w-3xl mx-auto bg-white rounded-xl shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-semibold">Fuel Request Form</h2>
      <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button>
    </div>

    <form id="fuelForm" class="grid gap-4 sm:grid-cols-2">
      <div class="col-span-full">
        <h3 class="text-lg font-semibold mb-2 text-gray-700">Vehicle & Vendor</h3>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Vehicle</label>
        <select id="vehicleSelect" class="w-full p-2 border rounded" required></select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Fuel Type</label>
        <select id="fuelTypeSelect" class="w-full p-2 border rounded" required>
          <option value="">Select Fuel Type</option>
          <option>Diesel</option>
          <option>AdBlue</option>
          <option>Other</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Vendor</label>
        <select id="vendorSelect" class="w-full p-2 border rounded" required></select>
      </div>

      <div class="col-span-full">
        <h3 class="text-lg font-semibold mb-2 text-gray-700">Fuel Details</h3>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Rate per Litre/Unit</label>
        <input id="rateInput" type="number" step="0.01" class="w-full p-2 border rounded" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Consumption Unit</label>
        <input id="consumptionInput" type="number" step="0.01" class="w-full p-2 border rounded" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Total</label>
        <input id="totalInput" type="number" step="0.01" readonly class="w-full p-2 border rounded bg-gray-100">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Current Kilometre from Odometer</label>
        <input id="odometerInput" type="number" class="w-full p-2 border rounded" required>
      </div>
      <div class="col-span-full">
        <label class="block text-sm font-medium text-gray-700 mb-1">Remark</label>
        <textarea id="remarkInput" class="w-full p-2 border rounded" rows="3"></textarea>
      </div>
      <div class="col-span-full">
        <label class="block text-sm font-medium text-gray-700 mb-1">Photo Attachment</label>
        <input id="photoInput" type="file" accept="image/*" class="block w-full border p-2 rounded">
      </div>

      <div class="col-span-full flex justify-end mt-4">
        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full sm:w-auto">
          Submit Fuel Request
        </button>
      </div>
    </form>
  </div>
</section>



 <!-- Edit Fuel Request Modal -->
  
<div class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40" id="editFuelModal">
  <div class="bg-white p-4 rounded-xl w-[720px] max-w-full">

    <h3 class="font-semibold">Edit Fuel Request :</h3>

    <input type="hidden" id="editFuelId" />   

    <div class="grid grid-cols-2 gap-3 mt-3">
      <div>
        <label class="block text-sm">Vehicle</label>
        <select id="editVehicleSelect" class="w-full p-2 border rounded"></select>
      </div>

      <div>
        <label class="block text-sm">Fuel Type</label>
        <select id="editFuelTypeSelect" class="w-full p-2 border rounded">
          <option value="">Select Fuel Type</option>
          <option>Diesel</option>
          <option>AdBlue</option>
          <option>Other</option>
        </select>
      </div>

      <div>
        <label class="block text-sm">Vendor</label>
        <select id="editVendorSelect" class="w-full p-2 border rounded"></select>
      </div>

      <div>
        <label class="block text-sm">Rate per Litre/Unit</label>
        <input id="editRateInput" type="number" step="0.01" class="w-full p-2 border rounded">
      </div>

      <div>
        <label class="block text-sm">Consumption Unit</label>
        <input id="editConsumptionInput" type="number" step="0.01" class="w-full p-2 border rounded">
      </div>

      <div>
        <label class="block text-sm">Total</label>
        <input id="editTotalInput" type="number" step="0.01" readonly class="w-full p-2 border rounded bg-gray-100">
      </div>

      <div>
        <label class="block text-sm">Current Kilometre from Odometer</label>
        <input id="editOdometerInput" type="number" class="w-full p-2 border rounded">
      </div>

      <div>
        <label class="block text-sm">Status</label>
        <select id="editStatusSelect" class="w-full p-2 border rounded">
          <option>Pending</option>
          <option>Pending Review</option>
          <option>Approved</option>
          <option>Rejected</option>
        </select>
      </div>

      <div class="col-span-full">
        <label class="block text-sm">Remark</label>
        <textarea id="editRemarkInput" class="w-full p-2 border rounded" rows="3"></textarea>
      </div>

      <div class="col-span-full">
        <label class="block text-sm">Photo (preview / replace / remove)</label>
        <div class="mt-2 flex gap-3 items-start">
          <div id="editPhotoPreview" class="w-36 h-24 bg-slate-100 rounded overflow-hidden flex items-center justify-center text-slate-400">
            No photo
          </div>
          <div class="flex-1">
            <input id="editPhotoInput" type="file" accept="image/*" class="block w-full border p-2 rounded">
            <div class="mt-2 flex gap-2">
              <button id="editRemovePhotoBtn" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" onclick="removeEditPhoto()" type="button">Remove Photo</button>
              <!-- <button id="editClearSelectionBtn" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" type="button" onclick="document.getElementById('editPhotoInput').value='';">Clear Selection</button> -->
            </div>
            <div class="text-xs text-slate-500 mt-2">You can replace the existing photo by choosing a new file.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex gap-2 mt-4 justify-end">
      <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="closeEditFuelModal()">Cancel</button>
      <button id="saveEditFuelBtn" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700" onclick="saveEditFuelRequest()">Save</button>
    </div>
  </div>
</div>

<script>
/* Helper to convert stored base64 (without data:) to data URL for preview
   If your DB already stores data:... prefix, base64ToDataUrl will handle both.
*/
function dataUrlFromBase64(b64) {
  if (!b64) return null;
  const s = String(b64).trim();
  return s.startsWith("data:") ? s : "data:image/jpeg;base64," + s;
}

/* close modal helper */
function closeEditFuelModal(){
  document.getElementById('editFuelModal').classList.add('hidden');
  // clear fields
  document.getElementById('editFuelId').value = '';
  document.getElementById('editPhotoPreview').innerHTML = 'No photo';
  document.getElementById('editPhotoInput').value = '';
  // reset remove flag
  window._editFuel_removePhoto = false;
}

/* open modal & load full request by id (includes photo base64) */
async function openEditFuelRequest(id, fromMyRequests = false){

  try{
    if(!id) return alert('Invalid request id');
    // show modal immediately (spinner could be added)
    document.getElementById('editFuelModal').classList.remove('hidden');
    const s = typeof getSessionLocally === "function" ? getSessionLocally() : null;
    const companyId = s?.company_id || s?.companyid || null;
    
      // loads vendors and vehicles for selects
    const [vendorsRes, vehiclesRes] = await Promise.all([
      SB.from('vendors')
      .select('id,name,company_id')
      .eq('company_id', companyId)
      .order('name', { ascending: true }),

    SB.from('vehicles')
      .select('id,name,company_id')
      .eq('company_id', companyId)
      .order('name', { ascending: true })
    ]);

    const vendors = vendorsRes.data || [];
    const vehicles = vehiclesRes.data || [];

    // populate selects
    const vendorSel = document.getElementById('editVendorSelect');
    const vehicleSel = document.getElementById('editVehicleSelect');
    vendorSel.innerHTML = '<option value="">Select Vendor</option>' + (vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join(''));
    vehicleSel.innerHTML = '<option value="">Select Vehicle</option>' + (vehicles.map(v => `<option value="${v.id}">${v.name}</option>`).join(''));

    // fetch the full fuel request row (including photo)
    const { data, error } = await SB.from('fuel_requests').select('*').eq('id', id).single();
    if(error || !data) {
      console.error('Could not load fuel request:', error);
      alert('Could not load fuel request for editing.');
      closeEditFuelModal();
      return;
    }

    // fill values
    document.getElementById('editFuelId').value = data.id || '';
    document.getElementById('editVehicleSelect').value = data.vehicle_id || '';
    document.getElementById('editFuelTypeSelect').value = data.fuel_type || '';
    document.getElementById('editVendorSelect').value = data.vendor_id || '';
    document.getElementById('editRateInput').value = data.rate_per_unit ?? '';
    document.getElementById('editConsumptionInput').value = data.consumption_unit ?? '';
    document.getElementById('editTotalInput').value = data.total ?? '';
    document.getElementById('editOdometerInput').value = data.odometer ?? '';
    document.getElementById('editRemarkInput').value = data.remark || data.remarks || '';
    document.getElementById('editStatusSelect').value = data.status || 'Pending';
    const statusDropdown = document.getElementById('editStatusSelect');
    if (fromMyRequests) {
      statusDropdown.setAttribute('disabled', 'disabled');
      statusDropdown.classList.add('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
    } else {
      statusDropdown.removeAttribute('disabled');
      statusDropdown.classList.remove('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
    }


    // photo handling: DB uses base64 string under fuel_requests.photo
    window._editFuel_originalPhoto = data.photo || ''; // store original
    window._editFuel_currentPhotoBase64 = data.photo || ''; // current working copy
    window._editFuel_removePhoto = false;

    // preview
    const preview = document.getElementById('editPhotoPreview');
    if(window._editFuel_currentPhotoBase64){
      const src = dataUrlFromBase64(window._editFuel_currentPhotoBase64);
      preview.innerHTML = `<img src="${src}" class="w-full h-full object-cover cursor-zoom-in" onclick="showImageFullscreen('${src}')">`;
    } else {
      preview.innerHTML = 'No photo';
    }

    // wire photo input change -> preview & base64
    const photoInput = document.getElementById('editPhotoInput');
    photoInput.onchange = async (ev) => {
      const file = ev.target.files && ev.target.files[0];
      if(!file) return;
      try {
        const b64 = await toBase64(file); // existing helper in your file
        // toBase64 returns data:... so strip prefix before saving in DB? We keep full data:... or strip depending on your storage.
        // You said DB stores base64 string under fuel_requests.photo ‚Äî keep it consistent:
        // If DB currently stores raw base64 without data:, strip prefix:
        const raw = String(b64).startsWith('data:') ? b64.split(',')[1] : b64;
        window._editFuel_currentPhotoBase64 = raw;
        window._editFuel_removePhoto = false; // ensure not flagged for remove
        const src = dataUrlFromBase64(raw);
        preview.innerHTML = `<img src="${src}" class="w-full h-full object-cover cursor-zoom-in" onclick="showImageFullscreen('${src}')">`;
      } catch(e){
        console.error('Photo read error', e);
        alert('Could not read selected photo');
      }
    };

    // recalc total when rate/consumption change
    const rateEl = document.getElementById('editRateInput');
    const consEl = document.getElementById('editConsumptionInput');
    const totalEl = document.getElementById('editTotalInput');
    function recalcTotal(){ const r = parseFloat(rateEl.value)||0; const c = parseFloat(consEl.value)||0; totalEl.value = (r*c).toFixed(2); }
    rateEl.oninput = recalcTotal;
    consEl.oninput = recalcTotal;

  } catch(err){
    console.error('openEditFuelRequest error', err);
    alert('Error opening edit form: ' + (err.message || err));
    closeEditFuelModal();
  }
}

/* remove photo from preview & mark for deletion */
function removeEditPhoto(){
  // mark for removal on save
  window._editFuel_currentPhotoBase64 = '';
  window._editFuel_removePhoto = true;
  document.getElementById('editPhotoPreview').innerHTML = 'No photo';
  document.getElementById('editPhotoInput').value = '';
}

/* Save edited fuel request */
async function saveEditFuelRequest(){
  try{
    const btn = document.getElementById('saveEditFuelBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    const id = document.getElementById('editFuelId').value;
    if(!id) throw new Error('Missing request id');
    const payload = {
      vehicle_id: document.getElementById('editVehicleSelect').value || null,
      fuel_type: document.getElementById('editFuelTypeSelect').value || null,
      vendor_id: document.getElementById('editVendorSelect').value || null,
      rate_per_unit: (document.getElementById('editRateInput').value || '') === '' ? null : parseFloat(document.getElementById('editRateInput').value),
      consumption_unit: (document.getElementById('editConsumptionInput').value || '') === '' ? null : parseFloat(document.getElementById('editConsumptionInput').value),
      // total: (document.getElementById('editTotalInput').value || '') === '' ? null : parseFloat(document.getElementById('editTotalInput').value),
      odometer: (document.getElementById('editOdometerInput').value || '') === '' ? null : parseFloat(document.getElementById('editOdometerInput').value),
      remark: document.getElementById('editRemarkInput').value || '',
      status: document.getElementById('editStatusSelect').value || 'Pending'
    };

    // photo logic: if remove flag -> set photo to empty string (or null). If replaced -> set new base64.
    if(window._editFuel_removePhoto){
      payload.photo = ''; // remove photo - your DB may prefer null; change to null if needed
    } else if(window._editFuel_currentPhotoBase64){
      // ensure we store raw base64 (without data:) because original said it's stored as base64 string under fuel_requests.photo
      const raw = String(window._editFuel_currentPhotoBase64).startsWith('data:') ? window._editFuel_currentPhotoBase64.split(',')[1] : window._editFuel_currentPhotoBase64;
      payload.photo = raw;
    } else {
      // don't include photo field in update to preserve existing (but we set earlier _editFuel_removePhoto false and current maybe empty)
      // To preserve original, do nothing
    }

    // perform update
    const { data, error } = await SB.from('fuel_requests').update(payload).eq('id', id).select().single();
    if(error){
      console.error('Update error', error);
      throw error;
    }

    // success
    console.log('Request updated');
    closeEditFuelModal();

    // refresh my requests table
    if(typeof loadMyRequests === 'function') loadMyRequests();

  }catch(err){
    console.error('saveEditFuelRequest error', err);
    alert('Failed to save: ' + (err.message || err));
  } finally {
    const btn = document.getElementById('saveEditFuelBtn');
    if(btn){ btn.disabled = false; btn.textContent = 'Save'; }
  }
}
/* -----------------------------
   Edit Request Function
----------------------------- */
/* convenience: make edit button call this - you may replace existing editFuelRequest calls */
async function editFuelRequest_open(id, fromMyRequests = false){
  // wrapper so your existing onclick can call editFuelRequest_open
  await openEditFuelRequest(id, fromMyRequests);
}
</script>

<!-- End of the Section -->

<script>
function getSessionLocally(){
  try {
    const data = localStorage.getItem('bm_session');
    if(data){
      return JSON.parse(data);
    }
  } catch(e){
    console.error('Session load error:', e);
  }
  return null;
}
</script>
<script>
async function loadFuelRequestForm(){
const vehicleSel = document.getElementById('vehicleSelect');
  const vendorSel = document.getElementById('vendorSelect');
  const s = getSessionLocally();

  if(!s || !s.company_id){
    alert('‚ö†Ô∏è Session or company not found. Please log in again.');
    return;
  }

  const companyId = s.company_id;

  try {
    const { data: vehicles, error: vErr } = await SB
      .from('vehicles')
      .select('id, name')
      .eq('company_id', companyId);

    if(vErr){
      console.error('Vehicle fetch error:', vErr);
      vehicleSel.innerHTML = '<option value="">Select Vehicle</option><option>(Error loading vehicles)</option>';
    } else if(!vehicles || vehicles.length === 0){
      vehicleSel.innerHTML = '<option value="">Select Vehicle</option><option>(No vehicles found)</option>';
    } else {
      vehicleSel.innerHTML = '<option value="">Select Vehicle</option>' + 
        vehicles.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
      console.log('‚úÖ Vehicles loaded for company', companyId, vehicles);
    }
  } catch(e){
    console.error('Vehicle fetch exception:', e);
  }

  try {
    const { data: vendors, error: venErr } = await SB
      .from('vendors')
      .select('id, name')
      .eq('company_id', companyId);

    if(venErr){
      console.error('Vendor fetch error:', venErr);
      vendorSel.innerHTML = '<option value="">Select Vendor</option><option>(Error loading vendors)</option>';
    } else if(!vendors || vendors.length === 0){
      vendorSel.innerHTML = '<option value="">Select Vendor</option><option>(No vendors found)</option>';
    } else {
      vendorSel.innerHTML = '<option value="">Select Vendor</option>' + 
        vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
      console.log('‚úÖ Vendors loaded for company', companyId, vendors);
    }
  } catch(e){
    console.error('Vendor fetch exception:', e);
  }

  // Auto total calculation
  const rate = document.getElementById('rateInput');
  const cons = document.getElementById('consumptionInput');
  const total = document.getElementById('totalInput');
  rate.addEventListener('input', ()=> total.value = (rate.value * cons.value || 0).toFixed(2));
  cons.addEventListener('input', ()=> total.value = (rate.value * cons.value || 0).toFixed(2));

  // Submit handler
  document.getElementById('fuelForm').onsubmit = async (e)=>{
    e.preventDefault();
    const s = getSessionLocally();
    const photoFile = document.getElementById('photoInput').files[0];
    let photoBase64 = '';
    if(photoFile){
      photoBase64 = await toBase64(photoFile);
    }

    const record = {
      vehicle_id: vehicleSel.value,
      fuel_type: document.getElementById('fuelTypeSelect').value,
      vendor_id: vendorSel.value,
      rate_per_unit: parseFloat(rate.value),
      consumption_unit: parseFloat(cons.value),
      odometer: parseFloat(document.getElementById('odometerInput').value),
      remark: document.getElementById('remarkInput').value,
      photo: photoBase64,
      status: 'Pending Review',
      latitude: userLat,
      longitude: userLng,
      created_by: s.user.toLowerCase(),
      company_id : s.company_id
    };

    console.log('üßæ Submitting record:', record);

    const { error } = await SB.from('fuel_requests').insert([record]);
    if(error){
      console.error('‚ùå Supabase Insert Error:', error);
      alert('‚ùå Failed to submit fuel request: ' + error.message);
    } else {
      alert('‚úÖ Fuel request submitted successfully!');
      document.getElementById('fuelForm').reset();
    }
  };
}

function toBase64(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = ()=> resolve(reader.result);
    reader.onerror = reject;
  });
}

// Load form when Fuel Request page opens
// document.addEventListener('DOMContentLoaded', ()=>{
//   const fuelPage = document.getElementById('pageFuelRequest');
//   if(fuelPage) loadFuelRequestForm();
// });
</script>


<script>
let userLat = null;
let userLng = null;

async function getUserLocation(){
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        console.log('üìç User location:', userLat, userLng);
      },
      (err) => {
        console.warn('‚ö†Ô∏è Location permission denied or unavailable:', err);
      },
      { enableHighAccuracy: true }
    );
  } else {
    console.warn('‚ö†Ô∏è Geolocation not supported in this browser.');
  }
}

document.addEventListener('DOMContentLoaded', ()=> {
  getUserLocation();
});
</script>



<section id="pageMyRequests" class="hidden p-4">
  <div class="max-w-5xl mx-auto bg-white rounded-xl shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-semibold">My Fuel Requests</h2>
      <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button>
    </div>
    <div id="myRequestsContainer" class="overflow-x-auto">
      <table class="w-full text-sm border-collapse border border-gray-200">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <tr class="bg-slate-100 text-left">
            <th class="px-3 py-2 border">#</th>
            <th class="px-3 py-2 border">Request No.</th>
            <th class="px-3 py-2 border">Date</th>
            <th class="px-3 py-2 border">Vehicle</th>
            <th class="px-3 py-2 border">Kilometre</th>
            <th class="px-3 py-2 border">Type</th>
            <th class="px-3 py-2 border">Vendor</th>
            <th class="px-3 py-2 border">Status</th>
            <th class="px-3 py-2 border">Remarks</th>
            <th class="px-3 py-2 border text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="myRequestsTable"></tbody>
      </table>
    </div>
  </div>
</section>

<script>
async function loadMyRequests(){
  /* -----------------------------
   Load My Fuel Requests
----------------------------- */

const s = typeof getSessionLocally === "function" ? getSessionLocally() : null;
  if (!s) return alert("Please log in first");

  const loginUser = (s.display_name || s.user || s.email || "").trim().toLowerCase();

  const page = document.getElementById("pageMyRequests");
  if (!page) return console.warn("pageMyRequests not found");

  // ---- PAGE STRUCTURE ----
  page.innerHTML = `
    <div class="page-back mb-3">
      <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button>
    </div>
    <h2 class="text-lg font-semibold mb-3">My Fuel Requests</h2>
    <div class="bg-white rounded-xl shadow p-4 overflow-x-auto">
      <table class="min-w-full text-sm border-collapse">
        <thead>
          <tr class="bg-slate-100 text-left">
            <th class="px-3 py-2 border">#</th>
            <th class="px-3 py-2 border">Request No.</th>
            <th class="px-3 py-2 border">Date</th>
            <th class="px-3 py-2 border">Vehicle</th>
            <th class="px-3 py-2 border">Kilometre</th>
            <th class="px-3 py-2 border">Type</th>
            <th class="px-3 py-2 border">Vendor</th>
            <th class="px-3 py-2 border">Status</th>
            <th class="px-3 py-2 border">Remarks</th>
            <th class="px-3 py-2 border text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="myReqBody">
          <tr><td colspan="10" class="text-center py-3 text-slate-400">Loading‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  `;

  const tbody = document.getElementById("myReqBody");

  try {
    if (!SB) throw new Error("Supabase not initialized");

    // ---- FETCH ONLY NECESSARY FIELDS (NO PHOTOS) ----
  const shortKey = loginUser.charAt(0);
  console.log("üîë Logged in user:", loginUser, "| short key:", shortKey);

    const { data: rawReqs, error } = await SB
      .from("fuel_requests")
      .select(`
        id,
        created_at,
        vehicle_id,
        vendor_id,
        odometer,
        fuel_type,
        status,
        remark,
        created_by,
        company_id
      `)
      .ilike("created_by", `${shortKey}%`)
      .order("created_at", { ascending: false });

    if (error) throw error;

    console.log(`üßæ Loaded ${rawReqs?.length || 0} rows for ${loginUser}`);

    const myReqs = rawReqs || [];

    // ---- LOAD VENDORS & VEHICLES ----
    const [vendorsRes, vehiclesRes] = await Promise.all([
      SB.from("vendors").select("*"),
      SB.from("vehicles").select("*")
    ]);

    const vendors = vendorsRes.data || [];
    const vehicles = vehiclesRes.data || [];

    tbody.innerHTML = "";

    // ---- NO RECORDS ----
    if (myReqs.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="10" class="text-center py-3 text-slate-500">
            No fuel requests found for <b>${loginUser}</b>.
          </td>
        </tr>`;
      return;
    }

    // ---- RENDER TABLE ----
    myReqs.forEach((req, i) => {
      const vendor = vendors.find(v => v.id === req.vendor_id);
      const vehicle = vehicles.find(v => v.id === req.vehicle_id);

      const status = req.status || "‚Äî";
      const remarks = req.remarks || req.remark || "‚Äî";
      const canEdit = ["pending", "pending review"].includes(status.toLowerCase());
      const dateText = req.created_at
        ? new Date(req.created_at).toLocaleDateString()
        : "‚Äî";

      const tr = document.createElement("tr");
      tr.className = "border-b hover:bg-slate-50";

      tr.innerHTML = `
        <td class="px-3 py-2 border text-center">${i + 1}</td>
        <td class="px-3 py-2 border">${req.id}</td>
        <td class="px-3 py-2 border">${dateText}</td>
        <td class="px-3 py-2 border">${vehicle?.name || "‚Äî"}</td>
        <td class="px-3 py-2 border">${req.odometer || "‚Äî"}</td>
        <td class="px-3 py-2 border">${req.fuel_type || "‚Äî"}</td>
        <td class="px-3 py-2 border">${vendor?.name || "‚Äî"}</td>
        <td class="px-3 py-2 border">${status}</td>
        <td class="px-3 py-2 border">${remarks}</td>
        <td class="px-3 py-2 border text-center">
          ${
            canEdit
              ? `<button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded"
                   onclick="editFuelRequest_open('${req.id}', true)">Edit</button>`
              : `<span class="text-slate-400 text-xs">‚Äî</span>`
          }
        </td>
      `;

      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("‚ùå loadMyRequests error:", err);
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-center py-3 text-red-500">
          Error loading requests: ${err.message}
        </td>
      </tr>`;
  }
}





async function editFuelRequest(id){
  const { data, error } = await SB.from('fuel_requests').select('*').eq('id', id).single();
  if(error){ 
    alert('Could not fetch request for editing.'); 
    return; 
  }

  // Fill form fields for editing
  document.getElementById('vehicleSelect').value = data.vehicle_id;
  document.getElementById('fuelTypeSelect').value = data.fuel_type;
  document.getElementById('vendorSelect').value = data.vendor_id;
  document.getElementById('rateInput').value = data.rate_per_unit;
  document.getElementById('consumptionInput').value = data.consumption_unit;
  document.getElementById('totalInput').value = (data.rate_per_unit * data.consumption_unit).toFixed(2);
  document.getElementById('odometerInput').value = data.odometer;
  document.getElementById('remarkInput').value = data.remark;  

  go('pageFuelRequest');
  alert('You can now edit and re-submit this fuel request.');
}
// /* ---------------------------------------------------------
//    Approvals page ‚Äî auto-creates section if missing + handlers
//    Paste after your SB client and DB helpers (db_update/db_select/db_insert)
// --------------------------------------------------------- */

function ensureApprovalsSection() {
  let sec = document.getElementById("pageFuelApprovals");
  if (sec) return sec;
  sec = document.createElement("section");
  sec.id = "pageFuelApprovals";
  sec.className = "hidden";
  document.querySelector("main")?.appendChild(sec);
  return sec;
}

/* Convert base64 string into data URL */
function base64ToDataUrl(b64) {
  if (!b64) return null;
  const s = String(b64).trim();
  return s.startsWith("data:") ? s : "data:image/jpeg;base64," + s;
}

/* Escape unsafe HTML */
function escapeHtml(str) {
  if (str === undefined || str === null) return "";
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

/* Modal image zoom */
function showImageFullscreen(src) {
  const overlay = document.createElement("div");
  overlay.className =
    "fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 cursor-zoom-out";
  overlay.innerHTML = `
    <img src="${src}" class="max-h-[95vh] max-w-[95vw] object-contain rounded-lg shadow-lg" />
  `;
  overlay.onclick = () => overlay.remove();
  document.body.appendChild(overlay);
}

/* Main: Render approvals (only runs once when opening page) */
async function renderFuelApprovals() {
  const s = getSessionLocally();
  if (!s) return alert("Please login first");

  const page = ensureApprovalsSection();
  document.querySelectorAll("main section").forEach((x) => x.classList.add("hidden"));
  page.classList.remove("hidden");


  page.innerHTML = `
  
    <div class="flex justify-between items-center mb-3">
      <div><button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageHome')">‚Üê Back</button></div>
      <div><button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="go('pageAllRequests')">All Request</button></div>
    </div>
    <h2 class="text-lg font-semibold mb-3">Pending Fuel Approvals</h2>
    <div id="approvalList" class="space-y-4"></div>
  `;

  const list = page.querySelector("#approvalList");
  list.innerHTML = `<div class="text-center text-slate-400 py-4">Loading pending requests‚Ä¶</div>`;

  try {
    if (typeof SB === "undefined" || !SB) throw new Error("Supabase client (SB) not available");

    const companyId = s.company_id;
    if (!companyId) {
      list.innerHTML = `<div class="text-center text-slate-500 py-4">No company assigned to this user.</div>`;
      return;
    }

    const { data: rows, error } = await SB.from("fuel_requests")
      .select("*")
      .eq("company_id", companyId)
      .eq("status", "Pending Review")
      .order("created_at", { ascending: false });

    if (error) throw error;
    if (!rows || rows.length === 0) {
      list.innerHTML = `<div class="text-center text-slate-500 py-4">No pending requests found.</div>`;
      return;
    }

    const [vendorsRes, vehiclesRes] = await Promise.all([
      SB.from("vendors").select("*"),
      SB.from("vehicles").select("*"),
    ]);
    const vendors = vendorsRes.data || [];
    const vehicles = vehiclesRes.data || [];

    list.innerHTML = "";

    rows.forEach((req) => {
      const vendor = vendors.find((v) => v.id === req.vendor_id);
      const vehicle = vehicles.find((v) => v.id === req.vehicle_id);
      const createdAt = req.created_at ? new Date(req.created_at).toLocaleString() : "‚Äî";
      const photoSrc = base64ToDataUrl(req.photo_base64 || req.photo || "");
      const photoHtml = photoSrc
        ? `<img src="${photoSrc}" alt="Fuel Photo"
            class="w-full h-64 object-cover rounded-lg border cursor-zoom-in hover:opacity-90 transition"
            onclick="showImageFullscreen('${photoSrc}')"/>`
        : `<div class="text-slate-400 text-center py-12">No photo</div>`;

      const lat = req.latitude || req.lat || req.location_lat;
      const lng = req.longitude || req.lng || req.location_lng;
      const mapLink =
        lat && lng
          ? `<a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank"
               class="text-blue-600 underline text-sm mt-1 inline-block">
               üìç ${lat}, ${lng}
             </a>`
          : "";

      const card = document.createElement("div");
      card.className =
        "bg-white shadow rounded-xl p-4 md:flex md:items-start md:gap-4 hover:shadow-lg transition";
      card.innerHTML = `
        <div class="flex-1">
          <div class="font-semibold text-blue-700 mb-1">Request #${req.id}</div>
          <div class="text-sm text-slate-600 font-bold">Vehicle: ${vehicle?.name || "‚Äî"}</div>
          <div class="text-sm text-slate-600">Fuel Type: ${req.fuel_type || "‚Äî"}</div>
          <div class="text-sm text-slate-600 font-bold">Vendor: ${vendor?.name || "‚Äî"}</div>
          <div class="text-sm text-slate-600 font-bold">Rate: ‚Çπ${req.rate_per_unit || 0}</div>
          <div class="text-sm text-slate-600 font-bold">Consumption: ${req.consumption_unit || 0}</div>
          <div class="text-sm text-slate-600 font-bold">Total: ‚Çπ${req.total || 0}</div>
          <div class="text-sm text-slate-600">Kilometre: ${req.odometer || "‚Äî"}</div>
          <div class="text-sm text-slate-600">Remark: ${req.remark || "‚Äî"}</div>
          ${mapLink}
          <div class="text-xs text-slate-500 mt-2">
            Created by <b>${req.created_by || "‚Äî"}</b> at ${createdAt}
          </div>
          <div class="flex gap-2 mt-3 action-buttons" id="action-${req.id}">
            <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded"
              onclick="approveFuelRequest('${req.id}')">Approve</button>
            <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded"
              onclick="rejectFuelRequest('${req.id}')">Reject</button>
          </div>
        </div>
        <div class="mt-3 md:mt-0 md:w-64">${photoHtml}</div>
      `;
      list.appendChild(card);
    });
  } catch (err) {
    console.error("renderFuelApprovals error:", err);
    list.innerHTML = `<div class="text-red-500 text-center py-3">Error loading approvals: ${err.message}</div>`;
  }

  
}

/* Approve request - inline update (no confirm, no full refresh) */
async function approveFuelRequest(id) {
  const s = getSessionLocally();
  if (!s) return alert("Please login first");

  try {
    const { error } = await SB.from("fuel_requests")
      .update({
        status: "Approved",
        approved_by: s.display_name || s.user,
        approved_at: new Date().toISOString(),
      })
      .eq("id", id);
    if (error) throw error;

    console.log("‚úÖ Request approved successfully:", id);

    const actionDiv = document.getElementById(`action-${id}`);
    if (actionDiv) {
      actionDiv.innerHTML = `<div class='text-green-600 font-semibold'>‚úÖ Request approved successfully: ${id}</div>`;
    }
  } catch (err) {
    console.error("approveFuelRequest error:", err);
    alert("Error approving request: " + err.message);
  }
}

/* Reject request - inline update (still asks reason) */
async function rejectFuelRequest(id) {
  const s = getSessionLocally();
  if (!s) return alert("Please login first");

  const reason = prompt("Enter rejection remark:");
  if (!reason) return;

  try {
    const { data, error: fetchErr } = await SB.from("fuel_requests")
      .select("remark")
      .eq("id", id)
      .single();
    if (fetchErr) throw fetchErr;

    const oldRemark = (data?.remark || "").trim();
    const newRemark =
      (oldRemark ? oldRemark + "\n" : "") +
      `‚ùå Rejected by ${s.display_name || s.user} at ${new Date().toLocaleString()}: ${reason.trim()}`;

    const { error } = await SB.from("fuel_requests")
      .update({
        status: "Rejected",
        remark: newRemark,
        approved_by: s.display_name || s.user,
        approved_at: new Date().toISOString(),
      })
      .eq("id", id);
    if (error) throw error;

    console.log("‚ùå Request rejected successfully:", id);

    const actionDiv = document.getElementById(`action-${id}`);
    if (actionDiv) {
      actionDiv.innerHTML = `<div class='text-red-600 font-semibold'>‚ùå Request rejected successfully: ${id}</div>`;
    }
  } catch (err) {
    console.error("rejectFuelRequest error:", err);
    alert("Error rejecting request: " + err.message);
  }
}

</script>

<!-- All Requests Page Added -->

<section id="pageAllRequests" class="hidden p-4">
  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-semibold">All Fuel Requests Report</h2>
<!-- <div class="flex gap-2">
  <button class="bg-green-600 text-white px-3 py-1 rounded" onclick="exportCSV()">CSV</button>
  <button class="bg-purple-600 text-white px-3 py-1 rounded" onclick="exportExcel()">Excel</button>
  <button class="bg-red-600 text-white px-3 py-1 rounded" onclick="exportPDF()">PDF</button>
  <button class="bg-red-700 text-white px-3 py-1 rounded" onclick="deleteSelected()" title="Delete Selected"><span style="font-size:18px;">üóëÔ∏è</span></button>
</div> -->

      <div class="flex gap-2">
        <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300" onclick="go('pageFuelApprovals')">‚Üê Back</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end mb-4">
      <div>
        <label class="block text-sm text-slate-600">From (Created At)</label>
        <input type="date" id="allFromDate" class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block text-sm text-slate-600">To (Created At)</label>
        <input type="date" id="allToDate" class="w-full p-2 border rounded">
      </div>
      <div class="md:col-span-2 flex gap-2">
        <button id="allSearchBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" onclick="searchAllFuelRequests()">Search</button>
        <button id="allClearBtn" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300" onclick="clearAllFilters()">Clear</button>
        <!-- <button class="bg-red-700 text-white px-3 py-1 rounded" onclick="deleteSelected()" title="Delete Selected"><span style="font-size:18px;">üóëÔ∏è</span></button> -->
      </div>
      <div class="flex gap-2">
  <button class="bg-green-600 text-white px-3 py-1 rounded" onclick="exportCSV()">CSV</button>
  <button class="bg-purple-600 text-white px-3 py-1 rounded" onclick="exportExcel()">Excel</button>
  <button class="bg-red-600 text-white px-3 py-1 rounded" onclick="exportPDF()">PDF</button>
  <button class="bg-red-700 text-white px-3 py-1 rounded" onclick="deleteSelected()" title="Delete Selected"><span style="font-size:18px;">üóëÔ∏è</span></button>
</div>
    <div class="md:col-span-4 mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-end gap-3">
      <div class="text-sm text-slate-700">Total Consumption: <span id="allTotalConsumption" class="font-semibold">0</span></div>
      <div class="text-sm text-slate-700">Grand Total: <span id="allGrandTotal" class="font-semibold">0</span></div>
    </div>
    
    </div>

    <div class="overflow-x-auto">
      <table id="allReqTable" class="min-w-full text-sm border-collapse border border-gray-200">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="px-3 py-2 border"><input type="checkbox" id="allSelectAll" onchange="toggleSelectAll(this)"></th>
            <th class="px-3 py-2 border">Actions</th>
            <th class="px-3 py-2 border">Request ID</th>
            <th class="px-3 py-2 border">Date</th>
            <th class="px-3 py-2 border">Vehicle</th>
            <th class="px-3 py-2 border">Vendor</th>
            <th class="px-3 py-2 border">Fuel Type</th>
            <th class="px-3 py-2 border">Kilometre</th>
            <th class="px-3 py-2 border">Rate</th>
            <th class="px-3 py-2 border">Consumption</th>
            <th class="px-3 py-2 border">Total</th>
            <th class="px-3 py-2 border">Status</th>
            <th class="px-3 py-2 border">Remark</th>
            <th class="px-3 py-2 border">Created By</th>
            <th class="px-3 py-2 border">Created At</th>
            <th class="px-3 py-2 border">Approved By</th>
            <th class="px-3 py-2 border">Approved At</th><th class="px-3 py-2 border">Map</th>
          </tr>
          <tr id="allFilterRow" class="bg-white">
            <th></th>
            <th></th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="id" oninput="applyAllFilters()" placeholder="Search"></th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="created_at" oninput="applyAllFilters()" placeholder="YYYY-MM-DD"></th>
            <th class="px-2 py-1 border">
      <div class="flex items-center gap-1">
        <input readonly class="hidden w-full p-1 border rounded text-sm filter-readonly" data-col="vehicle_name" placeholder="Vehicle" oninput="applyAllFilters()">
        <button class="filter-toggle-btn px-2 py-1 rounded text-sm" onclick="openFilterDropdown('vehicle_name', this)" title="Filter Vehicle">‚ñæ</button>
      </div>
    </th>
            <th class="px-2 py-1 border">
      <div class="flex items-center gap-1">
        <input readonly class="hidden w-full p-1 border rounded text-sm filter-readonly" data-col="vendor_name" placeholder="Vendor" oninput="applyAllFilters()">
        <button class="filter-toggle-btn px-2 py-1 rounded text-sm" onclick="openFilterDropdown('vendor_name', this)" title="Filter Vendor">‚ñæ</button>
      </div>
    </th>
            <th class="px-2 py-1 border">
      <div class="flex items-center gap-1">
        <input readonly class="hidden w-full p-1 border rounded text-sm filter-readonly" data-col="fuel_type" placeholder="Fuel Type" oninput="applyAllFilters()">
        <button class="filter-toggle-btn px-2 py-1 rounded text-sm" onclick="openFilterDropdown('fuel_type', this)" title="Filter Fuel Type">‚ñæ</button>
      </div>
    </th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="odometer" oninput="applyAllFilters()" placeholder="Odo"></th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="rate_per_unit" oninput="applyAllFilters()" placeholder="Rate"></th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="consumption_unit" oninput="applyAllFilters()" placeholder="Consumption"></th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="total" oninput="applyAllFilters()" placeholder="Total"></th>
            <th class="px-2 py-1 border">
      <div class="flex items-center gap-1">
        <input readonly class="hidden w-full p-1 border rounded text-sm filter-readonly" data-col="status" placeholder="Status" oninput="applyAllFilters()">
        <button class="filter-toggle-btn px-2 py-1 rounded text-sm" onclick="openFilterDropdown('status', this)" title="Filter Status">‚ñæ</button>
      </div>
    </th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="remark" oninput="applyAllFilters()" placeholder="Remark"></th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="created_by" oninput="applyAllFilters()" placeholder="User"></th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="created_at" oninput="applyAllFilters()" placeholder="Created At"></th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="approved_by" oninput="applyAllFilters()" placeholder="Approved By"></th>
            <th class="px-2 py-1 border"><input class="w-full p-1 border rounded text-sm" data-col="approved_at" oninput="applyAllFilters()" placeholder="Approved At"></th>
          </tr>
        </thead>
        <tbody id="allReqBody"></tbody>
      </table>
    </div>
  </div>
</section>

<script>
let _allReqData = []; // cached rows

function clearAllFilters(){
  const f = document.getElementById('allFromDate');
  const t = document.getElementById('allToDate');
  if(f) f.value = '';
  if(t) t.value = '';
  document.querySelectorAll('#allFilterRow input[data-col]').forEach(i=>i.value='');
  _allReqData = [];
  document.getElementById('allReqBody').innerHTML = '';
  const selAll = document.getElementById('allSelectAll');
  if(selAll) selAll.checked = false;
}

function toggleSelectAll(chk){
  const checked = !!chk.checked;
  document.querySelectorAll('#allReqBody input[type="checkbox"].rowSelect').forEach(cb=>cb.checked = checked);
}

function applyAllFilters(){
const filters = {};
  document.querySelectorAll('#allFilterRow input[data-col]').forEach(inp=>{
    const v = (inp.value||'').trim().toLowerCase();
    if(v) filters[inp.dataset.col] = v;
  });
  const from = document.getElementById('allFromDate')?.value;
  const to = document.getElementById('allToDate')?.value;

  const rows = (_allReqData || []).filter(r=>{
    if(from){
      const d = r.created_at ? r.created_at.substring(0,10) : '';
      if(d < from) return false;
    }
    if(to){
      const d = r.created_at ? r.created_at.substring(0,10) : '';
      if(d > to) return false;
    }
    for(const col in filters){
      const val = (r[col] !== undefined && r[col] !== null) ? r[col] : '';
      const v = String(val).toLowerCase();
      if(!v.includes(filters[col])) return false;
    }
    return true;
  });
  // compute totals for visible rows
  const totalConsumption = rows.reduce((sum, r) => sum + (Number(r.consumption_unit) || 0), 0);
  const grandTotal = rows.reduce((sum, r) => sum + (Number(r.total) || 0), 0);
  const tcEl = document.getElementById('allTotalConsumption');
  const gtEl = document.getElementById('allGrandTotal');
  if(tcEl) tcEl.textContent = Number(totalConsumption).toFixed(2);
  if(gtEl) gtEl.textContent = Number(grandTotal).toFixed(2);
  renderAllReqRows(rows);
  // ensure select-all is reset
  const selAll = document.getElementById('allSelectAll'); if(selAll) selAll.checked = false;
}

function renderAllReqRows(rows){
  const tbody = document.getElementById('allReqBody');
  tbody.innerHTML = '';
  if(!rows || rows.length===0){
    tbody.innerHTML = '<tr><td colspan="18" class="text-center py-3 text-slate-500">No records found.</td></tr>';
    return;
  }
  rows.forEach((r)=>{
    const tr = document.createElement('tr');
    tr.className = 'border-b hover:bg-slate-50';
    tr.innerHTML = `
      <td class="px-2 py-2 border text-center"><input type="checkbox" class="rowSelect" data-id="${r.id}"></td>
      <td class="px-2 py-2 border text-center"><button class="bg-blue-600 text-white px-2 py-1 rounded text-sm" onclick="editFuelRequest_open('${r.id}', false)">Edit</button></td>
      <td class="px-2 py-2 border">${escapeHtml(r.id)}</td>
      <td class="px-2 py-2 border">${r.created_at ? new Date(r.created_at).toLocaleString() : '‚Äî'}</td>
      <td class="px-2 py-2 border">${escapeHtml(r.vehicle_name||'‚Äî')}</td>
      <td class="px-2 py-2 border">${escapeHtml(r.vendor_name||'‚Äî')}</td>
      <td class="px-2 py-2 border">${escapeHtml(r.fuel_type||'‚Äî')}</td>
      <td class="px-2 py-2 border">${r.odometer ?? '‚Äî'}</td>
      <td class="px-2 py-2 border">${r.rate_per_unit ?? '‚Äî'}</td>
      <td class="px-2 py-2 border">${r.consumption_unit ?? '‚Äî'}</td>
      <td class="px-2 py-2 border">${r.total ?? '‚Äî'}</td>
      <td class="px-2 py-2 border">${escapeHtml(r.status||'‚Äî')}</td>
      <td class="px-2 py-2 border">${escapeHtml(r.remark||r.remarks||'')}</td>
      <td class="px-2 py-2 border">${escapeHtml(r.created_by||'')}</td>
      <td class="px-2 py-2 border">${r.created_at ? new Date(r.created_at).toLocaleString() : '‚Äî'}</td>
      <td class="px-2 py-2 border">${escapeHtml(r.approved_by||'')}</td>
      <td class="px-2 py-2 border">${r.approved_at ? new Date(r.approved_at).toLocaleString() : '‚Äî'}</td>\n      <td class="px-2 py-2 border text-center">${(r.lat && r.lng) ? `<a class='text-blue-600 underline text-sm' href='#' onclick="openMapView('${r.lat}','${r.lng}');return false;">Map</a>` : '‚Äî'}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* Query server for rows (no photo) and prepare cached data, then render */
async function searchAllFuelRequests(){
  const s = typeof getSessionLocally === 'function' ? getSessionLocally() : null;
  if(!s) return alert('Please log in first');
  const companyId = s.company_id || s.companyid || null;

  const from = document.getElementById('allFromDate').value;
  const to = document.getElementById('allToDate').value;

  try{
    document.getElementById('allReqBody').innerHTML = '<tr><td colspan="18" class="text-center py-3 text-slate-400">Loading‚Ä¶</td></tr>';

    // build query: select only the fields we need; exclude photo
    let q = SB.from('fuel_requests')
      .select(`
        id,
        created_at,
        created_by,
        approved_by,
        approved_at,
        vehicle_id,
        vendor_id,
        fuel_type,
        odometer,
        rate_per_unit,
        consumption_unit,
        total,
        status,
        remark,
        company_id
      `)
      .order('created_at', { ascending: false });

    if(companyId) q = q.eq('company_id', companyId);
    if(from) q = q.gte('created_at', from + 'T00:00:00Z');
    if(to) q = q.lte('created_at', to + 'T23:59:59Z');

    const { data: rows, error } = await q;
    if(error) throw error;
    const data = rows || [];

    // load vendor + vehicle names for mapping (limit to company)
    let vendors = [];
    let vehicles = [];
    try {
      const vres = await SB.from('vendors').select('id,name,company_id').eq('company_id', companyId);
      const vhs = await SB.from('vehicles').select('id,name,company_id').eq('company_id', companyId);
      vendors = vres.data || [];
      vehicles = vhs.data || [];
    } catch(e) {
      console.warn('Could not load vendors/vehicles for mapping', e);
    }

    const vendorMap = {};
    vendors.forEach(v => vendorMap[v.id] = v.name);
    const vehicleMap = {};
    vehicles.forEach(v => vehicleMap[v.id] = v.name);

    _allReqData = (data || []).map(r => ({
      ...r,
      vehicle_name: vehicleMap[r.vehicle_id] || '',
      vendor_name: vendorMap[r.vendor_id] || ''
    }));

    renderAllReqRows(_allReqData);
  }catch(err){
    console.error('searchAllFuelRequests error', err);
    document.getElementById('allReqBody').innerHTML = '<tr><td colspan="18" class="text-center py-3 text-red-500">Error loading requests</td></tr>';
  }
}
</script>

<!-- Filter dropdown container (reused) -->
<div id="filterDropdownContainer" class="hidden fixed z-60 bg-white border rounded shadow p-2" style="min-width:160px; max-height:260px; overflow:auto;"></div>
<!-- END All Requests Page -->



<script>
// helper escape
function escapeHtml(str){
  if(str==null) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

// Delete selected - async with feedback
async function deleteSelected() {
  const ids = [...document.querySelectorAll('.rowSelect:checked')].map(cb => cb.dataset.id);
  if (!ids.length) {
    alert("No rows selected");
    return;
  }
  if (!confirm("Are you sure you want to delete " + ids.length + " records?")) {
    return;
  }
  try {
    const { error } = await SB.from("fuel_requests").delete().in("id", ids);
    if (error) {
      console.error("Delete error:", error);
      alert("Delete failed: " + error.message);
      return;
    }
    alert("Deleted successfully");
    // refresh table
    if (typeof searchAllFuelRequests === "function") searchAllFuelRequests();
  } catch (err) {
    console.error("Delete exception:", err);
    alert("Delete exception: " + err.message);
  }
}

// Export CSV
function exportCSV(){
  if(!(_allReqData && _allReqData.length)){ alert('No data to export'); return; }
  const cols = [
    'id','created_at','vehicle_name','vendor_name','fuel_type',
    'odometer','rate_per_unit','consumption_unit','total',
    'status','remark','created_by','approved_by','approved_at'
  ];
  const header = ['Request ID','Created At','Vehicle','Vendor','Fuel Type','Odometer','Rate','Consumption','Total','Status','Remark','Created By','Approved By','Approved At'];
  const rows = _allReqData.map(r=>cols.map(c=>{
    const v = r[c];
    if(v==null) return '';
    if(c.endsWith('_at')) return new Date(v).toLocaleString();
    return String(v);
  }));
  const csv = [header.join(','), ...rows.map(r=>r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const filename = 'fuel_requests_'+(new Date()).toISOString().replace(/[:.-]/g,'')+'.csv';
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
}

// Export Excel using SheetJS
async function exportExcel(){
  if(!(_allReqData && _allReqData.length)){ alert('No data to export'); return; }
  // load SheetJS if not present
  if(typeof XLSX === 'undefined'){
    await loadScript('https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js');
  }
  const cols = [
    {k:'id',h:'Request ID'},
    {k:'created_at',h:'Created At'},
    {k:'vehicle_name',h:'Vehicle'},
    {k:'vendor_name',h:'Vendor'},
    {k:'fuel_type',h:'Fuel Type'},
    {k:'odometer',h:'Odometer'},
    {k:'rate_per_unit',h:'Rate'},
    {k:'consumption_unit',h:'Consumption'},
    {k:'total',h:'Total'},
    {k:'status',h:'Status'},
    {k:'remark',h:'Remark'},
    {k:'created_by',h:'Created By'},
    {k:'approved_by',h:'Approved By'},
    {k:'approved_at',h:'Approved At'}
  ];
  const data = _allReqData.map(r=>{
    const obj = {};
    cols.forEach(c=>{
      if(c.k && c.k.endsWith('_at')){
        obj[c.h] = r[c.k] ? new Date(r[c.k]).toLocaleString() : '';
      } else {
        obj[c.h] = r[c.k] ?? '';
      }
    });
    return obj;
  });
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Fuel Requests');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout], {type:'application/octet-stream'});
  const filename = 'fuel_requests_'+(new Date()).toISOString().replace(/[:.-]/g,'')+'.xlsx';
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
}

// Export PDF using jsPDF + autoTable
async function exportPDF(){
  if(!(_allReqData && _allReqData.length)){ alert('No data to export'); return; }
  if(typeof jsPDF === 'undefined' || typeof jspdf_autotable === 'undefined'){
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js');
  }
  const { jsPDF } = window.jspdf || window;
  const doc = new jsPDF('landscape');
  const cols = [
    {title:'Request ID', dataKey:'id'},
    {title:'Created At', dataKey:'created_at'},
    {title:'Vehicle', dataKey:'vehicle_name'},
    {title:'Vendor', dataKey:'vendor_name'},
    {title:'Fuel Type', dataKey:'fuel_type'},
    {title:'Odometer', dataKey:'odometer'},
    {title:'Rate', dataKey:'rate_per_unit'},
    {title:'Consumption', dataKey:'consumption_unit'},
    {title:'Total', dataKey:'total'},
    {title:'Status', dataKey:'status'},
    {title:'Remark', dataKey:'remark'},
    {title:'Created By', dataKey:'created_by'},
    {title:'Approved By', dataKey:'approved_by'},
    {title:'Approved At', dataKey:'approved_at'}
  ];
  const data = _allReqData.map(r=>{
    const obj={};
    cols.forEach(c=>{
      if(c.dataKey.endsWith('_at')) obj[c.dataKey] = r[c.dataKey] ? new Date(r[c.dataKey]).toLocaleString() : '';
      else obj[c.dataKey] = r[c.dataKey] ?? '';
    });
    return obj;
  });
  doc.autoTable({
    head: [cols.map(c=>c.title)],
    body: data.map(row=>cols.map(c=>row[c.dataKey])),
    styles: { fontSize: 8 },
    startY: 20,
    theme: 'striped'
  });
  const filename = 'fuel_requests_'+(new Date()).toISOString().replace(/[:.-]/g,'')+'.pdf';
  doc.save(filename);
}

// tiny loader helper
function loadScript(src){
  return new Promise((res, rej)=>{
    const s = document.createElement('script');
    s.src = src;
    s.onload = res;
    s.onerror = rej;
    document.head.appendChild(s);
  });
}
</script>


<script>
async function exportPDF() {
  if (!(_allReqData && _allReqData.length)) {
    alert("No data to export");
    return;
  }
  // load jsPDF UMD if needed
  if (typeof window.jspdf === "undefined") {
    await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
  }
  // load autotable plugin
  if (typeof window.jspdf_autotable === "undefined") {
    await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js");
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape" });
  

  const columns = [
    { header: "Request ID", dataKey: "id" },
    { header: "Created At", dataKey: "created_at" },
    { header: "Vehicle", dataKey: "vehicle_name" },
    { header: "Vendor", dataKey: "vendor_name" },
    { header: "Fuel Type", dataKey: "fuel_type" },
    { header: "Odometer", dataKey: "odometer" },
    { header: "Rate", dataKey: "rate_per_unit" },
    { header: "Consumption", dataKey: "consumption_unit" },
    { header: "Total", dataKey: "total" },
    { header: "Status", dataKey: "status" },
    { header: "Remark", dataKey: "remark" },
    { header: "Created By", dataKey: "created_by" },
    { header: "Approved By", dataKey: "approved_by" },
    { header: "Approved At", dataKey: "approved_at" }
  ];

  const rows = _allReqData.map(r => {
    const obj = {};
    columns.forEach(c => {
      const v = r[c.dataKey];
      if (c.dataKey && /at$/.test(c.dataKey)) {
        obj[c.dataKey] = v ? new Date(v).toLocaleString() : "";
      } else {
        obj[c.dataKey] = v ?? "";
      }
    });
    return obj;
  });

  doc.text("Fuel Requests Report", 14, 10);

  // Build table body as array of arrays
  const body = rows.map(row => columns.map(c => String(row[c.dataKey] ?? "")));

  // AutoTable call (plugin attaches to jsPDF)
  doc.autoTable({
    head: [columns.map(c => c.header)],
    body: body,
    startY: 20,
    styles: { fontSize: 8 },
    headStyles: { fillColor: [41, 128, 185] },
    theme: "striped",
    didDrawPage: function (data) {}
  });

  const filename = "fuel_requests_" + new Date().toISOString().replace(/[:.-]/g, "") + ".pdf";
  doc.save(filename);
}
</script>

<script>
function openFilterDropdown(col, btn){
  const container = document.getElementById('filterDropdownContainer');
  if(!container) return;
  const current = _allReqData || [];
  const vals = Array.from(new Set(current.map(r => (r[col]===null||r[col]===undefined)?'':String(r[col])))).filter(v=>v!=='').sort((a,b)=>a.localeCompare(b));
  let html = '<div style="padding:6px;"><div style="font-weight:600;margin-bottom:6px;">Filter: '+col+'</div>';
  html += `<div class="py-1"><a href="#" onclick="clearDropdownFilter('`+col+`');return false;" style="display:block;padding:6px;border-radius:4px;">‚Äî Clear filter ‚Äî</a></div>`;
  vals.forEach(v=>{
    const esc = String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;');
    html += `<div class="py-1"><a href="#" onclick="selectDropdownFilter('`+col+`','`+esc+`');return false;" style="display:block;padding:6px;border-radius:4px;">${esc}</a></div>`;
  });
  html += '</div>';
  container.innerHTML = html;
  const rect = btn.getBoundingClientRect();
  container.style.left = Math.max(8, rect.left)+'px';
  container.style.top = (rect.bottom + window.scrollY + 6) + 'px';
  container.classList.remove('hidden');
  setTimeout(()=>{
    function outside(e){
      if(!container.contains(e.target) && e.target !== btn){
        container.classList.add('hidden');
        window.removeEventListener('click', outside);
      }
    }
    window.addEventListener('click', outside);
  }, 10);
}

function selectDropdownFilter(col, value){
  const inp = document.querySelector(`#allFilterRow input[data-col="${col}"]`);
  if(inp){
    inp.value = value;
    containerHide();
    applyAllFilters();
  }
}
function clearDropdownFilter(col){
  const inp = document.querySelector(`#allFilterRow input[data-col="${col}"]`);
  if(inp){
    inp.value = '';
    containerHide();
    applyAllFilters();
  }
}
function containerHide(){ const c=document.getElementById('filterDropdownContainer'); if(c) c.classList.add('hidden'); }

// Mobile tweaks for buttons
function adjustButtonsForMobile(){
  const wrap = document.querySelector('#pageAllRequests .flex.gap-2');
  if(!wrap) return;
  if(window.innerWidth < 640){
    wrap.querySelectorAll('button').forEach(b=>{
      b.classList.add('px-2','py-1');
      const spanText = b.querySelector('.btn-text');
      if(spanText) spanText.style.display='none';
    });
  } else {
    wrap.querySelectorAll('button').forEach(b=>{
      b.classList.remove('px-2','py-1');
      const spanText = b.querySelector('.btn-text');
      if(spanText) spanText.style.display='inline';
    });
  }
}
window.addEventListener('resize', adjustButtonsForMobile);
window.addEventListener('load', adjustButtonsForMobile);

// Map view helper
function openMapView(lat, lng){
  if(!lat || !lng){ alert('No location available for this request'); return; }
  const url = `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`;
  window.open(url, '_blank');
}

// ensure totals update when renderAllReqRows called (wrap if exists)
if(typeof renderAllReqRows === 'function'){
  const _origRender = renderAllReqRows;
  renderAllReqRows = function(rows){
    _origRender(rows);
    const totalConsumption = (rows||[]).reduce((s,r)=>s+(Number(r.consumption_unit)||0),0);
    const grandTotal = (rows||[]).reduce((s,r)=>s+(Number(r.total)||0),0);
    const tc = document.getElementById('allTotalConsumption');
    const gt = document.getElementById('allGrandTotal');
    if(tc) tc.textContent = Number(totalConsumption).toFixed(2);
    if(gt) gt.textContent = Number(grandTotal).toFixed(2);
  }
}
</script>

</body>
</html>
